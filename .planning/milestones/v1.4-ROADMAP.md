# Milestone v1.4: Hardening

**Status:** SHIPPED 2026-02-02
**Phases:** 27-29
**Total Plans:** 9

## Overview

Fix all security vulnerabilities, bugs, performance issues, and code quality gaps from the comprehensive codebase review before the BAISH pilot launch. The approach is strict: critical security fixes first (unauthenticated endpoints, OAuth gaps, LLM safety), then quality gates and bug fixes (CI pipeline, pre-commit hooks, correctness issues), then performance and polish (N+1 queries, accessibility, visual coverage gaps). Each phase delivers independently verifiable improvements and the ordering prevents regressions -- CI from Phase 28 catches issues introduced in Phase 29.

## Phases

### Phase 27: Critical Security

**Goal**: All endpoints require proper authentication, OAuth flow is secure against CSRF and token theft, and LLM calls are defended against prompt injection with validated outputs
**Depends on**: Nothing (first phase of v1.4; no dependency on deferred Phase 25)
**Requirements**: AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05, AUTH-06, OAUTH-01, OAUTH-02, OAUTH-03, OAUTH-04, LLM-01, LLM-02, LLM-03, LLM-04
**Plans:** 3 plans

Plans:

- [x] 27-01-PLAN.md -- Authentication hardening (requireAuth helper, ownership checks on enrichment endpoints, getCompleteness deprecation, admin.ts CRUD auth, listAll admin gate)
- [x] 27-02-PLAN.md -- OAuth security (PKCE for Tauri mobile, state validation, redirectUri allowlist, Tauri Store persistence, console.log cleanup)
- [x] 27-03-PLAN.md -- LLM safety (XML delimiters for prompt separation, input length limits, Zod runtime validation for tool_use responses in shadow mode)

**Details:**

- Shared requireAuth/requireAnyOrgAdmin helpers gating 9 previously-unprotected endpoints
- PKCE S256 via Web Crypto API with Tauri Store persistence (survives app kill)
- redirectUri server-side allowlist blocking open redirect attacks
- OAuth state parameter validation on deep-link callback (CSRF defense)
- XML structural separation on all 6 LLM prompt entry points
- Shadow-mode Zod validation on all 5 tool_use response parsing points
- Centralized field length limits (chat: 5K, document: 100K, profile context: 50K)

### Phase 28: Quality Gates & Bug Fixes

**Goal**: CI pipeline and pre-commit hooks catch regressions automatically, all known bugs are fixed, and error handling is consistent across the codebase
**Depends on**: Phase 27 (security fixes must land before establishing quality gates that validate them)
**Requirements**: QUAL-01, QUAL-02, QUAL-03, QUAL-04, QUAL-05, QUAL-06, QUAL-07, QUAL-08, QUAL-09, BUG-01, BUG-02, BUG-03, BUG-04
**Plans:** 3 plans

Plans:

- [x] 28-01-PLAN.md -- CI pipeline and developer experience (GitHub Actions workflow, husky + lint-staged, .env.example, dual lockfile cleanup)
- [x] 28-02-PLAN.md -- Bug fixes and data correctness (growth area aggregation, Date.UTC conversion, navigation useEffect wrapping, engagement override expiration, IANA timezone validation)
- [x] 28-03-PLAN.md -- Code quality cleanup (test route removal, dead code, alert-to-toast, structured logging standardization)

**Details:**

- GitHub Actions CI (lint, typecheck, build, test) on every push/PR to main
- Husky pre-commit hook with full typecheck + lint-staged formatting
- .env.example documenting all 15 environment variables
- Growth area aggregation with cross-batch deduplication (frequency-ranked, capped at 10/theme)
- Date.UTC conversion eliminating timezone drift in extracted dates
- useEffect-wrapped navigation in 5 redirect components
- Engagement override real-time expiration in all 3 query handlers
- Structured JSON logging via convex/lib/logging.ts across 13 Convex files

### Phase 29: Performance, Accessibility & Polish

**Goal**: Database queries are efficient at scale, interactive elements are keyboard-accessible with proper ARIA attributes, and v1.3 visual treatment covers all remaining pages
**Depends on**: Phase 28 (CI catches regressions from performance and UI changes)
**Requirements**: PERF-01, PERF-02, PERF-03, PERF-04, A11Y-01, A11Y-02, A11Y-03, A11Y-04, VIS-01, VIS-02
**Plans:** 3 plans

Plans:

- [x] 29-01-PLAN.md -- N+1 query resolution and rate limiting (batch attendance/email/program queries, chained scheduled actions for matching with exponential backoff)
- [x] 29-02-PLAN.md -- Accessibility hardening (password inline validation checklist, OrgCard keyboard nav, drag state non-color indicators, aria-describedby on all data-entry forms)
- [x] 29-03-PLAN.md -- Visual coverage (GradientBg on remaining user-facing pages, font-display heading sweep across 17 files)

**Details:**

- Two-pass batch pattern (Set dedup + Promise.all + Map lookup) for N+1 resolution
- Chained scheduled actions for matching compute with 1-second rate limiting between batches
- Exponential backoff (max 10 retries, up to 60s) for Anthropic API rate limits
- WCAG 2.1 aria-describedby across 14 data-entry form components via React 19 useId()
- Password inline validation checklist mirroring server-side rules
- Keyboard-accessible OrgCard with single tab stop and Enter/Space activation
- GradientBg on all user-facing pages (settings, attendance, org, login)
- font-display (Space Grotesk) on all 35+ page/section headings

## Tech Debt (Tracked for v1.5)

1. OAUTH-03: Access tokens returned to client in Tauri flow (TODO in authTauri.ts:23)
2. Zod validation in shadow mode (graduate to enforcement after testing against real LLM outputs)
3. @ts-nocheck in batchActions.ts (Convex action type inference workaround)
4. CI test step passes vacuously (no test files)
5. 3 matching correctness bugs: empty first batch skips clearing, opportunity list re-queried per batch, no concurrency guard

---

_Archived: 2026-02-02 as part of v1.4 milestone completion_
