---
phase: 03-profiles
plan: 03
type: execute
wave: 2
depends_on: ['03-01']
files_modified:
  - convex/enrichment/conversation.ts
  - convex/enrichment/extraction.ts
  - src/components/profile/wizard/steps/EnrichmentStep.tsx
  - src/components/profile/enrichment/EnrichmentChat.tsx
  - src/components/profile/enrichment/ExtractionReview.tsx
  - src/components/profile/enrichment/hooks/useEnrichment.ts
autonomous: true
user_setup:
  - service: anthropic
    why: 'LLM-powered career coaching conversation'
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: 'Anthropic Console (console.anthropic.com) -> API Keys'

must_haves:
  truths:
    - 'User can have back-and-forth conversation with career coach LLM'
    - 'LLM responses have career coach tone (warm, exploratory)'
    - 'Conversation persists across page refresh'
    - 'LLM extracts structured data from conversation'
    - 'User sees extraction summary with accept/reject/edit controls'
    - 'Accepted extractions populate profile fields'
    - 'User can continue enrichment conversation anytime'
  artifacts:
    - path: 'convex/enrichment/conversation.ts'
      provides: 'Message storage and LLM conversation action'
      exports: ['sendMessage', 'getMessages', 'saveMessage']
    - path: 'convex/enrichment/extraction.ts'
      provides: 'Claude tool use for structured extraction'
      exports: ['extractFromConversation']
    - path: 'src/components/profile/wizard/steps/EnrichmentStep.tsx'
      provides: 'Enrichment conversation wizard step'
      min_lines: 50
    - path: 'src/components/profile/enrichment/ExtractionReview.tsx'
      provides: 'Accept/reject/edit extraction UI'
      min_lines: 40
  key_links:
    - from: 'EnrichmentStep.tsx'
      to: 'EnrichmentChat'
      via: 'component composition'
      pattern: 'EnrichmentChat'
    - from: 'EnrichmentChat.tsx'
      to: 'convex/enrichment/conversation.ts'
      via: 'useAction for sendMessage'
      pattern: 'useAction.*sendMessage'
    - from: 'ExtractionReview.tsx'
      to: 'convex/enrichment/extraction.ts'
      via: 'useAction for extractFromConversation'
      pattern: 'useAction.*extractFromConversation'
    - from: 'ExtractionReview.tsx'
      to: 'convex/profiles.ts'
      via: 'useMutation to apply accepted extractions'
      pattern: 'useMutation.*updateField'
---

<objective>
Implement LLM-powered profile enrichment conversation with structured extraction

Purpose: Enable users to have a career coaching conversation that enriches their profile with deeper context. The LLM extracts structured data (skills, interests, goals) which users can accept, reject, or edit before applying to their profile.

Output:

- Career coach conversation system using Claude Haiku
- Chat UI with message history
- Extraction review with accept/reject/edit controls
- Profile auto-population from accepted extractions
  </objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-profiles/03-CONTEXT.md
@.planning/phases/03-profiles/03-RESEARCH.md
@.planning/phases/03-profiles/03-01-SUMMARY.md

Key decisions from CONTEXT.md:

- Career coach tone (warm, exploratory, not interrogative)
- Auto-extract and fill profile fields from conversation
- Required for 100% profile completeness
- Adaptive length (LLM decides when enough info)
- Show summary at end with accept/reject/edit controls
- Full control over extractions
- Continuable anytime

Technical approach from RESEARCH.md:

- Use Anthropic SDK directly (not Vercel AI SDK)
- Claude tool use for structured extraction
- Store messages in enrichmentMessages table
- Store extractions in enrichmentExtractions table
  </context>

<tasks>

<task type="auto">
  <name>Task 1: LLM conversation action and message persistence</name>
  <files>
    - convex/enrichment/conversation.ts
  </files>
  <action>
Create convex/enrichment/conversation.ts with:

**System prompt constant** (CAREER_COACH_PROMPT):

```
You are a friendly career coach helping someone build their AI safety career profile.

Your tone is:
- Warm and encouraging, like a supportive mentor
- Curious and exploratory ("Tell me more about...")
- Not interrogative or clinical

Your goal is to understand:
1. Their background and how they got interested in AI safety
2. Specific skills and experiences relevant to the field
3. What types of roles or opportunities they're seeking
4. What motivates them about AI safety work

Ask open-ended questions. After 3-8 exchanges, when you feel you have enough context,
say something like "I think I have a good picture of your background now! Let me
summarize what I've learned and we can update your profile."

Current profile context:
{profileContext}
```

**getMessages query**:

- Args: { profileId }
- Return all messages for profile ordered by createdAt
- Used to load conversation history

**saveMessage mutation** (internal):

- Args: { profileId, role, content }
- Insert into enrichmentMessages with createdAt timestamp

**sendMessage action**:

- Args: { profileId, message }
- "use node" runtime (required for Anthropic SDK)
- Load existing messages via internal query
- Load profile for context via internal query
- Save user message via internal mutation
- Build messages array for Claude API
- Call Claude Haiku (claude-haiku-4-5-20250514) with career coach system prompt
- Extract text response
- Save assistant message via internal mutation
- Return { message: assistantMessage, shouldExtract: boolean }
- Set shouldExtract=true if assistant message contains "summarize" or "update your profile"

**Note:** Use internal functions for queries/mutations called from action.
Import Anthropic from "@anthropic-ai/sdk".
</action>
<verify>

1. Run `npx convex dev` - compiles without errors
2. In Convex dashboard, call sendMessage with test profileId and "Hello, I'm interested in AI safety"
3. Verify user message saved to enrichmentMessages
4. Verify assistant response is warm/exploratory
5. Verify assistant message saved to enrichmentMessages
6. Call getMessages - returns both messages in order
   </verify>
   <done>
   Conversation action works. Messages persist to enrichmentMessages table. Claude responds with career coach tone.
   </done>
   </task>

<task type="auto">
  <name>Task 2: EnrichmentStep UI with chat and extraction review</name>
  <files>
    - convex/enrichment/extraction.ts
    - src/components/profile/wizard/steps/EnrichmentStep.tsx
    - src/components/profile/enrichment/EnrichmentChat.tsx
    - src/components/profile/enrichment/ExtractionReview.tsx
    - src/components/profile/enrichment/hooks/useEnrichment.ts
  </files>
  <action>
**Create convex/enrichment/extraction.ts:**

extractFromConversation action:

- Args: { messages: array of {role, content} }
- "use node" runtime
- Use Claude tool use to extract structured data
- Tool: "extract_profile_info" with properties:
  - skills_mentioned (array of strings)
  - career_interests (array of strings)
  - career_goals (string)
  - background_summary (string)
  - seeking (string)
- Force tool use via tool_choice: { type: "tool", name: "extract_profile_info" }
- Return extracted data object

**Create useEnrichment hook:**

- Takes profileId
- Manages chat state (messages from query, input, loading)
- sendMessage function: calls action, updates UI optimistically
- extractProfile function: calls extraction action
- State for extraction results and review mode

**Create EnrichmentChat.tsx:**

- Props: messages, onSendMessage, isLoading, disabled
- Render message list with user/assistant styling
- User messages: right-aligned, coral accent
- Assistant messages: left-aligned, neutral
- Input field with Send button at bottom
- Disable input while loading, show typing indicator
- Scroll to bottom on new messages

**Create ExtractionReview.tsx:**

- Props: extractions (object), onAccept, onReject, onEdit, onApply
- Show each extraction field:
  - skills_mentioned -> Skills section
  - career_interests -> AI Safety Interests
  - career_goals -> Career Goals
  - seeking -> What You're Seeking
- Each field has: value display, Accept/Reject buttons, Edit inline
- "Apply Accepted" button at bottom
- Visual distinction: accepted (green check), rejected (strikethrough), edited (yellow)

**Create EnrichmentStep.tsx (replace placeholder):**

- Fetch profile and messages
- Use useEnrichment hook
- Two modes: conversation and review
- Conversation mode:
  - Show EnrichmentChat
  - When shouldExtract=true from sendMessage, offer "See what I learned" button
- Review mode:
  - Show ExtractionReview
  - On apply: call updateField for each accepted field
  - Update profile.hasEnrichmentConversation = true
  - Show success message, return to conversation or complete
- "Continue enrichment" button visible anytime (continues conversation)
- Show message count and guidance ("Tell me about your background...")

Styling:

- Chat messages with subtle animation on appear
- Typing indicator: three dots with pulse animation
- Extraction cards with clean borders
- Use existing shadcn Button, Input, Card components
  </action>
  <verify>

1. Navigate to Enrichment step in wizard
2. See empty chat with prompt to start
3. Type message, send - see response appear
4. Have 3-5 exchanges about AI safety interests
5. When Claude offers to summarize, click "See what I learned"
6. See extraction review with fields populated
7. Accept some fields, reject others, edit one
8. Click "Apply Accepted" - fields populate profile
9. Profile completeness updates (hasEnrichmentConversation = true)
10. Refresh page - conversation history preserved
11. Can continue conversation after extraction
    </verify>
    <done>
    EnrichmentStep fully functional with career coach conversation and structured extraction. Users can chat, review extractions, and apply to profile. Conversation persists across sessions.
    </done>
    </task>

</tasks>

<verification>
- [ ] sendMessage action calls Claude and saves messages
- [ ] Career coach tone in responses (warm, exploratory)
- [ ] Messages persist to database
- [ ] Chat UI renders messages correctly
- [ ] Extraction action returns structured data
- [ ] ExtractionReview shows all extraction fields
- [ ] Can accept/reject/edit individual fields
- [ ] Apply populates corresponding profile fields
- [ ] hasEnrichmentConversation set to true after apply
- [ ] Can continue conversation after extraction
</verification>

<success_criteria>

1. User can have natural conversation with career coach LLM
2. Conversation history persists across refresh
3. LLM signals when ready to extract
4. User reviews extractions with full control
5. Accepted extractions populate profile fields
6. Profile completeness tracks enrichment completion
7. User can continue enrichment conversation anytime
   </success_criteria>

<output>
After completion, create `.planning/phases/03-profiles/03-03-SUMMARY.md`
</output>
