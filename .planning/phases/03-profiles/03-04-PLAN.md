---
phase: 03-profiles
plan: 04
type: execute
wave: 2
depends_on: ['03-01']
files_modified:
  - convex/organizations.ts
  - convex/profiles.ts
  - src/components/profile/wizard/steps/PrivacyStep.tsx
  - src/components/profile/privacy/SectionVisibility.tsx
  - src/components/profile/privacy/OrgSelector.tsx
autonomous: true

must_haves:
  truths:
    - 'User can set default visibility for entire profile'
    - 'User can set visibility per section (basic, education, work, skills, goals)'
    - 'User can hide profile from specific organizations'
    - 'User can search for organizations to hide from'
    - 'User can browse list of organizations'
    - 'Privacy settings persist to profile'
  artifacts:
    - path: 'convex/organizations.ts'
      provides: 'Organization queries for privacy selector'
      exports: ['listOrganizations', 'searchOrganizations']
    - path: 'src/components/profile/wizard/steps/PrivacyStep.tsx'
      provides: 'Privacy controls wizard step'
      min_lines: 50
    - path: 'src/components/profile/privacy/SectionVisibility.tsx'
      provides: 'Per-section visibility dropdown'
      min_lines: 30
    - path: 'src/components/profile/privacy/OrgSelector.tsx'
      provides: 'Organization search and selection'
      min_lines: 50
  key_links:
    - from: 'PrivacyStep.tsx'
      to: 'SectionVisibility'
      via: 'component composition for each section'
      pattern: 'SectionVisibility'
    - from: 'PrivacyStep.tsx'
      to: 'OrgSelector'
      via: 'component for org hiding'
      pattern: 'OrgSelector'
    - from: 'OrgSelector.tsx'
      to: 'convex/organizations.ts'
      via: 'useQuery for organization list'
      pattern: 'useQuery.*listOrganizations|searchOrganizations'
    - from: 'PrivacyStep.tsx'
      to: 'useAutoSave'
      via: 'saving privacySettings to profile'
      pattern: 'saveField.*privacySettings'
---

<objective>
Implement privacy controls with section-level visibility and organization hiding

Purpose: Enable users to control who can see their profile information. Users set default visibility, per-section visibility overrides, and can hide their profile from specific organizations.

Output:

- Organizations table for privacy selection
- Privacy wizard step with visibility controls
- Section-level visibility dropdowns (LinkedIn-style)
- Organization search and selection for hiding
  </objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-profiles/03-CONTEXT.md
@.planning/phases/03-profiles/03-RESEARCH.md
@.planning/phases/03-profiles/03-01-SUMMARY.md

Key decisions from CONTEXT.md:

- Dedicated privacy step in wizard
- Section-level granularity
- Org selection: search + browse hybrid
- Prompt user to choose default visibility during wizard
- LinkedIn-style visibility controls (dropdowns per section)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Organizations table and privacy backend</name>
  <files>
    - convex/organizations.ts
    - convex/schema.ts
  </files>
  <action>
**Update convex/schema.ts:**
Add organizations table (minimal for privacy selection, will be extended in Phase 5):
- name: string
- slug: optional string (for URL-friendly identifier)
- logoUrl: optional string
- Index: by_name
- searchIndex: search_name on name

**Create convex/organizations.ts:**

seedOrganizations mutation (internal):

- Insert common AI safety organizations if table empty:
  - Anthropic
  - OpenAI
  - DeepMind
  - Redwood Research
  - MIRI (Machine Intelligence Research Institute)
  - Center for AI Safety
  - AI Safety Camp
  - BERI (Berkeley Existential Risk Initiative)
  - 80,000 Hours
  - Open Philanthropy
  - Alignment Forum
  - Conjecture
  - ARC (Alignment Research Center)
  - EleutherAI
  - FAR AI
  - CHAI (Center for Human-Compatible AI)
  - Apollo Research
  - Model Evaluation and Threat Research (METR)

listOrganizations query:

- Return all organizations ordered by name
- Used for browse mode

searchOrganizations query:

- Args: { query: string }
- Search organizations by name using searchIndex
- Return matching orgs

ensureOrganizationsSeeded action:

- Check if organizations table empty
- If empty, call seedOrganizations
- Called on first access to org selector

**Update convex/profiles.ts:**
Add updatePrivacySettings mutation:

- Args: { profileId, privacySettings object }
- Validates visibility values (public, connections, private)
- Updates profile.privacySettings
  </action>
  <verify>

1. Run `npx convex dev` - compiles without errors
2. Call ensureOrganizationsSeeded - populates table
3. Call listOrganizations - returns ~15+ orgs
4. Call searchOrganizations with "AI" - returns matching orgs
5. Verify organizations table has searchIndex working
   </verify>
   <done>
   Organizations table seeded with AI safety orgs. List and search queries work. Privacy settings update function ready.
   </done>
   </task>

<task type="auto">
  <name>Task 2: PrivacyStep with visibility controls and org hiding</name>
  <files>
    - src/components/profile/wizard/steps/PrivacyStep.tsx
    - src/components/profile/privacy/SectionVisibility.tsx
    - src/components/profile/privacy/OrgSelector.tsx
  </files>
  <action>
**Create SectionVisibility.tsx:**
- Props: section (string), label (string), value (string), onChange, defaultVisibility
- Render section label with dropdown
- Dropdown options:
  - "Use default ({defaultVisibility})" - inherits from default
  - "Public" - anyone can see
  - "Connections only" - only connected users
  - "Private" - only you
- Show current effective visibility as subtle indicator
- LinkedIn-style dropdown using shadcn Select component

**Create OrgSelector.tsx:**

- Props: selectedOrgs (array of org ids), onOrgsChange
- Two modes: search and browse
- Search mode:
  - Input field for searching
  - Results dropdown showing matching orgs
  - Click org to add to hidden list
- Browse mode:
  - "Browse all organizations" toggle/button
  - Scrollable list of all orgs
  - Checkbox to select/deselect
- Selected orgs shown as chips above (similar to skills)
- Can remove org by clicking X on chip
- Fetch orgs via listOrganizations and searchOrganizations
- Trigger ensureOrganizationsSeeded on mount if empty

**Create PrivacyStep.tsx (replace placeholder):**

- Fetch profile via getOrCreateProfile
- Use useAutoSave hook

Structure:

1. **Default Visibility section:**
   - "Who can see your profile by default?"
   - Three radio/card options: Public, Connections, Private
   - Description for each option
   - This sets privacySettings.defaultVisibility

2. **Section Visibility section:**
   - "Customize visibility for each section"
   - Collapsible or always-visible list
   - SectionVisibility for each: basicInfo, education, workHistory, skills, careerGoals
   - Each saves to privacySettings.sectionVisibility[section]

3. **Hidden from Organizations section:**
   - "Hide your profile from specific organizations"
   - Explanatory text: "These organizations won't see you in search results or matches"
   - OrgSelector component
   - Saves to privacySettings.hiddenFromOrgs

Save behavior:

- Each change saves immediately via useAutoSave
- Show subtle "Saved" indicator on change

Navigation:

- This is the final wizard step
- "Complete Profile" button instead of "Next"
- Clicking complete navigates to /profile (view mode)
- Show confetti or success message on completion

Styling:

- Clean card layout for each section
- Subtle borders between sections
- Radio cards for default visibility (highlight selected)
- Use coral accent for selected states
  </action>
  <verify>

1. Navigate to Privacy step in wizard
2. See default visibility options (Public, Connections, Private)
3. Select default visibility - saves immediately
4. See section visibility dropdowns for each section
5. Change section visibility - saves immediately
6. Search for organization - see results
7. Add org to hidden list - appears as chip
8. Remove org from hidden list - chip removed
9. Browse all organizations - see full list
10. Click "Complete Profile" - navigates to /profile
11. Refresh page - all privacy settings persist
12. Profile completeness shows privacy as complete
    </verify>
    <done>
    PrivacyStep fully functional with default visibility, section-level controls, and org hiding. All settings persist. Profile wizard completable.
    </done>
    </task>

</tasks>

<verification>
- [ ] Organizations table seeded with AI safety orgs
- [ ] PrivacyStep no longer shows placeholder
- [ ] Can set default visibility (Public/Connections/Private)
- [ ] Can set per-section visibility overrides
- [ ] Can search for organizations
- [ ] Can browse all organizations
- [ ] Can add orgs to hidden list
- [ ] Can remove orgs from hidden list
- [ ] All privacy settings persist to profile
- [ ] "Complete Profile" button navigates to profile view
- [ ] Profile completeness tracks privacy as complete
</verification>

<success_criteria>

1. User can set default profile visibility
2. User can override visibility per section
3. User can search and select orgs to hide from
4. User can browse full org list
5. All privacy settings persist across refresh
6. Profile wizard has clear completion path
7. Privacy section marked complete in checklist
   </success_criteria>

<output>
After completion, create `.planning/phases/03-profiles/03-04-SUMMARY.md`
</output>
