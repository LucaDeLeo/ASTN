---
phase: 05-engagement-org
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/convex.config.ts
  - convex/schema.ts
  - convex/emails/templates.tsx
  - convex/emails/send.ts
autonomous: true

must_haves:
  truths:
    - "Email infrastructure is configured with Resend component"
    - "Profiles can store notification preferences"
    - "Email templates render branded HTML for match alerts and digests"
  artifacts:
    - path: "convex/convex.config.ts"
      provides: "Resend component registration"
      contains: "app.use(resend)"
    - path: "convex/schema.ts"
      provides: "Notification preferences in profiles"
      contains: "notificationPreferences"
    - path: "convex/emails/templates.tsx"
      provides: "React Email templates"
      exports: ["MatchAlertEmail", "WeeklyDigestEmail"]
    - path: "convex/emails/send.ts"
      provides: "Email sending infrastructure"
      exports: ["resend", "sendMatchAlert", "sendWeeklyDigest"]
  key_links:
    - from: "convex/emails/send.ts"
      to: "convex/emails/templates.tsx"
      via: "import and call renderMatchAlert/renderWeeklyDigest"
      pattern: "render.*Email"
---

<objective>
Set up email notification infrastructure with Resend component, schema for notification preferences, and React Email templates for match alerts and weekly digests.

Purpose: Enable transactional email delivery for user engagement (NOTIF-01, NOTIF-02, NOTIF-03)
Output: Working email infrastructure, branded templates, and schema extensions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-engagement-org/05-CONTEXT.md
@.planning/phases/05-engagement-org/05-RESEARCH.md
@convex/schema.ts
@convex/crons.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure Resend component</name>
  <files>
    - package.json
    - convex/convex.config.ts
  </files>
  <action>
Install required packages:
```bash
bun add @convex-dev/resend resend @react-email/components @react-email/render @react-email/tailwind date-fns-tz
```

Create `convex/convex.config.ts` to register the Resend component:
```typescript
import { defineApp } from "convex/server";
import resend from "@convex-dev/resend/convex.config.js";

const app = defineApp();
app.use(resend);

export default app;
```

Note: The Resend API key should be set in Convex dashboard as `RESEND_API_KEY`. Document this in a comment but don't require it for local dev (testMode will be enabled).
  </action>
  <verify>
`bun run lint` passes, `convex/convex.config.ts` exists with app.use(resend)
  </verify>
  <done>
Resend component is registered in Convex app config, all email packages installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend schema with notification preferences</name>
  <files>convex/schema.ts</files>
  <action>
Add `notificationPreferences` field to the profiles table. Per CONTEXT.md:
- matchAlerts: enabled boolean (only "great" tier triggers alerts)
- weeklyDigest: enabled boolean
- timezone: string (IANA timezone identifier, e.g., "America/New_York")

Add the field as optional (existing profiles won't have it):
```typescript
notificationPreferences: v.optional(
  v.object({
    matchAlerts: v.object({
      enabled: v.boolean(),
    }),
    weeklyDigest: v.object({
      enabled: v.boolean(),
    }),
    timezone: v.string(), // IANA timezone, e.g., "America/New_York"
  })
),
```

Add after `completedSections` field in the profiles table.
  </action>
  <verify>
`bunx convex dev --once` runs without errors, schema deploys successfully
  </verify>
  <done>
Profiles table can store notification preferences with timezone
  </done>
</task>

<task type="auto">
  <name>Task 3: Create React Email templates and send infrastructure</name>
  <files>
    - convex/emails/templates.tsx
    - convex/emails/send.ts
  </files>
  <action>
Create `convex/emails/templates.tsx` with "use node" directive:
- MatchAlertEmail: branded template for new great-fit matches
  - Props: userName, matches array (title, org, tier, explanation, recommendations)
  - Include ASTN logo, coral accent color (#FF6B4A), "View All Matches" CTA button
  - Per CONTEXT.md: include recommendations in the email content
  - Limit to top 5 matches with link to see more
- WeeklyDigestEmail: branded template for weekly summary
  - Props: userName, newMatches count, topOpportunities array, profileNudges array
  - Per CONTEXT.md: include profile improvement suggestions
  - Same branding as match alert

Use @react-email/components: Html, Head, Body, Container, Section, Text, Button, Hr, Img, Preview, Tailwind
Export render functions: renderMatchAlert, renderWeeklyDigest (async functions that return HTML string)

Create `convex/emails/send.ts`:
- Initialize Resend component: `new Resend(components.resend, {})`
- Export sendMatchAlert internal mutation: accepts to, subject, html, calls resend.sendEmail
- Export sendWeeklyDigest internal mutation: same pattern
- Use "notifications@astn.ai" as from address (configure actual domain later)
  </action>
  <verify>
Files exist, TypeScript compiles without errors (`bun run lint`)
  </verify>
  <done>
Two branded email templates ready for rendering, send infrastructure configured
  </done>
</task>

</tasks>

<verification>
1. `bun run lint` passes
2. `bunx convex dev --once` deploys without errors
3. convex/convex.config.ts exists with Resend component
4. convex/schema.ts has notificationPreferences field in profiles
5. convex/emails/templates.tsx exports renderMatchAlert and renderWeeklyDigest
6. convex/emails/send.ts exports resend instance and send mutations
</verification>

<success_criteria>
- Resend component is registered and ready for use
- Profiles schema supports notification preferences with timezone
- Two branded email templates (match alert, weekly digest) are defined
- Email sending infrastructure is set up (will be used by Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/05-engagement-org/05-01-SUMMARY.md`
</output>
