---
phase: 05-engagement-org
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - convex/crons.ts
  - convex/emails/send.ts
autonomous: true

must_haves:
  truths:
    - "Daily cron processes match alerts at appropriate hours for each timezone"
    - "Weekly cron sends digest emails on Sunday evenings"
    - "Only great-tier matches trigger alert emails"
  artifacts:
    - path: "convex/crons.ts"
      provides: "Scheduled email jobs"
      contains: "send-match-alerts"
    - path: "convex/emails/send.ts"
      provides: "Batch processing functions"
      exports: ["processMatchAlertBatch", "processWeeklyDigestBatch"]
  key_links:
    - from: "convex/crons.ts"
      to: "convex/emails/send.ts"
      via: "internal action calls"
      pattern: "internal\\.emails\\.send\\.process"
    - from: "convex/emails/send.ts"
      to: "convex/matching/queries.ts"
      via: "query for new great-tier matches"
      pattern: "ctx\\.runQuery.*matches"
---

<objective>
Implement notification scheduling with timezone-aware batch processing for match alerts and weekly digests.

Purpose: Deliver emails at user-local 8 AM for alerts, Sunday evening for digests (NOTIF-01, NOTIF-02)
Output: Cron jobs and batch processing logic for both notification types
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-engagement-org/05-CONTEXT.md
@.planning/phases/05-engagement-org/05-RESEARCH.md
@convex/crons.ts
@convex/matching/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch processing functions to send.ts</name>
  <files>convex/emails/send.ts</files>
  <action>
Add to `convex/emails/send.ts`:

1. Add internal query `getUsersForMatchAlertBatch`:
   - Args: targetLocalHour (number, typically 8)
   - Query profiles where notificationPreferences.matchAlerts.enabled === true
   - Filter to users whose current local hour matches targetLocalHour
   - Use date-fns-tz to compute local hour from UTC
   - Return array of {userId, email, timezone, profileId}

2. Add internal action `processMatchAlertBatch`:
   - Args: none (runs from cron)
   - Get users for current hour bucket (target hour 8)
   - For each user:
     - Query their new great-tier matches (isNew === true, tier === "great")
     - If matches exist:
       - Get opportunity details for each match
       - Render email using templates.renderMatchAlert
       - Call sendMatchAlert mutation
       - Mark matches as no longer new (isNew = false)
   - Batch in chunks of 10 to avoid timeout
   - Log send count for observability

3. Add internal action `processWeeklyDigestBatch`:
   - Args: none (runs from cron)
   - Get users where weeklyDigest.enabled === true
   - For each user:
     - Count new matches in past week
     - Get top 3 opportunities (by score within great/good tiers)
     - Generate profile nudges (sections not complete, stale enrichment)
     - Render email using templates.renderWeeklyDigest
     - Call sendWeeklyDigest mutation
   - Batch in chunks of 10

Per CONTEXT.md: Only "great" tier matches trigger alerts (not good/exploring).
Use date-fns-tz for timezone conversion, handling DST correctly.
  </action>
  <verify>
TypeScript compiles without errors, functions are properly typed
  </verify>
  <done>
Batch processing functions query users by timezone and send appropriate emails
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cron jobs for scheduled email delivery</name>
  <files>convex/crons.ts</files>
  <action>
Update `convex/crons.ts` to add email cron jobs:

1. Hourly cron for match alerts (to cover all timezones' 8 AM):
```typescript
crons.hourly(
  "send-match-alerts",
  { minuteUTC: 0 },
  internal.emails.send.processMatchAlertBatch
);
```

2. Weekly cron for digest (Sunday evening UTC, which covers Sunday afternoon/evening in Americas):
```typescript
crons.weekly(
  "send-weekly-digest",
  { dayOfWeek: "sunday", hourUTC: 22, minuteUTC: 0 },
  internal.emails.send.processWeeklyDigestBatch
);
```

Keep existing opportunity sync cron (daily at 6 AM UTC).

Import internal.emails.send at top of file.
  </action>
  <verify>
`bunx convex dev --once` deploys crons successfully, logs show cron registration
  </verify>
  <done>
Cron jobs scheduled: hourly match alerts (timezone-aware), weekly digest on Sunday
  </done>
</task>

</tasks>

<verification>
1. `bun run lint` passes
2. `bunx convex dev --once` deploys without errors
3. convex/crons.ts has two new cron jobs (send-match-alerts, send-weekly-digest)
4. convex/emails/send.ts has processMatchAlertBatch and processWeeklyDigestBatch functions
5. Batch functions filter by great tier only for alerts
</verification>

<success_criteria>
- Hourly cron runs to process match alerts for users in each timezone's 8 AM
- Weekly cron runs Sunday evening for digest emails
- Only great-tier matches trigger alert emails per CONTEXT.md
- Batch processing handles users in chunks to avoid timeouts
</success_criteria>

<output>
After completion, create `.planning/phases/05-engagement-org/05-02-SUMMARY.md`
</output>
