---
phase: 05-engagement-org
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/orgs/membership.ts
  - convex/orgs/admin.ts
autonomous: true

must_haves:
  truths:
    - "Org memberships can be stored with roles (admin/member)"
    - "Members can control their directory visibility"
    - "Orgs can have shareable invite links"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Org membership and invite tables"
      contains: "orgMemberships"
    - path: "convex/orgs/membership.ts"
      provides: "Join/leave logic"
      exports: ["joinOrg", "leaveOrg", "setDirectoryVisibility"]
    - path: "convex/orgs/admin.ts"
      provides: "Admin operations"
      exports: ["removeMember", "promoteToAdmin", "createInviteLink"]
  key_links:
    - from: "convex/orgs/membership.ts"
      to: "convex/schema.ts"
      via: "orgMemberships table operations"
      pattern: "ctx\\.db\\.(insert|query).*orgMemberships"
    - from: "convex/orgs/admin.ts"
      to: "convex/orgs/membership.ts"
      via: "reuses membership queries"
      pattern: "import.*membership"
---

<objective>
Create organization membership data model with roles, directory visibility controls, and invite link system.

Purpose: Enable BAISH to manage members and track who belongs to the organization (ORG-01, ORG-02)
Output: Schema tables for memberships and invites, Convex functions for membership operations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-engagement-org/05-CONTEXT.md
@.planning/phases/05-engagement-org/05-RESEARCH.md
@convex/schema.ts
@convex/organizations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with membership and invite tables</name>
  <files>convex/schema.ts</files>
  <action>
Add two new tables to `convex/schema.ts`:

1. `orgMemberships` table:
```typescript
orgMemberships: defineTable({
  userId: v.string(),
  orgId: v.id("organizations"),
  role: v.union(v.literal("admin"), v.literal("member")),
  directoryVisibility: v.union(
    v.literal("visible"),
    v.literal("hidden")
  ),
  joinedAt: v.number(),
  invitedBy: v.optional(v.id("orgMemberships")),
})
  .index("by_user", ["userId"])
  .index("by_org", ["orgId"])
  .index("by_org_role", ["orgId", "role"]),
```

2. `orgInviteLinks` table:
```typescript
orgInviteLinks: defineTable({
  orgId: v.id("organizations"),
  token: v.string(), // Unique invite token (UUID)
  createdBy: v.id("orgMemberships"),
  createdAt: v.number(),
  expiresAt: v.optional(v.number()), // Optional expiration
})
  .index("by_token", ["token"])
  .index("by_org", ["orgId"]),
```

Also add `slug` field to organizations table if not already indexed:
- Add `.index("by_slug", ["slug"])` to organizations table
  </action>
  <verify>
`bunx convex dev --once` deploys without errors
  </verify>
  <done>
Schema has orgMemberships and orgInviteLinks tables with proper indexes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create membership functions</name>
  <files>convex/orgs/membership.ts</files>
  <action>
Create `convex/orgs/membership.ts`:

1. Query `getMembership`:
   - Get current user's membership for a given org
   - Returns membership record or null

2. Query `getUserMemberships`:
   - Get all orgs the current user belongs to
   - Returns array of memberships with org details

3. Mutation `joinOrg`:
   - Args: orgId, inviteToken (optional), directoryVisibility
   - If inviteToken provided, validate it exists and matches orgId
   - Check user not already a member
   - Per CONTEXT.md: First user to join becomes admin, others become members
   - Insert membership record
   - Return membership

4. Mutation `leaveOrg`:
   - Args: orgId
   - Check user is a member
   - If user is last admin, require promoting another member first (error)
   - Delete membership record

5. Mutation `setDirectoryVisibility`:
   - Args: orgId, visibility ("visible" | "hidden")
   - Update user's directoryVisibility for that org

Use `getAuthUserId` from @convex-dev/auth for authentication.
  </action>
  <verify>
`bun run lint` passes, functions compile correctly
  </verify>
  <done>
Users can join orgs, leave orgs, and control their directory visibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin functions</name>
  <files>convex/orgs/admin.ts</files>
  <action>
Create `convex/orgs/admin.ts`:

1. Helper function `requireOrgAdmin`:
   - Check current user is authenticated
   - Check user has admin role for given orgId
   - Return membership or throw error

2. Mutation `removeMember`:
   - Args: orgId, membershipId
   - requireOrgAdmin check
   - Cannot remove yourself (use leaveOrg instead)
   - Delete the membership record

3. Mutation `promoteToAdmin`:
   - Args: orgId, membershipId
   - requireOrgAdmin check
   - Update membership role to "admin"

4. Mutation `demoteToMember`:
   - Args: orgId, membershipId
   - requireOrgAdmin check
   - Cannot demote yourself if you're the last admin
   - Update membership role to "member"

5. Mutation `createInviteLink`:
   - Args: orgId, expiresInDays (optional, number)
   - requireOrgAdmin check
   - Generate token using crypto.randomUUID()
   - Insert invite link record
   - Return the token

6. Query `getInviteLinks`:
   - Args: orgId
   - requireOrgAdmin check
   - Return all active invite links for the org

7. Mutation `revokeInviteLink`:
   - Args: inviteLinkId
   - requireOrgAdmin check
   - Delete the invite link record
  </action>
  <verify>
`bun run lint` passes, admin functions properly check authorization
  </verify>
  <done>
Admins can manage members, promote/demote, and handle invite links
  </done>
</task>

</tasks>

<verification>
1. `bun run lint` passes
2. `bunx convex dev --once` deploys without errors
3. Schema has orgMemberships and orgInviteLinks tables
4. convex/orgs/membership.ts has join/leave/visibility functions
5. convex/orgs/admin.ts has admin-only functions with authorization checks
</verification>

<success_criteria>
- Org membership schema supports roles and directory visibility
- Users can join orgs (first becomes admin)
- Users can leave orgs (with last-admin check)
- Admins can manage members and create invite links
- Directory visibility is member-controlled
</success_criteria>

<output>
After completion, create `.planning/phases/05-engagement-org/05-04-SUMMARY.md`
</output>
