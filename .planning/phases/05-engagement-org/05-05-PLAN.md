---
phase: 05-engagement-org
plan: 05
type: execute
wave: 2
depends_on: ['05-04']
files_modified:
  - convex/orgs/directory.ts
  - src/routes/org/$slug/index.tsx
  - src/routes/org/$slug/join.tsx
  - src/components/org/MemberDirectory.tsx
autonomous: true

must_haves:
  truths:
    - 'Org has a public directory page showing visible members'
    - 'Users can join an org via invite link'
    - 'Directory visibility prompt appears when joining'
  artifacts:
    - path: 'src/routes/org/$slug/index.tsx'
      provides: 'Org directory page'
      min_lines: 40
    - path: 'src/routes/org/$slug/join.tsx'
      provides: 'Join org flow'
      min_lines: 30
    - path: 'convex/orgs/directory.ts'
      provides: 'Directory queries'
      exports: ['getOrgBySlug', 'getVisibleMembers']
  key_links:
    - from: 'src/routes/org/$slug/index.tsx'
      to: 'convex/orgs/directory.ts'
      via: 'useQuery(api.orgs.directory.getVisibleMembers)'
      pattern: 'useQuery.*getVisibleMembers'
    - from: 'src/routes/org/$slug/join.tsx'
      to: 'convex/orgs/membership.ts'
      via: 'useMutation(api.orgs.membership.joinOrg)'
      pattern: 'useMutation.*joinOrg'
---

<objective>
Create org directory page showing visible members and join flow with invite link validation and visibility prompt.

Purpose: Allow users to browse org members and join via shared invite links (ORG-01, ORG-02)
Output: /org/:slug directory page, /org/:slug/join flow with visibility choice
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-engagement-org/05-CONTEXT.md
@convex/orgs/membership.ts
@src/routes/profile/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory queries</name>
  <files>convex/orgs/directory.ts</files>
  <action>
Create `convex/orgs/directory.ts`:

1. Query `getOrgBySlug`:
   - Args: slug (string)
   - Query organizations table by slug index
   - Return org or null

2. Query `getVisibleMembers`:
   - Args: orgId
   - Query orgMemberships where orgId matches and directoryVisibility === "visible"
   - For each membership, fetch the associated profile (name, headline, skills)
   - Return array of {membershipId, userId, role, profile: {name, headline, skills, location}}
   - Sort: admins first, then alphabetically by name

3. Query `validateInviteToken`:
   - Args: token (string)
   - Query orgInviteLinks by token index
   - Check not expired (expiresAt > now if set)
   - Return {valid: boolean, orgId?, orgName?}

4. Query `getMemberCount`:
   - Args: orgId
   - Return count of members in the org
     </action>
     <verify>
     `bun run lint` passes, functions compile correctly
     </verify>
     <done>
     Directory queries return visible members and validate invite tokens
     </done>
     </task>

<task type="auto">
  <name>Task 2: Create org directory and join routes</name>
  <files>
    - src/routes/org/$slug/index.tsx
    - src/routes/org/$slug/join.tsx
    - src/components/org/MemberDirectory.tsx
  </files>
  <action>
Create `src/routes/org/$slug/index.tsx`:
- Route at /org/:slug showing org's public directory
- Use useParams to get slug
- Query org by slug, show 404 if not found
- Show org name, member count, description (if any)
- Render MemberDirectory component
- If current user is member, show "You're a member" badge
- If current user is admin, show link to admin dashboard

Create `src/routes/org/$slug/join.tsx`:

- Route at /org/:slug/join?token=xxx
- Validate invite token from search params
- If invalid/expired, show error message with "Request a new link" suggestion
- If valid, show:
  - Org name and brief description
  - Directory visibility choice (visible/hidden) with clear explanation:
    - "Visible: Your name and profile summary appear in the member directory"
    - "Hidden: You're a member but won't appear in the directory"
  - Per CONTEXT.md: This is a prompt, not defaulted
  - "Join Organization" button
- On join:
  - Call joinOrg mutation with token and visibility choice
  - Redirect to /org/:slug on success
  - Show error toast on failure

Create `src/components/org/MemberDirectory.tsx`:

- Props: orgId
- Query visible members
- Grid of member cards (responsive: 1 col mobile, 2 tablet, 3 desktop)
- Each card shows: name, headline, top 3 skills, location
- Admin badge for admin members
- Click card to view profile (if profile is viewable)
- Empty state: "No visible members yet"

Use AuthHeader for authenticated pages. Style with Tailwind, match app aesthetic.
</action>
<verify>
Routes exist, `bun run dev` shows /org/baish page (create test org via Convex dashboard)
</verify>
<done>
Org directory shows visible members, join flow collects visibility preference
</done>
</task>

</tasks>

<verification>
1. `bun run lint` passes
2. Navigate to /org/baish - shows directory (or 404 if org doesn't exist)
3. Navigate to /org/baish/join?token=xxx - shows join flow or invalid token error
4. Join flow prompts for directory visibility before joining
5. After joining, user appears in directory if they chose "visible"
</verification>

<success_criteria>

- /org/:slug shows member directory for any org
- Only members with directoryVisibility="visible" appear in directory
- /org/:slug/join validates invite token and collects visibility choice
- Directory shows member cards with profile summaries
- Admins are indicated with badge in directory
  </success_criteria>

<output>
After completion, create `.planning/phases/05-engagement-org/05-05-SUMMARY.md`
</output>
