---
phase: 05-engagement-org
plan: 06
type: execute
wave: 2
depends_on: ["05-04"]
files_modified:
  - src/routes/org/$slug/admin/index.tsx
  - src/routes/org/$slug/admin/members.tsx
  - convex/orgs/stats.ts
  - src/components/org/ExportButton.tsx
  - src/components/org/OrgStats.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can view list of all members"
    - "Org admin can view member full profiles"
    - "Org admin can see aggregate stats"
    - "Org admin can export member data"
  artifacts:
    - path: "src/routes/org/$slug/admin/index.tsx"
      provides: "Admin dashboard overview"
      min_lines: 40
    - path: "convex/orgs/stats.ts"
      provides: "Aggregate statistics queries"
      exports: ["getOrgStats"]
    - path: "src/components/org/ExportButton.tsx"
      provides: "CSV/JSON export functionality"
      exports: ["ExportButton"]
  key_links:
    - from: "src/routes/org/$slug/admin/index.tsx"
      to: "convex/orgs/stats.ts"
      via: "useQuery(api.orgs.stats.getOrgStats)"
      pattern: "useQuery.*getOrgStats"
    - from: "src/components/org/ExportButton.tsx"
      to: "convex/orgs/admin.ts"
      via: "useQuery for member data export"
      pattern: "useQuery.*getAllMembers"
---

<objective>
Create org admin dashboard with member management, aggregate statistics, and data export capabilities.

Purpose: Give BAISH admins visibility into their members (ORG-01, ORG-02, ORG-03)
Output: /org/:slug/admin dashboard with stats, member list, and export
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-engagement-org/05-CONTEXT.md
@convex/orgs/admin.ts
@convex/orgs/directory.ts
@src/routes/admin/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats queries and admin member query</name>
  <files>
    - convex/orgs/stats.ts
    - convex/orgs/admin.ts
  </files>
  <action>
Create `convex/orgs/stats.ts`:

1. Query `getOrgStats`:
   - Args: orgId
   - requireOrgAdmin check (from admin.ts)
   - Calculate and return:
     - memberCount: total members
     - adminCount: members with admin role
     - skillsDistribution: top 10 skills with counts (aggregate from member profiles)
     - completenessDistribution: { high: count (>70%), medium: count (40-70%), low: count (<40%) }
     - joinedThisMonth: members who joined in past 30 days
   - Return structured stats object

Add to `convex/orgs/admin.ts`:

2. Query `getAllMembersWithProfiles`:
   - Args: orgId
   - requireOrgAdmin check
   - Get all memberships for org
   - For each, fetch full profile data
   - Per CONTEXT.md: Admins see full profiles (joining means consent)
   - Return array of {membership, profile} objects
   - Used for both member list and export
  </action>
  <verify>
`bun run lint` passes, stats query returns expected shape
  </verify>
  <done>
Stats and full member queries available for admin dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin dashboard routes</name>
  <files>
    - src/routes/org/$slug/admin/index.tsx
    - src/routes/org/$slug/admin/members.tsx
  </files>
  <action>
Create `src/routes/org/$slug/admin/index.tsx`:
- Route at /org/:slug/admin
- Check user is org admin (redirect to /org/:slug if not)
- Dashboard layout with:
  - Org name header with "Admin Dashboard" subtitle
  - Stats cards: member count, admins, new this month
  - Skills distribution chart (horizontal bar chart, top 10)
  - Completeness distribution (pie or donut chart)
  - Quick actions: "View Members", "Create Invite Link", "Export Data"
- Use OrgStats component for visualization

Create `src/routes/org/$slug/admin/members.tsx`:
- Route at /org/:slug/admin/members
- Check user is org admin
- Full member table with columns:
  - Name, Email, Role, Directory Visibility, Joined Date, Profile Completeness
- Row actions:
  - View profile (opens modal or navigates to profile view)
  - Remove member (confirmation dialog)
  - Promote/Demote (if not self)
- Search/filter by name
- ExportButton component above table

Use shadcn/ui: Card, Table, Dialog, Button, Input
Use recharts or simple CSS for charts (keep lightweight)
  </action>
  <verify>
Routes load for org admin, show member data and stats
  </verify>
  <done>
Admin dashboard shows stats overview and member management table
  </done>
</task>

<task type="auto">
  <name>Task 3: Create export and stats visualization components</name>
  <files>
    - src/components/org/ExportButton.tsx
    - src/components/org/OrgStats.tsx
  </files>
  <action>
Create `src/components/org/ExportButton.tsx`:
- Props: orgId
- Dropdown with "Export CSV" and "Export JSON" options
- On click:
  - Fetch all members with profiles using getAllMembersWithProfiles query
  - Transform to export format:
    - CSV: flatten nested objects, arrays to comma-separated strings
    - JSON: keep structure as-is
  - Per CONTEXT.md: Full profile data in export
  - Fields: name, email, location, headline, education (formatted), work history (formatted), skills (comma-separated), career goals, profile completeness %, role, joined date, directory visibility
  - Trigger browser download with appropriate MIME type
  - Filename: "{orgSlug}-members-{date}.csv" or ".json"

Create `src/components/org/OrgStats.tsx`:
- Props: stats object from getOrgStats
- Renders:
  - Skills distribution as horizontal bar chart (simple CSS bars, no heavy library)
  - Completeness distribution as three cards with counts and percentages
- Clean, readable visualization matching app aesthetic
- Handle empty state gracefully

Use native browser download API (no external dependencies).
  </action>
  <verify>
Export downloads valid CSV/JSON files, stats display correctly
  </verify>
  <done>
Admin can export member data in CSV/JSON, stats visualize member distribution
  </done>
</task>

</tasks>

<verification>
1. `bun run lint` passes
2. Navigate to /org/baish/admin as admin - shows dashboard
3. Stats cards display member counts and charts
4. /org/baish/admin/members shows full member table
5. Export CSV downloads file with all member profile data
6. Export JSON downloads structured data file
7. Non-admins redirected away from admin routes
</verification>

<success_criteria>
- Admin dashboard shows aggregate stats (member count, skills distribution, completeness)
- Admin can view full member list with profile details
- Admin can export member data in CSV or JSON format
- Admin can manage members (remove, promote/demote)
- Only org admins can access admin routes
</success_criteria>

<output>
After completion, create `.planning/phases/05-engagement-org/05-06-SUMMARY.md`
</output>
