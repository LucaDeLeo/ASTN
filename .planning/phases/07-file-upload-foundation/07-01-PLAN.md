---
phase: 07-file-upload-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/upload.ts
autonomous: true

must_haves:
  truths:
    - 'Uploaded files can be persisted to Convex storage'
    - 'Upload metadata is saved to database with pending status'
  artifacts:
    - path: 'convex/schema.ts'
      provides: 'uploadedDocuments table definition'
      contains: 'uploadedDocuments: defineTable'
    - path: 'convex/upload.ts'
      provides: 'Upload mutations'
      exports: ['generateUploadUrl', 'saveDocument']
  key_links:
    - from: 'convex/upload.ts'
      to: 'ctx.storage'
      via: 'generateUploadUrl mutation'
      pattern: "ctx\\.storage\\.generateUploadUrl"
    - from: 'convex/upload.ts'
      to: 'ctx.db.insert'
      via: 'saveDocument mutation'
      pattern: "ctx\\.db\\.insert.*uploadedDocuments"
---

<objective>
Build Convex backend infrastructure for file uploads including database schema and mutations.

Purpose: Establish the server-side foundation for storing uploaded documents and their metadata. This enables the frontend to upload files to Convex storage and track upload status.

Output: Schema with uploadedDocuments table, mutations for generating upload URLs and saving document metadata.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-file-upload-foundation/07-RESEARCH.md

Key context from research:

- Convex 3-step upload: generate URL, POST file, save storageId
- Upload URLs expire in 1 hour
- Use ctx.storage.generateUploadUrl() for URL generation
- Store metadata with pending_extraction status (Phase 8 will process)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add uploadedDocuments table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add uploadedDocuments table to the Convex schema with these fields:
- userId: v.string() - owner of the document
- storageId: v.id("_storage") - reference to Convex storage
- fileName: v.string() - original filename
- fileSize: v.number() - size in bytes
- mimeType: v.string() - e.g., "application/pdf"
- status: v.union(v.literal("pending_extraction"), v.literal("extracted"), v.literal("failed"))
- uploadedAt: v.number() - Unix timestamp
- errorMessage: v.optional(v.string()) - for failed status

Add indexes:

- by_user: ["userId"] - for listing user's documents
- by_status: ["status"] - for batch processing in Phase 8

Place the table definition after enrichmentExtractions and before skillsTaxonomy (alphabetically reasonable spot).
</action>
<verify>Run `npx convex dev` - schema should sync without errors</verify>
<done>uploadedDocuments table exists in schema with proper fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create upload mutations</name>
  <files>convex/upload.ts</files>
  <action>
Create new file convex/upload.ts with two mutations:

1. generateUploadUrl mutation:
   - Args: none
   - Handler: verify user is authenticated using auth.getUserId(ctx), throw if not
   - Return: ctx.storage.generateUploadUrl()

2. saveDocument mutation:
   - Args: storageId (v.id("\_storage")), fileName (v.string()), fileSize (v.number()), mimeType (v.string())
   - Handler:
     - Verify auth
     - Insert into uploadedDocuments table with status "pending_extraction"
     - Return the inserted document ID

Import patterns from existing files (see convex/profiles.ts for auth pattern).

DO NOT add "use node" directive - these are regular mutations that only use Convex APIs.
</action>
<verify>
Run `npx convex dev` and check Convex dashboard - both mutations should appear under api.upload
</verify>
<done>generateUploadUrl and saveDocument mutations exist, are auth-protected, and work correctly</done>
</task>

</tasks>

<verification>
- Schema syncs without errors: `npx convex dev` succeeds
- Mutations visible in Convex dashboard under api.upload
- Both mutations require authentication (test by checking auth.getUserId call exists)
</verification>

<success_criteria>

- uploadedDocuments table defined with all required fields and indexes
- generateUploadUrl mutation returns a valid upload URL
- saveDocument mutation creates a document record with pending_extraction status
- All code passes TypeScript compilation
  </success_criteria>

<output>
After completion, create `.planning/phases/07-file-upload-foundation/07-01-SUMMARY.md`
</output>
