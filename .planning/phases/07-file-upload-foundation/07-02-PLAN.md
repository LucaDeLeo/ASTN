---
phase: 07-file-upload-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/profile/upload/utils/uploadWithProgress.ts
  - src/components/profile/upload/hooks/useFileUpload.ts
autonomous: true

must_haves:
  truths:
    - "Upload state transitions are tracked (idle -> selected -> uploading -> success/error)"
    - "Upload progress percentage is reported during file transfer"
    - "Failed uploads can be retried without re-selecting file"
  artifacts:
    - path: "src/components/profile/upload/utils/uploadWithProgress.ts"
      provides: "XHR upload with progress callback"
      exports: ["uploadWithProgress"]
    - path: "src/components/profile/upload/hooks/useFileUpload.ts"
      provides: "Upload state management hook"
      exports: ["useFileUpload"]
  key_links:
    - from: "src/components/profile/upload/hooks/useFileUpload.ts"
      to: "api.upload.generateUploadUrl"
      via: "useMutation import"
      pattern: "useMutation.*api\\.upload\\.generateUploadUrl"
    - from: "src/components/profile/upload/hooks/useFileUpload.ts"
      to: "src/components/profile/upload/utils/uploadWithProgress.ts"
      via: "import"
      pattern: "import.*uploadWithProgress"
---

<objective>
Create the upload hook and utilities for managing file upload state and progress tracking.

Purpose: Provide a clean interface for UI components to manage the upload lifecycle without dealing with XHR details. The hook encapsulates the 3-step Convex upload flow and exposes a simple state machine.

Output: useFileUpload hook with state machine, uploadWithProgress utility function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-file-upload-foundation/07-RESEARCH.md

Key context from research:
- Use XMLHttpRequest for progress events (fetch lacks upload progress)
- Convex upload URL expects raw file body, not FormData
- Response contains { storageId: string }
- Keep file in state after error for retry capability
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create uploadWithProgress utility</name>
  <files>src/components/profile/upload/utils/uploadWithProgress.ts</files>
  <action>
Create utility function that uploads a file to Convex with progress tracking:

```typescript
export async function uploadWithProgress(
  file: File,
  uploadUrl: string,
  onProgress: (percent: number) => void
): Promise<string>
```

Implementation:
- Use XMLHttpRequest (not fetch - fetch lacks upload progress events)
- Set xhr.upload.onprogress to report percentage via onProgress callback
- Set Content-Type header to file.type
- Send file as raw body (NOT FormData)
- On success (status 200-299), parse JSON response and return storageId
- On error, reject with descriptive Error

Edge cases:
- Handle lengthComputable check before calculating percentage
- Report 100% explicitly on load event before resolving
  </action>
  <verify>TypeScript compiles without errors: `bun run lint`</verify>
  <done>uploadWithProgress function exports, takes file/url/callback, returns Promise<string></done>
</task>

<task type="auto">
  <name>Task 2: Create useFileUpload hook</name>
  <files>src/components/profile/upload/hooks/useFileUpload.ts</files>
  <action>
Create custom hook with discriminated union state machine:

State type:
```typescript
type UploadState =
  | { status: "idle" }
  | { status: "selected"; file: File }
  | { status: "uploading"; file: File; progress: number }
  | { status: "success"; file: File; storageId: string; documentId: string }
  | { status: "error"; file: File; error: string };
```

Hook returns:
```typescript
{
  state: UploadState;
  selectFile: (file: File) => void;
  clearFile: () => void;
  upload: () => Promise<void>;
  retry: () => void;
}
```

Implementation:
- Use useState for state management
- selectFile: transition idle/error -> selected
- clearFile: transition any -> idle
- upload: only when status === "selected"
  1. Set status to "uploading" with progress: 0
  2. Call generateUploadUrl mutation
  3. Call uploadWithProgress with progress callback
  4. Call saveDocument mutation with storageId and file metadata
  5. Set status to "success" with storageId and documentId
  6. On any error: set status to "error" with error message, keep file reference
- retry: if status === "error", transition to "selected" (reuse same file)

Use useMutation from convex/react for:
- api.upload.generateUploadUrl
- api.upload.saveDocument

Wrap upload logic in useCallback to prevent recreation on every render.
  </action>
  <verify>TypeScript compiles: `bun run lint`; hook returns expected shape</verify>
  <done>useFileUpload hook exports with proper state machine, integrates Convex mutations and uploadWithProgress</done>
</task>

</tasks>

<verification>
- `bun run lint` passes with no TypeScript errors
- uploadWithProgress function is properly typed and exported
- useFileUpload hook returns all expected functions (selectFile, clearFile, upload, retry)
- Hook uses useMutation from convex/react correctly
</verification>

<success_criteria>
- uploadWithProgress correctly reports progress via callback
- useFileUpload state machine has all 5 states (idle, selected, uploading, success, error)
- Retry functionality preserves file reference from error state
- All Convex mutations are called in correct order (generateUploadUrl -> upload -> saveDocument)
</success_criteria>

<output>
After completion, create `.planning/phases/07-file-upload-foundation/07-02-SUMMARY.md`
</output>
