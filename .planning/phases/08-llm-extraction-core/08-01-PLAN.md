---
phase: 08-llm-extraction-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/extraction/prompts.ts
  - convex/extraction/skills.ts
autonomous: true

must_haves:
  truths:
    - "Extraction result type defines all profile fields (name, email, location, education, workHistory, skills)"
    - "Skills matching maps raw skill strings to ASTN taxonomy"
  artifacts:
    - path: "convex/extraction/prompts.ts"
      provides: "Tool definition and system prompt for extraction"
      exports: ["extractProfileTool", "EXTRACTION_SYSTEM_PROMPT", "ExtractionResult"]
    - path: "convex/extraction/skills.ts"
      provides: "Skill matching utility"
      exports: ["matchSkillsToTaxonomy"]
    - path: "convex/schema.ts"
      provides: "Updated uploadedDocuments with extractedData field"
      contains: "extractedData"
  key_links:
    - from: "convex/extraction/skills.ts"
      to: "SKILLS_TAXONOMY"
      via: "import from convex/skills.ts"
      pattern: "import.*SKILLS_TAXONOMY|skills taxonomy"
---

<objective>
Build extraction foundation: schema for storing results, Claude tool definition for structured output, and skill matching utility.

Purpose: Establish the data structures and utilities that PDF/text extraction actions will use.
Output: Schema updated, prompts module with tool definition, skills matching function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-llm-extraction-core/08-CONTEXT.md
@.planning/phases/08-llm-extraction-core/08-RESEARCH.md
@convex/schema.ts
@convex/skills.ts
@convex/enrichment/extraction.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema with extractedData field</name>
  <files>convex/schema.ts</files>
  <action>
Add extractedData field to uploadedDocuments table to store extraction results.

The field should be optional and contain:
- name: optional string
- email: optional string
- location: optional string
- education: optional array matching profile education schema (institution required, degree/field/startYear/endYear/current optional)
- workHistory: optional array matching profile workHistory schema (organization + title required, startDate/endDate/current/description optional)
- skills: optional array of strings (matched ASTN skill names)
- rawSkills: optional array of strings (original skills mentioned in document before matching)

Also update the status union to include "extracting" for progress tracking:
- status: "pending_extraction" | "extracting" | "extracted" | "failed"

Use v.optional() wrapper around the entire extractedData object so it can be null initially.
  </action>
  <verify>Run `bun run lint` - should pass with no type errors</verify>
  <done>uploadedDocuments table has extractedData field with proper nested schema and status includes "extracting"</done>
</task>

<task type="auto">
  <name>Task 2: Create extraction prompts and tool definition</name>
  <files>convex/extraction/prompts.ts</files>
  <action>
Create new file convex/extraction/prompts.ts with:

1. ExtractionResult TypeScript interface matching the extractedData schema:
```typescript
export interface ExtractionResult {
  name?: string;
  email?: string;
  location?: string;
  education?: Array<{
    institution: string;
    degree?: string;
    field?: string;
    startYear?: number;
    endYear?: number;
    current?: boolean;
  }>;
  workHistory?: Array<{
    organization: string;
    title: string;
    startDate?: string; // YYYY-MM format from LLM
    endDate?: string;   // YYYY-MM format or "present"
    description?: string;
  }>;
  rawSkills?: string[]; // Skills as mentioned in document
}
```

2. extractProfileTool: Anthropic.Tool definition with input_schema matching ExtractionResult.
   - name: "extract_profile_info"
   - description: "Extract structured profile information from a resume/CV document"
   - input_schema: JSON Schema matching ExtractionResult (use "object" as const pattern from existing code)
   - Only name is required in the schema (everything else optional since resumes vary)

3. EXTRACTION_SYSTEM_PROMPT: System prompt for extraction (from RESEARCH.md):
   - Expert at extracting structured profile information
   - Extract: basic info, education history, work history, skills
   - Guidelines: only extract explicit info, infer years when partial, include skill variations
   - Handle multi-column layouts and varying formats

Follow the pattern from convex/enrichment/extraction.ts for the tool definition structure.
  </action>
  <verify>Run `bun run lint` - no TypeScript errors. Import and log the exports to verify they're accessible.</verify>
  <done>prompts.ts exports ExtractionResult type, extractProfileTool, and EXTRACTION_SYSTEM_PROMPT</done>
</task>

<task type="auto">
  <name>Task 3: Create skill matching utility</name>
  <files>convex/extraction/skills.ts</files>
  <action>
Create new file convex/extraction/skills.ts with matchSkillsToTaxonomy function.

The function should:
1. Take rawSkills: string[] (skills mentioned in document)
2. Take taxonomySkills: Array<{ name: string; category: string; aliases?: string[] }>
3. Return matched skill names from taxonomy

Matching logic (in priority order):
1. Exact match (case-insensitive): "Python" matches "Python"
2. Alias match: "ML" matches "Machine Learning" if "ML" is in aliases
3. Fuzzy match using string-similarity-js (already in project): threshold 0.7

Use the stringSimilarity function from "string-similarity-js" (already installed).

Export the SIMILARITY_THRESHOLD constant (0.7) for testing.

```typescript
import { stringSimilarity } from "string-similarity-js";

export const SIMILARITY_THRESHOLD = 0.7;

export function matchSkillsToTaxonomy(
  rawSkills: string[],
  taxonomySkills: Array<{ name: string; category: string; aliases?: string[] }>
): string[] {
  // Implementation
}
```
  </action>
  <verify>Run `bun run lint` - should pass. Manually verify function signature is correct.</verify>
  <done>skills.ts exports matchSkillsToTaxonomy function and SIMILARITY_THRESHOLD constant</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `bun run lint` passes with no errors
2. `bun run dev:convex` starts without schema errors
3. New files exist: convex/extraction/prompts.ts, convex/extraction/skills.ts
4. Schema change visible in Convex dashboard (uploadedDocuments has extractedData field)
</verification>

<success_criteria>
- Schema updated with extractedData field and "extracting" status
- ExtractionResult type matches profile schema for seamless data transfer in Phase 9
- Tool definition follows existing ASTN patterns (forced tool_choice compatible)
- Skill matching ready to integrate with extraction actions
</success_criteria>

<output>
After completion, create `.planning/phases/08-llm-extraction-core/08-01-SUMMARY.md`
</output>
