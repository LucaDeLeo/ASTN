---
phase: 09-review-apply-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/profile/extraction/hooks/useResumeReview.ts
  - src/components/profile/extraction/types.ts
  - src/components/profile/extraction/index.ts
  - convex/profiles.ts
autonomous: true

must_haves:
  truths:
    - 'Review state tracks status (pending/accepted/rejected/edited) for each extracted field'
    - 'Edited values are stored separately from original extracted values'
    - 'Apply mutation converts extraction date strings to profile timestamps'
    - "Apply mutation creates profile if user doesn't have one yet"
  artifacts:
    - path: 'src/components/profile/extraction/hooks/useResumeReview.ts'
      provides: 'State management hook for resume extraction review'
      exports: ['useResumeReview']
    - path: 'src/components/profile/extraction/types.ts'
      provides: 'Type definitions for extraction review'
      exports: ['ResumeReviewItem', 'ResumeReviewStatus', 'ExtractedData']
    - path: 'convex/profiles.ts'
      provides: 'Profile apply mutation'
      exports: ['applyExtractedProfile']
  key_links:
    - from: 'useResumeReview'
      to: 'types.ts'
      via: 'imports ResumeReviewItem type'
      pattern: 'import.*ResumeReviewItem.*from'
    - from: 'applyExtractedProfile'
      to: 'profiles table'
      via: 'db.patch with converted dates'
      pattern: "ctx\\.db\\.patch.*profiles"
---

<objective>
Create foundation for extraction review: state management hook and profile apply mutation

Purpose: Enable tracking accept/reject/edit status per field and applying approved extractions to profile
Output: useResumeReview hook, shared types, applyExtractedProfile mutation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-review-apply-ui/09-CONTEXT.md
@.planning/phases/09-review-apply-ui/09-RESEARCH.md
@convex/schema.ts
@convex/profiles.ts
@convex/extraction/prompts.ts
@src/components/profile/enrichment/hooks/useEnrichment.ts
@src/components/profile/wizard/steps/WorkHistoryStep.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review types and state hook</name>
  <files>
    src/components/profile/extraction/types.ts
    src/components/profile/extraction/hooks/useResumeReview.ts
    src/components/profile/extraction/index.ts
  </files>
  <action>
Create extraction review module with types and state hook.

**types.ts:**

```typescript
// Match ExtractionResult from convex/extraction/prompts.ts
export interface ExtractedData {
  name?: string
  email?: string
  location?: string
  education?: Array<{
    institution: string
    degree?: string
    field?: string
    startYear?: number
    endYear?: number
    current?: boolean
  }>
  workHistory?: Array<{
    organization: string
    title: string
    startDate?: string // YYYY-MM from extraction
    endDate?: string // YYYY-MM or "present"
    current?: boolean
    description?: string
  }>
  skills?: Array<string>
  rawSkills?: Array<string>
}

export type ResumeReviewStatus = 'pending' | 'accepted' | 'rejected' | 'edited'

export interface ResumeReviewItem {
  id: string // Unique key: "name", "location", "education.0", "workHistory.1", etc.
  field: string // Top-level field: "name", "location", "education", "workHistory", "skills"
  index?: number // For array items
  label: string
  value: unknown
  editedValue?: unknown
  status: ResumeReviewStatus
}
```

**useResumeReview.ts:**

- Takes ExtractedData as input
- Returns items array (flat list of reviewable items)
- Provides updateStatus(id, status), updateValue(id, value)
- Provides getAcceptedData() - returns data ready for profile (only accepted/edited items)
- Provides reset()
- Computes acceptedCount, totalFields, hasAcceptedFields

Transform nested education/workHistory arrays into individual reviewable items:

- "education.0" for first education entry
- "workHistory.1" for second work entry
- Skills as single item (array value)

Follow useEnrichment.ts patterns for state management.

**index.ts:**
Export types and hook:

```typescript
export * from './types'
export { useResumeReview } from './hooks/useResumeReview'
```

  </action>
  <verify>
- TypeScript compiles without errors: `npx tsc --noEmit`
- Types match extraction schema from convex/extraction/prompts.ts
- Hook follows React hooks rules (useState, useCallback, useMemo)
  </verify>
  <done>
- types.ts exports ExtractedData, ResumeReviewStatus, ResumeReviewItem
- useResumeReview hook manages field status and edited values
- index.ts exports all public APIs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create applyExtractedProfile mutation</name>
  <files>convex/profiles.ts</files>
  <action>
Add applyExtractedProfile mutation to convex/profiles.ts.

**Mutation args:**

```typescript
{
  extractedData: v.object({
    name: v.optional(v.string()),
    location: v.optional(v.string()),
    education: v.optional(
      v.array(
        v.object({
          institution: v.string(),
          degree: v.optional(v.string()),
          field: v.optional(v.string()),
          startYear: v.optional(v.number()),
          endYear: v.optional(v.number()),
          current: v.optional(v.boolean()),
        }),
      ),
    ),
    workHistory: v.optional(
      v.array(
        v.object({
          organization: v.string(),
          title: v.string(),
          startDate: v.optional(v.string()), // YYYY-MM string from extraction
          endDate: v.optional(v.string()), // YYYY-MM or "present"
          current: v.optional(v.boolean()),
          description: v.optional(v.string()),
        }),
      ),
    ),
    skills: v.optional(v.array(v.string())),
  })
}
```

**Handler logic:**

1. Get userId from auth, throw if not authenticated
2. Get or create profile (like updateNotificationPreferences pattern)
3. Convert work history dates:
   ```typescript
   const convertDateString = (dateStr?: string): number | undefined => {
     if (!dateStr || dateStr.toLowerCase() === 'present') return undefined
     const [year, month] = dateStr.split('-').map(Number)
     if (isNaN(year) || isNaN(month)) return undefined
     return new Date(year, month - 1, 1).getTime()
   }
   ```
4. Build updates object with only provided fields
5. Convert workHistory dates before applying
6. Patch profile with updates + updatedAt
7. Return { success: true, profileId }

Do NOT include email in updates (not in profile schema, just for display).
Education maps directly (no date conversion needed - uses year numbers).
</action>
<verify>

- Convex dev server compiles mutation: `bun run dev:convex` shows no errors
- Args validator matches expected extraction data shape
- Date conversion handles "present", empty string, valid YYYY-MM
  </verify>
  <done>
- applyExtractedProfile mutation added to convex/profiles.ts
- Creates profile if doesn't exist
- Converts extraction date strings to timestamps for workHistory
- Returns profileId for downstream use
  </done>
  </task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Convex compiles: `bun run dev:convex` shows no type errors
3. New exports available in src/components/profile/extraction/index.ts
</verification>

<success_criteria>

- useResumeReview hook transforms ExtractedData into reviewable items
- Hook tracks status and edited values per field
- applyExtractedProfile mutation handles date conversion
- Mutation creates profile if needed before applying
- All code compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/09-review-apply-ui/09-01-SUMMARY.md`
</output>
