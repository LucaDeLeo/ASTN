---
phase: 09-review-apply-ui
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/routes/test-upload.tsx
autonomous: false

must_haves:
  truths:
    - "User sees review UI when extraction succeeds"
    - "User can edit fields, accept, reject, then apply to profile"
    - "Confirmed extracted data appears in user's profile after apply"
    - "User is redirected to enrichment step after successful apply"
  artifacts:
    - path: "src/routes/test-upload.tsx"
      provides: "Complete upload -> extract -> review -> apply flow"
      contains: "<ResumeExtractionReview"
  key_links:
    - from: "test-upload.tsx"
      to: "ResumeExtractionReview"
      via: "renders on extraction success"
      pattern: "extractionState\\.status.*success.*ResumeExtractionReview"
    - from: "test-upload.tsx"
      to: "applyExtractedProfile"
      via: "mutation on apply"
      pattern: "useMutation.*applyExtractedProfile"
    - from: "test-upload.tsx"
      to: "/profile/edit"
      via: "navigation after apply"
      pattern: "navigate.*profile/edit.*enrichment"
---

<objective>
Integrate review UI into upload flow and verify complete end-to-end functionality

Purpose: Connect the review components to the existing upload/extraction flow
Output: Complete working flow from upload through profile update with human verification
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-review-apply-ui/09-CONTEXT.md
@src/routes/test-upload.tsx
@src/components/profile/extraction/ResumeExtractionReview.tsx
@convex/profiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate ResumeExtractionReview into test-upload page</name>
  <files>src/routes/test-upload.tsx</files>
  <action>
Replace the current success state display with the full review UI.

**Changes to test-upload.tsx:**

1. Add imports:
```typescript
import { useMutation } from "convex/react";
import { useNavigate } from "@tanstack/react-router";
import { api } from "convex/_generated/api";
import { ResumeExtractionReview } from "~/components/profile/extraction";
```

2. Add mutation and navigation hooks inside component:
```typescript
const applyExtractedProfile = useMutation(api.profiles.applyExtractedProfile);
const navigate = useNavigate();
const [isApplying, setIsApplying] = useState(false);
```

3. Add apply handler:
```typescript
const handleApplyToProfile = async (data: AppliedData) => {
  setIsApplying(true);
  try {
    await applyExtractedProfile({ extractedData: data });
    // Reset state and navigate to enrichment
    handleStartOver();
    navigate({ to: "/profile/edit", search: { step: "enrichment" } });
  } catch (error) {
    console.error("Failed to apply extraction:", error);
    // Stay on page, user can retry
  } finally {
    setIsApplying(false);
  }
};
```

4. Add skip handler:
```typescript
const handleSkipToManual = () => {
  handleStartOver();
  navigate({ to: "/profile/edit" });
};
```

5. Replace the success state content. Change from:
```typescript
{extractionState.status === "success" && (
  <div className="rounded-lg border border-green-500 bg-green-50 ...">
    <h2>Extraction Complete!</h2>
    {/* Basic data display */}
    <button onClick={handleStartOver}>Start Over</button>
  </div>
)}
```

To:
```typescript
{extractionState.status === "success" && (
  <ResumeExtractionReview
    extractedData={extractionState.extractedData}
    onApply={handleApplyToProfile}
    onSkip={handleSkipToManual}
    isApplying={isApplying}
  />
)}
```

6. Keep the grid overlay transition pattern for smooth state changes.

7. Update the debug state display to show "reviewing" when extraction succeeded.
  </action>
  <verify>
- Page compiles: `npx tsc --noEmit`
- Dev server runs without errors
- Upload -> extraction -> review UI appears
- Navigation imports resolve correctly
  </verify>
  <done>
- test-upload.tsx renders ResumeExtractionReview on extraction success
- Apply handler calls mutation and navigates to enrichment
- Skip handler navigates to manual profile edit
- Smooth transition maintained via grid overlay
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete upload -> extract -> review -> apply flow integrated in test-upload page
  </what-built>
  <how-to-verify>
**Test the complete flow:**

1. Start dev server: `bun run dev`

2. Navigate to http://localhost:5173/test-upload (login first if needed)

3. Upload a PDF resume:
   - Drag and drop a PDF onto the upload zone
   - OR click to select file

4. Wait for extraction (5-10 seconds)

5. Verify review UI appears with:
   - [ ] Header: "Review Extracted Information"
   - [ ] Basic Info section: name, location, email (email shows "for verification only")
   - [ ] Education section (if extracted): expandable cards with degree + institution
   - [ ] Work History section (if extracted): expandable cards with title + organization
   - [ ] Skills section: editable skill chips + "Also mentioned" raw skills

6. Test interactions:
   - [ ] Click accept (checkmark) on a field - turns green
   - [ ] Click reject (X) on a field - turns grey/strikethrough
   - [ ] Click edit (pencil) on a field - shows input, blur to save
   - [ ] Expand an education/work card - shows full details
   - [ ] Edit a skill - SkillsInput works correctly

7. Verify footer:
   - [ ] Shows "X of Y fields will be applied" counter
   - [ ] Counter updates when accepting/rejecting fields

8. Test apply:
   - [ ] Accept at least one field
   - [ ] Click "Apply to Profile"
   - [ ] Loading state shows
   - [ ] Redirects to /profile/edit?step=enrichment

9. Verify profile updated:
   - [ ] Navigate to /profile/edit (basic info step)
   - [ ] Accepted fields appear in profile form
   - [ ] Work history dates converted correctly (not "undefined")

10. Test skip:
    - [ ] Start over, upload another file
    - [ ] Click "Skip to Manual Entry"
    - [ ] Redirects to /profile/edit without applying
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Lint passes: `bun run lint`
3. Complete flow works: upload -> extract -> review -> edit -> apply -> profile updated
4. Navigation works correctly to enrichment step
</verification>

<success_criteria>
- User sees review UI when extraction completes successfully
- User can accept/reject/edit individual fields
- Field counter shows accurate accepted/total counts
- Apply saves accepted data to profile with correct date conversion
- User redirects to enrichment step after apply
- Skip option navigates to manual profile edit
</success_criteria>

<output>
After completion, create `.planning/phases/09-review-apply-ui/09-03-SUMMARY.md`
</output>
