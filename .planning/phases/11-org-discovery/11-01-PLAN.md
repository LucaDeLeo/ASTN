---
phase: 11-org-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/organizations.ts
  - convex/orgs/discovery.ts
  - convex/profiles.ts
autonomous: true

must_haves:
  truths:
    - 'Organizations have location fields (city, country, coordinates, isGlobal)'
    - 'System can suggest orgs by user location with proper fallbacks'
    - 'User can toggle location discoverability in their profile'
    - 'Already-joined orgs are excluded from suggestions'
  artifacts:
    - path: 'convex/schema.ts'
      provides: 'Organizations table with location fields and indexes'
      contains: 'city: v.optional(v.string())'
    - path: 'convex/organizations.ts'
      provides: 'Updated seed data with location metadata'
      contains: 'city:'
    - path: 'convex/orgs/discovery.ts'
      provides: 'Geography-based org suggestion query'
      exports: ['getSuggestedOrgs']
    - path: 'convex/profiles.ts'
      provides: 'Location privacy mutation'
      exports: ['updateLocationPrivacy']
  key_links:
    - from: 'convex/orgs/discovery.ts'
      to: 'profiles.privacySettings.locationDiscoverable'
      via: "query checks user's location privacy setting"
      pattern: 'locationDiscoverable'
    - from: 'convex/orgs/discovery.ts'
      to: 'orgMemberships'
      via: 'filters out already-joined orgs'
      pattern: 'orgMemberships'
---

<objective>
Create backend foundation for org discovery - schema extensions, seed data with locations, and geography-based suggestion query.

Purpose: Enable location-aware org recommendations while respecting user privacy preferences.
Output: Extended schema, populated location data, and working getSuggestedOrgs query.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-org-discovery/11-CONTEXT.md
@.planning/phases/11-org-discovery/11-RESEARCH.md

# Existing code to extend

@convex/schema.ts
@convex/organizations.ts
@convex/profiles.ts
@convex/orgs/directory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend organizations schema with location fields</name>
  <files>convex/schema.ts, convex/organizations.ts</files>
  <action>
Extend the organizations table in schema.ts with these fields:
- description: v.optional(v.string()) - For org card display
- city: v.optional(v.string()) - e.g., "Buenos Aires", "San Francisco"
- country: v.optional(v.string()) - e.g., "Argentina", "United States"
- coordinates: v.optional(v.object({ lat: v.number(), lng: v.number() })) - For map display
- isGlobal: v.optional(v.boolean()) - True for orgs without specific location
- memberCount: v.optional(v.number()) - Denormalized for display

Add indexes:

- .index("by_country", ["country"])
- .index("by_city_country", ["city", "country"])

Update the AI_SAFETY_ORGANIZATIONS constant in organizations.ts with location data:

- BAISH: city: "Buenos Aires", country: "Argentina", isGlobal: false
- Anthropic: city: "San Francisco", country: "United States", isGlobal: false
- OpenAI: city: "San Francisco", country: "United States", isGlobal: false
- DeepMind: city: "London", country: "United Kingdom", isGlobal: false
- MIRI: city: "Berkeley", country: "United States", isGlobal: false
- Center for AI Safety: city: "San Francisco", country: "United States", isGlobal: false
- 80,000 Hours: city: "London", country: "United Kingdom", isGlobal: true (global org)
- Open Philanthropy: city: "San Francisco", country: "United States", isGlobal: true
- Others without clear location: set isGlobal: true

Update seedOrganizations to include the new fields.

Add brief descriptions for each org (1-2 sentences about what they do).
</action>
<verify>
Run `bun run lint` - no errors.
Run `bunx convex dev` briefly to verify schema compiles.
</verify>
<done>
Organizations table has location fields (city, country, coordinates, isGlobal, description, memberCount) with proper indexes. Seed data includes location metadata for all AI safety organizations.
</done>
</task>

<task type="auto">
  <name>Task 2: Add locationDiscoverable to profiles</name>
  <files>convex/schema.ts, convex/profiles.ts</files>
  <action>
In schema.ts, extend the privacySettings object in profiles table:
- Add locationDiscoverable: v.optional(v.boolean()) inside the privacySettings object
- Default interpretation: undefined or false means NOT discoverable (opt-in)

In profiles.ts, create updateLocationPrivacy mutation:

```typescript
export const updateLocationPrivacy = mutation({
  args: { locationDiscoverable: v.boolean() },
  handler: async (ctx, { locationDiscoverable }) => {
    const userId = await auth.getUserId(ctx)
    if (!userId) throw new Error('Not authenticated')

    const profile = await ctx.db
      .query('profiles')
      .withIndex('by_user', (q) => q.eq('userId', userId))
      .first()

    if (!profile) throw new Error('Profile not found')

    // Merge with existing privacy settings
    const existingSettings = profile.privacySettings ?? {
      defaultVisibility: 'private' as const,
    }

    await ctx.db.patch(profile._id, {
      privacySettings: {
        ...existingSettings,
        locationDiscoverable,
      },
      updatedAt: Date.now(),
    })

    return { success: true }
  },
})
```

Also add a getLocationPrivacy query to fetch current setting for the settings UI.
</action>
<verify>
Run `bun run lint` - no errors.
Test mutation via Convex dashboard or test file.
</verify>
<done>
Profiles can store locationDiscoverable setting. Mutation updateLocationPrivacy allows users to toggle this setting. Query getLocationPrivacy returns current state.
</done>
</task>

<task type="auto">
  <name>Task 3: Create getSuggestedOrgs discovery query</name>
  <files>convex/orgs/discovery.ts</files>
  <action>
Create new file convex/orgs/discovery.ts with getSuggestedOrgs query:

```typescript
import { query } from '../_generated/server'
import { auth } from '../auth'

// Helper to parse city from user's location string
function parseCity(location: string | undefined): string | null {
  if (!location) return null
  // Simple parsing: assume "City, Country" or just "City" format
  const parts = location.split(',').map((s) => s.trim())
  return parts[0] || null
}

export const getSuggestedOrgs = query({
  args: {},
  handler: async (ctx) => {
    const userId = await auth.getUserId(ctx)
    if (!userId) return []

    const profile = await ctx.db
      .query('profiles')
      .withIndex('by_user', (q) => q.eq('userId', userId))
      .first()

    // Get user's existing memberships to exclude
    const memberships = await ctx.db
      .query('orgMemberships')
      .withIndex('by_user', (q) => q.eq('userId', userId))
      .collect()
    const joinedOrgIds = new Set(memberships.map((m) => m.orgId.toString()))

    // If location discovery disabled or no location, return global orgs only
    if (!profile?.privacySettings?.locationDiscoverable || !profile?.location) {
      const globalOrgs = await ctx.db
        .query('organizations')
        .filter((q) => q.eq(q.field('isGlobal'), true))
        .collect()

      return globalOrgs
        .filter((org) => !joinedOrgIds.has(org._id.toString()))
        .slice(0, 5)
    }

    // Parse user city
    const userCity = parseCity(profile.location)

    // 1. Get local orgs (same city)
    let localOrgs: typeof organizations = []
    if (userCity) {
      localOrgs = await ctx.db
        .query('organizations')
        .filter((q) =>
          q.and(
            q.eq(q.field('city'), userCity),
            q.neq(q.field('isGlobal'), true),
          ),
        )
        .collect()
    }

    // 2. Get global orgs to fill remaining slots
    const globalOrgs = await ctx.db
      .query('organizations')
      .filter((q) => q.eq(q.field('isGlobal'), true))
      .collect()

    // 3. Combine, filter out joined, take 5
    const combined = [...localOrgs, ...globalOrgs]
    const filtered = combined.filter(
      (org) => !joinedOrgIds.has(org._id.toString()),
    )

    return filtered.slice(0, 5)
  },
})
```

Notes:

- Returns empty array for unauthenticated users
- Respects locationDiscoverable privacy setting
- Excludes orgs user has already joined
- Falls back to global orgs when location disabled or no matches
- Maximum 5 suggestions
  </action>
  <verify>
  Run `bun run lint` - no errors.
  Verify query is exported in convex/\_generated/api (after running convex dev).
  </verify>
  <done>
  getSuggestedOrgs query returns geography-based org suggestions respecting privacy settings. Returns local orgs first, fills with global orgs, excludes already-joined orgs, max 5 results.
  </done>
  </task>

</tasks>

<verification>
1. Schema compiles without errors: `bunx convex dev` starts successfully
2. Organizations have location fields visible in Convex dashboard
3. Seed data populates with location information
4. updateLocationPrivacy mutation works
5. getSuggestedOrgs returns appropriate orgs based on test scenarios
</verification>

<success_criteria>

- Organizations table extended with city, country, coordinates, isGlobal, description fields
- All seeded orgs have location metadata (city/country or isGlobal flag)
- profiles.privacySettings includes locationDiscoverable
- updateLocationPrivacy and getLocationPrivacy functions work
- getSuggestedOrgs returns geography-filtered suggestions
- No TypeScript errors, lint passes
  </success_criteria>

<output>
After completion, create `.planning/phases/11-org-discovery/11-01-SUMMARY.md`
</output>
