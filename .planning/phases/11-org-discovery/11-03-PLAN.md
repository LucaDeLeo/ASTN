---
phase: 11-org-discovery
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/routes/orgs/index.tsx
  - src/components/org/OrgMap.tsx
  - src/components/org/OrgFilters.tsx
  - convex/orgs/discovery.ts
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can browse all organizations at /orgs"
    - "User can filter organizations by country"
    - "User can search organizations by name"
    - "User can see organizations on a map (desktop)"
    - "Map shows markers for orgs with coordinates"
    - "Clicking a marker highlights the org in the list"
  artifacts:
    - path: "src/routes/orgs/index.tsx"
      provides: "Organization browse page with map and list"
      contains: "getAllOrgs"
    - path: "src/components/org/OrgMap.tsx"
      provides: "Interactive Leaflet map component"
      exports: ["OrgMap"]
    - path: "src/components/org/OrgFilters.tsx"
      provides: "Filter controls for org browsing"
      exports: ["OrgFilters"]
    - path: "convex/orgs/discovery.ts"
      provides: "getAllOrgs query with filtering"
      exports: ["getAllOrgs"]
  key_links:
    - from: "src/routes/orgs/index.tsx"
      to: "api.orgs.discovery.getAllOrgs"
      via: "useQuery hook"
      pattern: "useQuery.*getAllOrgs"
    - from: "src/components/org/OrgMap.tsx"
      to: "org.coordinates"
      via: "L.marker placement"
      pattern: "L\\.marker"
    - from: "src/routes/orgs/index.tsx"
      to: "OrgCard"
      via: "list rendering"
      pattern: "OrgCard.*variant.*list"
---

<objective>
Build the org browse page with map and list views, filtering, and search.

Purpose: Allow users to discover organizations geographically and by search.
Output: /orgs browse page with split map/list view, OrgMap component, OrgFilters component, and getAllOrgs query.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-org-discovery/11-CONTEXT.md
@.planning/phases/11-org-discovery/11-RESEARCH.md
@.planning/phases/11-org-discovery/11-01-SUMMARY.md

# Components to use
@src/components/org/OrgCard.tsx
@convex/orgs/discovery.ts
@convex/organizations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAllOrgs query with filtering</name>
  <files>convex/orgs/discovery.ts</files>
  <action>
Add getAllOrgs query to convex/orgs/discovery.ts (created in Plan 01):

```typescript
export const getAllOrgs = query({
  args: {
    country: v.optional(v.string()),
    searchQuery: v.optional(v.string()),
  },
  handler: async (ctx, { country, searchQuery }) => {
    let orgs;

    // If search query provided, use search index
    if (searchQuery && searchQuery.trim()) {
      orgs = await ctx.db
        .query("organizations")
        .withSearchIndex("search_name", (q) => q.search("name", searchQuery))
        .collect();
    }
    // If country filter, use index
    else if (country) {
      orgs = await ctx.db
        .query("organizations")
        .withIndex("by_country", (q) => q.eq("country", country))
        .collect();
    }
    // Otherwise get all
    else {
      orgs = await ctx.db.query("organizations").collect();
    }

    // For each org, get member count
    const orgsWithCounts = await Promise.all(
      orgs.map(async (org) => {
        const memberCount = await ctx.db
          .query("orgMemberships")
          .withIndex("by_org", (q) => q.eq("orgId", org._id))
          .collect()
          .then((m) => m.length);

        return {
          ...org,
          memberCount,
        };
      })
    );

    // Sort alphabetically by name
    return orgsWithCounts.sort((a, b) => a.name.localeCompare(b.name));
  },
});

// Helper query to get unique countries for filter dropdown
export const getOrgCountries = query({
  args: {},
  handler: async (ctx) => {
    const orgs = await ctx.db.query("organizations").collect();
    const countries = [...new Set(orgs.map((o) => o.country).filter(Boolean))];
    return countries.sort() as string[];
  },
});
```

Import v from convex/values at top if not already imported.
  </action>
  <verify>
Run `bun run lint` - no errors.
Query compiles and is exported in api.
  </verify>
  <done>
getAllOrgs query returns all organizations with optional country filter and search. getOrgCountries returns unique countries for filter dropdown. Member counts computed for each org.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OrgFilters component</name>
  <files>src/components/org/OrgFilters.tsx</files>
  <action>
Create src/components/org/OrgFilters.tsx:

```typescript
import { useQuery } from "convex/react";
import { Search, MapPin, X } from "lucide-react";
import { api } from "../../../convex/_generated/api";
import { Input } from "~/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "~/components/ui/select";
import { Button } from "~/components/ui/button";

interface OrgFiltersProps {
  searchQuery: string;
  onSearchChange: (value: string) => void;
  country: string | undefined;
  onCountryChange: (value: string | undefined) => void;
}

export function OrgFilters({
  searchQuery,
  onSearchChange,
  country,
  onCountryChange,
}: OrgFiltersProps) {
  const countries = useQuery(api.orgs.discovery.getOrgCountries);

  const hasFilters = searchQuery || country;

  const clearFilters = () => {
    onSearchChange("");
    onCountryChange(undefined);
  };

  return (
    <div className="flex flex-col sm:flex-row gap-3 mb-4">
      {/* Search input */}
      <div className="relative flex-1">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-slate-400" />
        <Input
          type="text"
          placeholder="Search organizations..."
          value={searchQuery}
          onChange={(e) => onSearchChange(e.target.value)}
          className="pl-9"
        />
      </div>

      {/* Country filter */}
      <Select
        value={country || "all"}
        onValueChange={(v) => onCountryChange(v === "all" ? undefined : v)}
      >
        <SelectTrigger className="w-full sm:w-48">
          <MapPin className="size-4 mr-2 text-slate-400" />
          <SelectValue placeholder="All countries" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">All countries</SelectItem>
          {countries?.map((c) => (
            <SelectItem key={c} value={c}>
              {c}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {/* Clear filters button */}
      {hasFilters && (
        <Button variant="ghost" size="icon" onClick={clearFilters}>
          <X className="size-4" />
        </Button>
      )}
    </div>
  );
}
```
  </action>
  <verify>
Run `bun run lint` - no errors.
Component compiles without TypeScript errors.
  </verify>
  <done>
OrgFilters provides search input and country dropdown filter. Clear button appears when filters active. Integrates with getOrgCountries query for country options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create OrgMap component with Leaflet CDN</name>
  <files>src/components/org/OrgMap.tsx, index.html</files>
  <action>
First, add Leaflet CDN to index.html in the head section:
```html
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
```

Create src/components/org/OrgMap.tsx:

```typescript
import { useEffect, useRef } from "react";
import type { Id } from "../../../convex/_generated/dataModel";

// Leaflet types (loaded via CDN)
declare global {
  interface Window {
    L: typeof import("leaflet");
  }
}

interface OrgMapProps {
  orgs: Array<{
    _id: Id<"organizations">;
    name: string;
    city?: string;
    country?: string;
    coordinates?: { lat: number; lng: number };
  }>;
  selectedOrgId: Id<"organizations"> | null;
  onOrgSelect: (id: Id<"organizations">) => void;
}

export function OrgMap({ orgs, selectedOrgId, onOrgSelect }: OrgMapProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<L.Map | null>(null);
  const markersRef = useRef<Map<string, L.Marker>>(new Map());

  // Initialize map
  useEffect(() => {
    if (!mapRef.current || !window.L || mapInstanceRef.current) return;

    const map = window.L.map(mapRef.current).setView([20, 0], 2);
    window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18,
    }).addTo(map);

    mapInstanceRef.current = map;

    return () => {
      map.remove();
      mapInstanceRef.current = null;
    };
  }, []);

  // Update markers when orgs change
  useEffect(() => {
    const map = mapInstanceRef.current;
    if (!map || !window.L) return;

    // Clear existing markers
    markersRef.current.forEach((marker) => marker.remove());
    markersRef.current.clear();

    // Add markers for orgs with coordinates
    const orgsWithCoords = orgs.filter((o) => o.coordinates);

    orgsWithCoords.forEach((org) => {
      const marker = window.L.marker([org.coordinates!.lat, org.coordinates!.lng])
        .addTo(map)
        .bindPopup(`<b>${org.name}</b><br/>${org.city || ""}, ${org.country || ""}`)
        .on("click", () => onOrgSelect(org._id));

      markersRef.current.set(org._id.toString(), marker);
    });

    // Fit bounds if we have markers
    if (orgsWithCoords.length > 0) {
      const bounds = window.L.latLngBounds(
        orgsWithCoords.map((o) => [o.coordinates!.lat, o.coordinates!.lng])
      );
      map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
    }
  }, [orgs, onOrgSelect]);

  // Highlight selected marker
  useEffect(() => {
    markersRef.current.forEach((marker, id) => {
      if (id === selectedOrgId?.toString()) {
        marker.openPopup();
      }
    });
  }, [selectedOrgId]);

  return (
    <div
      ref={mapRef}
      className="h-full w-full bg-slate-100 rounded-lg"
      style={{ minHeight: "400px" }}
    />
  );
}
```

Note: Using Leaflet via CDN avoids npm dependency. The global Window.L type declaration handles TypeScript.
  </action>
  <verify>
Run `bun run lint` - no errors.
Map renders in browser with markers for orgs that have coordinates.
  </verify>
  <done>
OrgMap component renders interactive Leaflet map. Markers placed for orgs with coordinates. Click marker to select org. Selected org marker opens popup. Map auto-fits to show all markers.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create /orgs browse page</name>
  <files>src/routes/orgs/index.tsx</files>
  <action>
Create src/routes/orgs/index.tsx:

```typescript
import { createFileRoute } from "@tanstack/react-router";
import { useQuery } from "convex/react";
import { useState, useMemo } from "react";
import { Building2 } from "lucide-react";
import { api } from "../../../convex/_generated/api";
import type { Id } from "../../../convex/_generated/dataModel";
import { AuthHeader } from "~/components/layout/auth-header";
import { OrgCard } from "~/components/org/OrgCard";
import { OrgMap } from "~/components/org/OrgMap";
import { OrgFilters } from "~/components/org/OrgFilters";
import { Spinner } from "~/components/ui/spinner";

export const Route = createFileRoute("/orgs/")({
  component: OrgBrowsePage,
});

function OrgBrowsePage() {
  const [searchQuery, setSearchQuery] = useState("");
  const [country, setCountry] = useState<string | undefined>();
  const [selectedOrgId, setSelectedOrgId] = useState<Id<"organizations"> | null>(null);

  // Debounced search - only query when search is 2+ chars or empty
  const effectiveSearch = searchQuery.length >= 2 ? searchQuery : undefined;

  const orgs = useQuery(api.orgs.discovery.getAllOrgs, {
    country,
    searchQuery: effectiveSearch,
  });

  // Memoize orgs for map to avoid re-renders
  const orgsForMap = useMemo(() => orgs || [], [orgs]);

  return (
    <div className="min-h-screen bg-slate-50">
      <AuthHeader />
      <main className="flex flex-col lg:flex-row h-[calc(100vh-65px)]">
        {/* Map - left side on desktop, hidden on mobile */}
        <div className="hidden lg:block w-1/2 h-full p-4">
          <OrgMap
            orgs={orgsForMap}
            selectedOrgId={selectedOrgId}
            onOrgSelect={setSelectedOrgId}
          />
        </div>

        {/* List - right side, scrollable */}
        <div className="flex-1 overflow-y-auto p-4 lg:p-6">
          <div className="mb-6">
            <h1 className="text-2xl font-bold text-slate-900 mb-2">
              Organizations
            </h1>
            <p className="text-slate-600">
              Discover AI safety organizations around the world
            </p>
          </div>

          <OrgFilters
            searchQuery={searchQuery}
            onSearchChange={setSearchQuery}
            country={country}
            onCountryChange={setCountry}
          />

          {/* Results */}
          {orgs === undefined ? (
            <div className="flex items-center justify-center py-12">
              <Spinner />
            </div>
          ) : orgs.length === 0 ? (
            <EmptyState hasFilters={!!searchQuery || !!country} />
          ) : (
            <div className="space-y-4">
              {orgs.map((org) => (
                <div
                  key={org._id}
                  className={`transition-colors rounded-lg ${
                    selectedOrgId === org._id
                      ? "ring-2 ring-primary ring-offset-2"
                      : ""
                  }`}
                  onClick={() => setSelectedOrgId(org._id)}
                >
                  <OrgCard org={org} variant="list" />
                </div>
              ))}
            </div>
          )}
        </div>
      </main>
    </div>
  );
}

function EmptyState({ hasFilters }: { hasFilters: boolean }) {
  return (
    <div className="text-center py-12">
      <div className="size-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
        <Building2 className="size-8 text-slate-400" />
      </div>
      <h3 className="text-lg font-medium text-slate-900 mb-2">
        {hasFilters ? "No organizations found" : "No organizations yet"}
      </h3>
      <p className="text-slate-500">
        {hasFilters
          ? "Try adjusting your filters or search query"
          : "Organizations will appear here once added"}
      </p>
    </div>
  );
}
```

Notes:
- Split view: map on left (desktop only), list on right
- Map hidden on mobile (lg:block)
- Selected org highlighted in list with ring
- Click org in list to select (opens popup on map)
- Filters persist across interactions
- Loading and empty states handled
  </action>
  <verify>
Run `bun run lint` - no errors.
Navigate to /orgs - see split view with map and list.
Search and filter - results update.
Click org in list or map - selection syncs.
  </verify>
  <done>
/orgs browse page provides split map/list view on desktop, list-only on mobile. Filters and search work. Selection syncs between map markers and list items. Loading and empty states handled appropriately.
  </done>
</task>

</tasks>

<verification>
1. getAllOrgs query returns filtered results correctly
2. getOrgCountries returns unique country list
3. OrgFilters search and dropdown work
4. OrgMap renders with markers
5. Clicking map marker selects org
6. /orgs page shows split view on desktop
7. /orgs page shows list only on mobile
8. Filter and search update results
9. All TypeScript compiles, lint passes
</verification>

<success_criteria>
- getAllOrgs query with country filter and search working
- OrgFilters provides functional search and country dropdown
- OrgMap displays Leaflet map with org markers
- /orgs browse page with responsive split view
- Selection syncs between map and list
- Empty and loading states handled
- No TypeScript errors, lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-org-discovery/11-03-SUMMARY.md`
</output>
