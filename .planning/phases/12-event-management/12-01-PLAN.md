---
phase: 12-event-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/events/lumaClient.ts
  - convex/events/sync.ts
  - convex/events/queries.ts
  - convex/events/mutations.ts
  - convex/crons.ts
autonomous: true
user_setup:
  - service: luma
    why: 'Event import requires Lu.ma API access'
    env_vars:
      - name: LUMA_API_KEY
        source: 'Lu.ma Dashboard -> Settings -> API (requires Luma Plus subscription)'
    notes: "API key is per-calendar. Orgs without Luma Plus can still use embed (no API needed) but won't appear in dashboard aggregation."

must_haves:
  truths:
    - 'Events table stores lu.ma event data'
    - 'Organizations can configure lu.ma calendar URL and API key'
    - 'Sync action fetches events from lu.ma API'
    - 'Daily cron triggers event sync'
  artifacts:
    - path: 'convex/schema.ts'
      provides: 'events table and lumaCalendarUrl/lumaApiKey fields on organizations'
      contains: 'events: defineTable'
    - path: 'convex/events/lumaClient.ts'
      provides: 'Lu.ma API client for fetching events'
      exports: ['fetchLumaEvents']
    - path: 'convex/events/sync.ts'
      provides: 'Sync actions for cron and on-demand sync'
      exports: ['runFullEventSync', 'syncOrgEvents']
    - path: 'convex/events/queries.ts'
      provides: 'Queries for fetching events'
      exports: ['getOrgsWithLumaConfig']
    - path: 'convex/crons.ts'
      provides: 'Daily event sync cron job'
      contains: 'sync-luma-events'
  key_links:
    - from: 'convex/crons.ts'
      to: 'convex/events/sync.ts'
      via: 'crons.daily calls internal.events.sync.runFullEventSync'
      pattern: "internal\\.events\\.sync\\.runFullEventSync"
    - from: 'convex/events/sync.ts'
      to: 'convex/events/lumaClient.ts'
      via: 'syncOrgEvents calls fetchLumaEvents'
      pattern: 'fetchLumaEvents'
---

<objective>
Create the events schema and lu.ma sync backend for importing events from lu.ma calendars.

Purpose: Enable orgs to have their lu.ma events automatically synced to ASTN for dashboard aggregation
Output: Events table in Convex, lu.ma API client, sync actions, and daily cron job
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-event-management/12-CONTEXT.md
@.planning/phases/12-event-management/12-RESEARCH.md

@convex/schema.ts
@convex/crons.ts
@convex/aggregation/sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add events table and lu.ma config to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add lu.ma configuration fields to organizations table:
- `lumaCalendarUrl: v.optional(v.string())` - Public calendar URL (e.g., "https://lu.ma/baish") for embed
- `lumaApiKey: v.optional(v.string())` - API key for sync (requires Luma Plus)
- `eventsLastSynced: v.optional(v.number())` - Timestamp of last sync

Add new events table:

```typescript
events: defineTable({
  orgId: v.id("organizations"),
  lumaEventId: v.string(),          // lu.ma event ID (e.g., "evt-abc123")

  // Core fields from lu.ma API
  title: v.string(),
  description: v.optional(v.string()),
  startAt: v.number(),              // Unix timestamp
  endAt: v.optional(v.number()),    // Unix timestamp
  timezone: v.string(),             // IANA timezone
  coverUrl: v.optional(v.string()), // Event cover image
  url: v.string(),                  // lu.ma event URL for RSVP link-out

  // Location (can be virtual or physical)
  location: v.optional(v.string()), // Address or "Online"
  isVirtual: v.boolean(),           // True if online event

  // Metadata
  syncedAt: v.number(),
})
.index("by_org", ["orgId"])
.index("by_org_start", ["orgId", "startAt"])
.index("by_luma_id", ["lumaEventId"]),
```

  </action>
  <verify>Run `bunx convex dev --once` - schema should deploy without errors</verify>
  <done>Schema includes events table and organizations has lu.ma config fields</done>
</task>

<task type="auto">
  <name>Task 2: Create lu.ma API client and sync actions</name>
  <files>convex/events/lumaClient.ts, convex/events/sync.ts, convex/events/queries.ts, convex/events/mutations.ts</files>
  <action>
Create `convex/events/lumaClient.ts`:
- Add "use node" directive at top
- Define LumaEvent and LumaListResponse interfaces based on RESEARCH.md
- Export `fetchLumaEvents(apiKey: string, options?: { after?: string, before?: string })` function
- Use pagination with cursor, limit 100 per page
- Handle 429 rate limit with 60s retry
- Add 200ms delay between pages for rate limit protection

Create `convex/events/queries.ts`:

- Export `getOrgsWithLumaConfig` internal query - returns orgs with lumaApiKey set
- Will be used by sync action to know which orgs to sync

Create `convex/events/mutations.ts`:

- Export `upsertEvents` internal mutation
- Takes orgId and array of events from lu.ma
- Upserts by lumaEventId (update if exists, create if not)
- Updates syncedAt timestamp

Create `convex/events/sync.ts`:

- Add "use node" directive
- Export `runFullEventSync` internal action for cron
  - Gets all orgs with lu.ma config via getOrgsWithLumaConfig
  - Calls syncOrgEvents for each with 1s delay between orgs
  - Logs progress
- Export `syncOrgEvents` internal action
  - Fetches events from lu.ma for single org
  - Calls upsertEvents mutation
  - Updates org's eventsLastSynced timestamp

Follow existing pattern from `convex/aggregation/sync.ts` for structure and logging.
</action>
<verify>
Check files exist and compile:

```bash
bunx convex dev --once
```

  </verify>
  <done>Lu.ma client fetches events, sync actions orchestrate the import, mutations persist to database</done>
</task>

<task type="auto">
  <name>Task 3: Add daily event sync cron job</name>
  <files>convex/crons.ts</files>
  <action>
Add new cron job after the existing opportunity sync:

```typescript
// Run daily at 7 AM UTC (after opportunity sync at 6 AM)
// Syncs events from lu.ma for orgs with API keys configured
crons.daily(
  'sync-luma-events',
  { hourUTC: 7, minuteUTC: 0 },
  internal.events.sync.runFullEventSync,
)
```

Import internal from \_generated/api if not already done.
</action>
<verify>
Run `bunx convex dev --once` - cron should register without errors.
Check Convex dashboard shows the new cron job.
</verify>
<done>Daily cron at 7 AM UTC triggers lu.ma event sync</done>
</task>

</tasks>

<verification>
1. Schema deployed with events table and org lu.ma fields
2. Lu.ma client compiles and exports fetchLumaEvents
3. Sync action compiles and exports runFullEventSync
4. Cron job registered in Convex
</verification>

<success_criteria>

- [ ] events table exists in schema with proper indexes
- [ ] organizations table has lumaCalendarUrl, lumaApiKey, eventsLastSynced fields
- [ ] fetchLumaEvents function handles pagination and rate limits
- [ ] syncOrgEvents fetches and persists events
- [ ] Daily cron job registered at 7 AM UTC
      </success_criteria>

<output>
After completion, create `.planning/phases/12-event-management/12-01-SUMMARY.md`
</output>
