---
phase: 13-event-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/profiles.ts
  - src/components/settings/EventNotificationPrefsForm.tsx
  - src/routes/settings/route.tsx
autonomous: true

must_haves:
  truths:
    - "User can see event notification settings on settings page"
    - "User can select notification frequency (all/daily/weekly/none)"
    - "User can toggle reminder timings (1 week, 1 day, 1 hour before)"
    - "User can mute specific orgs from event notifications"
  artifacts:
    - path: "convex/schema.ts"
      provides: "eventNotificationPreferences field on profiles, notifications table, eventViews table, scheduledReminders table"
      contains: "eventNotificationPreferences"
    - path: "src/components/settings/EventNotificationPrefsForm.tsx"
      provides: "Event notification preferences form component"
      min_lines: 100
  key_links:
    - from: "src/components/settings/EventNotificationPrefsForm.tsx"
      to: "convex/profiles.ts"
      via: "updateEventNotificationPreferences mutation"
      pattern: "updateEventNotificationPreferences"
---

<objective>
Add schema for event notifications and create the preferences UI.

Purpose: Users need to configure how they receive event notifications before the system can send them. This plan establishes the data model and user-facing settings.
Output: Schema tables for notifications + preferences form on settings page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-event-notifications/13-CONTEXT.md
@.planning/phases/13-event-notifications/13-RESEARCH.md

# Existing patterns
@convex/schema.ts
@convex/profiles.ts
@src/components/settings/NotificationPrefsForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event notification schema</name>
  <files>convex/schema.ts</files>
  <action>
Add four new elements to the schema:

1. Add `eventNotificationPreferences` field to the `profiles` table (after existing `notificationPreferences`):
```typescript
eventNotificationPreferences: v.optional(
  v.object({
    frequency: v.union(
      v.literal("all"),
      v.literal("daily"),
      v.literal("weekly"),
      v.literal("none")
    ),
    reminderTiming: v.optional(
      v.object({
        oneWeekBefore: v.boolean(),
        oneDayBefore: v.boolean(),
        oneHourBefore: v.boolean(),
      })
    ),
    mutedOrgIds: v.optional(v.array(v.id("organizations"))),
  })
)
```

2. Add `notifications` table for in-app notification center:
```typescript
notifications: defineTable({
  userId: v.string(),
  type: v.union(
    v.literal("event_new"),
    v.literal("event_reminder"),
    v.literal("event_updated")
  ),
  eventId: v.optional(v.id("events")),
  orgId: v.optional(v.id("organizations")),
  title: v.string(),
  body: v.string(),
  actionUrl: v.optional(v.string()),
  read: v.boolean(),
  createdAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_user_read", ["userId", "read"])
```

3. Add `eventViews` table (for reminder audience tracking per CONTEXT.md):
```typescript
eventViews: defineTable({
  userId: v.string(),
  eventId: v.id("events"),
  viewedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_event", ["eventId"])
  .index("by_user_event", ["userId", "eventId"])
```

4. Add `scheduledReminders` table (to cancel reminders when events change):
```typescript
scheduledReminders: defineTable({
  eventId: v.id("events"),
  userId: v.string(),
  timing: v.union(v.literal("1_week"), v.literal("1_day"), v.literal("1_hour")),
  scheduledFunctionId: v.string(),
  scheduledFor: v.number(),
})
  .index("by_event", ["eventId"])
  .index("by_user_event", ["userId", "eventId"])
```
  </action>
  <verify>Run `bun run lint` - no TypeScript errors in schema.ts</verify>
  <done>Schema has eventNotificationPreferences on profiles, plus notifications, eventViews, and scheduledReminders tables with appropriate indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add event notification preferences mutation and UI</name>
  <files>convex/profiles.ts, src/components/settings/EventNotificationPrefsForm.tsx, src/routes/settings/route.tsx</files>
  <action>
**In convex/profiles.ts:**

1. Add a query `getEventNotificationPreferences`:
```typescript
export const getEventNotificationPreferences = query({
  args: {},
  handler: async (ctx) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return null;

    const profile = await ctx.db
      .query("profiles")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .first();

    if (!profile?.eventNotificationPreferences) {
      // Return defaults for new users (weekly digest, 1 day + 1 hour reminders)
      return {
        frequency: "weekly" as const,
        reminderTiming: {
          oneWeekBefore: false,
          oneDayBefore: true,
          oneHourBefore: true,
        },
        mutedOrgIds: [],
      };
    }

    return profile.eventNotificationPreferences;
  },
});
```

2. Add a mutation `updateEventNotificationPreferences`:
```typescript
export const updateEventNotificationPreferences = mutation({
  args: {
    frequency: v.union(
      v.literal("all"),
      v.literal("daily"),
      v.literal("weekly"),
      v.literal("none")
    ),
    reminderTiming: v.object({
      oneWeekBefore: v.boolean(),
      oneDayBefore: v.boolean(),
      oneHourBefore: v.boolean(),
    }),
    mutedOrgIds: v.array(v.id("organizations")),
  },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error("Not authenticated");

    const profile = await ctx.db
      .query("profiles")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .first();

    if (!profile) throw new Error("Profile not found");

    await ctx.db.patch(profile._id, {
      eventNotificationPreferences: {
        frequency: args.frequency,
        reminderTiming: args.reminderTiming,
        mutedOrgIds: args.mutedOrgIds,
      },
      updatedAt: Date.now(),
    });
  },
});
```

**Create src/components/settings/EventNotificationPrefsForm.tsx:**

Create a form component similar to NotificationPrefsForm.tsx but for event preferences:
- Frequency select with options: "All new events", "Daily digest", "Weekly digest", "None"
- Default: Weekly digest (per CONTEXT.md)
- Reminder timing checkboxes: 1 week before, 1 day before, 1 hour before
- Default: 1 day + 1 hour checked (per CONTEXT.md)
- Org muting section:
  - Query `orgMemberships` for current user to get their joined orgs
  - For each org membership, query the `organizations` table to get org names
  - Display list of orgs with Switch component for each (on = notifications enabled, off = muted)
  - Store muted org IDs in `mutedOrgIds` array (orgs with switch OFF)
  - Show "No organizations joined" message if user has no memberships
- Use existing patterns: Card wrapper, Label, Switch/Checkbox, Select, Button
- Show toast on save success/failure
- Use Calendar and BellOff icons from lucide-react

**In src/routes/settings/route.tsx:**

Add EventNotificationPrefsForm below the existing NotificationPrefsForm:
- Import EventNotificationPrefsForm
- Add it after the existing notification card with appropriate spacing
  </action>
  <verify>
1. Run `bun run lint` - no TypeScript errors
2. Start dev server, navigate to /settings
3. Verify event notification preferences card appears
4. Change frequency to "Daily digest", toggle reminders, save - toast confirms
5. Refresh page - settings persist
  </verify>
  <done>Users can configure event notification frequency and reminder preferences from the settings page</done>
</task>

</tasks>

<verification>
- [ ] Schema has all four new elements (eventNotificationPreferences field, notifications table, eventViews table, scheduledReminders table)
- [ ] Profiles query returns defaults for users without preferences
- [ ] Mutation saves preferences to database
- [ ] Settings page shows event notification form
- [ ] Form state syncs with saved preferences
- [ ] Changes persist across page refresh
</verification>

<success_criteria>
1. User navigates to /settings and sees "Event Notifications" card
2. User can select frequency from All/Daily/Weekly/None dropdown
3. User can toggle 1 week / 1 day / 1 hour reminder checkboxes
4. Saved preferences appear on page refresh
5. No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-event-notifications/13-01-SUMMARY.md`
</output>
