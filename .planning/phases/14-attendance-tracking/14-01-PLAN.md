---
phase: 14-attendance-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/attendance/mutations.ts
  - convex/attendance/queries.ts
  - convex/attendance/scheduler.ts
  - convex/crons.ts
autonomous: true

must_haves:
  truths:
    - "Attendance records can be stored and retrieved"
    - "Users can record attendance status (attended/partial/not_attended)"
    - "Users can submit feedback after attending"
    - "Users can snooze attendance prompts to next morning"
    - "System schedules attendance prompts 1 hour after events end"
  artifacts:
    - path: "convex/schema.ts"
      provides: "attendance table, scheduledAttendancePrompts table, extended notifications type"
      contains: "attendance: defineTable"
    - path: "convex/attendance/mutations.ts"
      provides: "recordAttendance, submitFeedback, snoozeAttendancePrompt mutations"
      exports: ["recordAttendance", "submitFeedback", "snoozeAttendancePrompt"]
    - path: "convex/attendance/queries.ts"
      provides: "getMyAttendanceHistory query"
      exports: ["getMyAttendanceHistory"]
    - path: "convex/attendance/scheduler.ts"
      provides: "schedulePostEventPrompts, sendAttendancePrompt functions"
      exports: ["schedulePostEventPrompts", "sendAttendancePrompt"]
    - path: "convex/crons.ts"
      provides: "Cron job to check for ended events"
      contains: "schedulePostEventPrompts"
  key_links:
    - from: "convex/crons.ts"
      to: "convex/attendance/scheduler.ts"
      via: "cron invokes schedulePostEventPrompts"
      pattern: "internal\\.attendance\\.scheduler"
    - from: "convex/attendance/scheduler.ts"
      to: "convex/schema.ts"
      via: "inserts into attendance and scheduledAttendancePrompts tables"
      pattern: "ctx\\.db\\.insert"
---

<objective>
Build attendance tracking backend: schema, mutations, queries, and post-event prompt scheduler.

Purpose: Enable the system to record user attendance at events, collect feedback, and automatically prompt users after events end.
Output: Complete backend layer for attendance tracking with automated prompt scheduling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-attendance-tracking/14-CONTEXT.md
@.planning/phases/14-attendance-tracking/14-RESEARCH.md
@convex/schema.ts
@convex/notifications/scheduler.ts
@convex/crons.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema for attendance tracking</name>
  <files>convex/schema.ts</files>
  <action>
Add three schema extensions:

1. Add `attendance` table:
```typescript
attendance: defineTable({
  userId: v.string(),
  eventId: v.id("events"),
  orgId: v.id("organizations"), // Denormalized for privacy queries

  // Response
  status: v.union(
    v.literal("attended"),
    v.literal("partial"),
    v.literal("not_attended"),
    v.literal("unknown")
  ),
  respondedAt: v.optional(v.number()),

  // Feedback (optional)
  feedbackRating: v.optional(v.number()), // 1-5 stars
  feedbackText: v.optional(v.string()),
  feedbackSubmittedAt: v.optional(v.number()),

  // Privacy
  showOnProfile: v.boolean(),
  showToOtherOrgs: v.boolean(),

  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_event", ["eventId"])
  .index("by_org", ["orgId"])
  .index("by_user_event", ["userId", "eventId"])
```

2. Extend notifications `type` union to include `v.literal("attendance_prompt")`. Also add optional `promptNumber` field (1 or 2) and `respondedAt` field.

3. Add `scheduledAttendancePrompts` table:
```typescript
scheduledAttendancePrompts: defineTable({
  eventId: v.id("events"),
  userId: v.string(),
  scheduledFunctionId: v.string(),
  scheduledFor: v.number(),
  promptNumber: v.number(), // 1 or 2
})
  .index("by_event", ["eventId"])
  .index("by_user_event", ["userId", "eventId"])
```
  </action>
  <verify>Run `bunx convex dev` and verify schema deploys without errors. Check Convex dashboard for new tables.</verify>
  <done>Schema includes attendance table with all fields, notifications type includes attendance_prompt, scheduledAttendancePrompts table exists with proper indexes.</done>
</task>

<task type="auto">
  <name>Task 2: Create attendance mutations</name>
  <files>convex/attendance/mutations.ts</files>
  <action>
Create `convex/attendance/mutations.ts` with three mutations:

1. `recordAttendance` - Public mutation:
   - Args: eventId, status (attended/partial/not_attended), notificationId (optional)
   - Validates user is authenticated
   - Checks event exists and is within retroactive window (14 days)
   - Creates or updates attendance record (upsert by userId + eventId)
   - Default privacy: showOnProfile=true, showToOtherOrgs=false
   - If notificationId provided, mark notification as read with respondedAt
   - Returns { status } to trigger feedback form for attended/partial

2. `submitFeedback` - Public mutation:
   - Args: eventId, rating (1-5), text (optional)
   - Validates user is authenticated
   - Finds existing attendance record for this user+event
   - Updates with feedbackRating, feedbackText, feedbackSubmittedAt
   - Throws if no attendance record exists

3. `snoozeAttendancePrompt` - Public mutation:
   - Args: notificationId
   - Validates user is authenticated and owns notification
   - Gets user's timezone from profile (default "UTC")
   - Calculates next morning 9 AM in user's timezone using date-fns-tz
   - Marks current notification as read
   - Schedules follow-up prompt using ctx.scheduler.runAt
   - Does NOT create another scheduled prompt if promptNumber >= 2

Use existing patterns from `convex/notifications/mutations.ts` for auth and error handling.
  </action>
  <verify>Run `bunx convex dev`. Test each mutation via Convex dashboard or temporary test code.</verify>
  <done>Three mutations exist and handle auth, validation, and database operations correctly. Snooze respects timezone and 2-prompt limit.</done>
</task>

<task type="auto">
  <name>Task 3: Create attendance queries and scheduler</name>
  <files>convex/attendance/queries.ts, convex/attendance/scheduler.ts, convex/crons.ts</files>
  <action>
Create three files:

**convex/attendance/queries.ts:**
- `getMyAttendanceHistory` - Public query:
  - Args: limit (optional, default 50)
  - Returns attendance records for current user, ordered by event startAt descending
  - Enriches each record with event details (title, startAt, location, isVirtual) and org details (name, logoUrl)
  - Only returns records where event exists (handles deleted events)

- `getPendingPrompts` - Public query:
  - Returns unread attendance_prompt notifications for current user
  - Enriches with event and org details

**convex/attendance/scheduler.ts:**
- `schedulePostEventPrompts` - Internal mutation (called by cron):
  - Queries events that ended in the last hour (endAt between now-70min and now-50min to avoid duplicates)
  - For events without endAt, use startAt + 2 hours as default end
  - For each ended event, get users from eventViews table
  - For each user: check eventNotificationPreferences.frequency !== "none"
  - Skip if attendance record already exists for this user+event
  - Schedule sendAttendancePrompt using ctx.scheduler.runAt for now + 1 hour after end
  - Store in scheduledAttendancePrompts table with promptNumber=1

- `sendAttendancePrompt` - Internal mutation:
  - Args: eventId, userId, promptNumber (default 1)
  - Gets event and org details
  - Creates notification with type="attendance_prompt"
  - Includes promptNumber in notification for UI display
  - Removes from scheduledAttendancePrompts table after creating notification

**convex/crons.ts:**
- Add cron job: `crons.interval("check for ended events", { minutes: 10 }, internal.attendance.scheduler.schedulePostEventPrompts)`
- Run every 10 minutes to catch events that recently ended
  </action>
  <verify>Run `bunx convex dev`. Check cron is registered in Convex dashboard. Manually test by creating a past event and verifying prompt gets scheduled.</verify>
  <done>Queries return enriched attendance data. Scheduler creates prompts for users who viewed events. Cron runs every 10 minutes.</done>
</task>

</tasks>

<verification>
1. Schema deployed: `bunx convex dev` completes without errors
2. New tables visible in Convex dashboard: attendance, scheduledAttendancePrompts
3. Notifications table accepts type="attendance_prompt"
4. Cron job "check for ended events" appears in Convex dashboard
5. Test flow: Create event with past endAt -> run scheduler manually -> verify prompt created
</verification>

<success_criteria>
- attendance table stores records with status, feedback, and privacy fields
- notifications type union includes attendance_prompt
- recordAttendance creates/updates attendance records
- submitFeedback updates existing attendance with rating and text
- snoozeAttendancePrompt schedules follow-up for next morning (respects timezone)
- schedulePostEventPrompts runs via cron and creates prompts for ended events
- getMyAttendanceHistory returns enriched attendance data
</success_criteria>

<output>
After completion, create `.planning/phases/14-attendance-tracking/14-01-SUMMARY.md`
</output>
