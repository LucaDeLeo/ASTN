---
phase: 14-attendance-tracking
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/routes/profile/attendance.tsx
  - src/routes/profile/index.tsx
  - src/components/settings/NotificationPrefsForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can view full attendance history on dedicated page"
    - "User sees attendance summary on profile page"
    - "User can toggle attendance visibility on profile"
    - "User can toggle cross-org attendance visibility"
    - "Attendance history shows event details and feedback status"
  artifacts:
    - path: "src/routes/profile/attendance.tsx"
      provides: "Full attendance history page"
      min_lines: 80
    - path: "src/routes/profile/index.tsx"
      provides: "Attendance summary section"
      contains: "attendance"
    - path: "src/components/settings/NotificationPrefsForm.tsx"
      provides: "Attendance privacy toggles"
      contains: "showOnProfile"
  key_links:
    - from: "src/routes/profile/attendance.tsx"
      to: "convex/attendance/queries.ts"
      via: "useQuery calls getMyAttendanceHistory"
      pattern: "useQuery.*getMyAttendanceHistory"
    - from: "src/routes/profile/index.tsx"
      to: "src/routes/profile/attendance.tsx"
      via: "Link to full history page"
      pattern: "Link.*attendance"
---

<objective>
Build attendance history page, profile summary section, and privacy settings for attendance visibility.

Purpose: Enable users to view their event attendance history and control who can see it.
Output: Complete user-facing attendance viewing and privacy features.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-attendance-tracking/14-CONTEXT.md
@.planning/phases/14-attendance-tracking/14-RESEARCH.md
@.planning/phases/14-attendance-tracking/14-01-SUMMARY.md
@src/routes/profile/index.tsx
@src/components/settings/NotificationPrefsForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create attendance history page</name>
  <files>src/routes/profile/attendance.tsx</files>
  <action>
Create `src/routes/profile/attendance.tsx` as a new route:

1. Route definition: `createFileRoute("/profile/attendance")`

2. Page structure:
   - AuthHeader at top
   - Authenticated wrapper (redirect to /login if not authenticated)
   - Main content with container

3. Content:
   - Header: "Attendance History" with back link to /profile
   - Loading state with Spinner
   - Empty state: "No events attended yet" with suggestion to browse events

4. Attendance list:
   - Use `useQuery(api.attendance.queries.getMyAttendanceHistory)`
   - Display in Card for each record:
     - Event title (bold), org name (muted)
     - Date: format event.startAt as "Fri, Jan 24, 2026"
     - Location: event.location or "Online" if isVirtual
     - Status badge: "Attended" (green), "Partial" (amber), "Did not attend" (gray), "Unknown" (gray outline)
     - If feedback exists: show star rating display (read-only) and truncated feedback text
   - Most recent first (already ordered from query)

5. Pagination: Initially just limit to 50. Add "Load more" button if needed later.

6. Privacy indicator: Small info text at bottom explaining who can see this data based on settings.

Use existing patterns from profile/index.tsx for auth handling and Card layouts.
Import date-fns for date formatting: `format(event.startAt, "EEE, MMM d, yyyy")`
  </action>
  <verify>Navigate to /profile/attendance. Verify page loads, shows auth redirect if not logged in, displays attendance records or empty state.</verify>
  <done>Attendance history page shows chronological list with event details, status badges, and feedback indicators.</done>
</task>

<task type="auto">
  <name>Task 2: Add attendance summary to profile page</name>
  <files>src/routes/profile/index.tsx</files>
  <action>
Add attendance summary section to profile page (after Career Goals card):

1. Create new query in convex/attendance/queries.ts (if not already there):
   - `getMyAttendanceSummary` - Returns { total: number, attended: number, recent: AttendanceRecord[] }
   - recent: last 3 attendance records with event/org details

2. In profile/index.tsx:
   - Add useQuery for getMyAttendanceSummary
   - Add new Card section with CalendarCheck icon
   - Header: "Event Attendance"
   - Content:
     - If no attendance: "No events attended yet" with link to browse events
     - If has attendance:
       - Stats: "{attended} events attended" (only count attended + partial)
       - Recent list: Show last 3 events with title, org, date, and status badge
       - "View full history" link to /profile/attendance

3. Styling:
   - Match existing Card patterns
   - Status badges: small inline badges using existing Badge component
   - Keep it compact - this is a summary, not full list

Import CalendarCheck from lucide-react.
  </action>
  <verify>View /profile page. Verify attendance summary card appears after Career Goals. Test with and without attendance data.</verify>
  <done>Profile page shows attendance summary with stats, recent events, and link to full history.</done>
</task>

<task type="auto">
  <name>Task 3: Add attendance privacy settings</name>
  <files>src/components/settings/NotificationPrefsForm.tsx, convex/attendance/mutations.ts</files>
  <action>
Add attendance privacy settings to the existing NotificationPrefsForm (or create separate section):

1. First, create mutation in convex/attendance/mutations.ts:
   - `updateAttendancePrivacy` - Updates default privacy settings for future attendance
   - Args: showOnProfile (boolean), showToOtherOrgs (boolean)
   - Stores in profile.attendancePrivacyDefaults (add to schema if needed)
   - Also update existing attendance records to match (batch update)

2. Add query to get current settings:
   - `getAttendancePrivacyDefaults` - Returns { showOnProfile: boolean, showToOtherOrgs: boolean }
   - Default: showOnProfile=true, showToOtherOrgs=false

3. In NotificationPrefsForm.tsx (or new section below it):
   - New section header: "Attendance Privacy"
   - Explanatory text: "Control who can see your event attendance"
   - Two toggle switches:
     - "Show on profile" - "Other users can see your attendance history"
       - Default: true
     - "Share with other organizations" - "Organizations you're not a member of can see your attendance"
       - Default: false
       - Note: "The hosting organization always sees attendance at their events"
   - Save button or auto-save on toggle (match existing pattern)

4. If NotificationPrefsForm is getting too long, consider creating a separate AttendancePrivacyForm component and including it on the settings page.

Use existing Switch component from shadcn/ui.
Toast notification on save using sonner.
  </action>
  <verify>Navigate to /settings. Verify attendance privacy section appears. Toggle settings and verify they persist on reload. Check that new attendance records use the defaults.</verify>
  <done>Users can configure attendance privacy defaults. Settings persist and apply to new attendance records.</done>
</task>

</tasks>

<verification>
1. Attendance history page: /profile/attendance loads, shows records with correct formatting
2. Empty state: User with no attendance sees appropriate message
3. Profile summary: Shows attendance card with stats and recent events
4. Privacy settings: Both toggles work, settings persist across page reloads
5. Privacy note: "Host org always sees" disclaimer is visible
6. Navigation: Profile -> View full history -> Attendance page, back link works
</verification>

<success_criteria>
- /profile/attendance page displays full attendance history
- Each record shows event title, org, date, location, status, and feedback
- Profile page shows attendance summary section with recent events
- Settings page has attendance privacy toggles
- Privacy defaults apply to new attendance records
- Host org visibility note is clear to users
</success_criteria>

<output>
After completion, create `.planning/phases/14-attendance-tracking/14-03-SUMMARY.md`
</output>
