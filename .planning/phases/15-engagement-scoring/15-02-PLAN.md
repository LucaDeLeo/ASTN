---
phase: 15-engagement-scoring
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/routes/org/$slug/admin/members.tsx
  - src/components/engagement/EngagementBadge.tsx
  - src/components/engagement/OverrideDialog.tsx
  - src/components/engagement/OverrideHistory.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees engagement level badge in member directory"
    - "Admin can click to see full engagement explanation"
    - "Admin can override engagement level via dialog with required notes"
    - "Admin can view override history for audit"
    - "Admin can clear an existing override"
  artifacts:
    - path: "src/components/engagement/EngagementBadge.tsx"
      provides: "Engagement level badge with tooltip"
      exports: ["EngagementBadge"]
    - path: "src/components/engagement/OverrideDialog.tsx"
      provides: "Dialog for admin to override engagement level"
      exports: ["OverrideDialog"]
    - path: "src/routes/org/$slug/admin/members.tsx"
      provides: "Member directory with engagement column"
      contains: "EngagementBadge"
  key_links:
    - from: "src/routes/org/$slug/admin/members.tsx"
      to: "api.engagement.queries"
      via: "useQuery for engagement data"
      pattern: "api.engagement"
    - from: "src/components/engagement/OverrideDialog.tsx"
      to: "api.engagement.mutations"
      via: "useMutation for override"
      pattern: "overrideEngagement"
---

<objective>
Add engagement UI to admin member directory with override capability.

Purpose: Enable org admins to see engagement levels at a glance, understand the signals behind each classification, and override when they have context the system doesn't (e.g., spoke at a meetup, working on a project offline).

Output: Engagement badge component, override dialog, and integration into member directory table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-engagement-scoring/15-CONTEXT.md
@.planning/phases/15-engagement-scoring/15-01-SUMMARY.md
@src/routes/org/$slug/admin/members.tsx
@convex/orgs/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create engagement badge component</name>
  <files>src/components/engagement/EngagementBadge.tsx</files>
  <action>
Create component that displays engagement level with appropriate styling:

1. Props interface:
```typescript
interface EngagementBadgeProps {
  level: "highly_engaged" | "moderate" | "at_risk" | "new" | "inactive";
  hasOverride?: boolean;
  adminExplanation?: string;
  onClick?: () => void;
}
```

2. Level to display mapping (per CONTEXT.md - subtle, not gamified):
   - highly_engaged: "Active" with green styling (Activity icon)
   - moderate: "Moderate" with blue styling (TrendingUp icon)
   - at_risk: "At Risk" with amber/orange styling (AlertCircle icon) - admin only sees this label
   - new: "New" with purple styling (Sparkles icon)
   - inactive: "Inactive" with gray styling (Clock icon)

3. Use shadcn Badge component with variant based on level
4. Add Tooltip (from shadcn) showing adminExplanation on hover if provided
5. If hasOverride, add small indicator (e.g., asterisk or "Manual" suffix)
6. onClick handler for opening detail/override dialog

Use lucide-react icons: Activity, TrendingUp, AlertCircle, Sparkles, Clock
  </action>
  <verify>Component renders without errors, tooltip shows explanation on hover</verify>
  <done>EngagementBadge component displays level with appropriate color, icon, and tooltip</done>
</task>

<task type="auto">
  <name>Task 2: Create override dialog component</name>
  <files>src/components/engagement/OverrideDialog.tsx, src/components/engagement/OverrideHistory.tsx</files>
  <action>
**OverrideDialog.tsx:**

Create dialog for admin to override engagement level:

1. Props interface:
```typescript
interface OverrideDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  engagementId: Id<"memberEngagement">;
  memberName: string;
  currentLevel: string;
  currentExplanation: string;
  hasOverride: boolean;
  overrideNotes?: string;
}
```

2. Dialog content:
   - Header: "Override Engagement for {memberName}"
   - Current section: Show current level badge + explanation
   - If hasOverride, show "Currently overridden" with existing notes
   - Form:
     - Level select dropdown with all 5 levels
     - Notes textarea (required - per CONTEXT.md)
     - Optional expiration date picker (or "No expiration" default)
   - Actions:
     - "Override" button (primary) - calls overrideEngagement mutation
     - "Clear Override" button (if hasOverride) - calls clearOverride mutation
     - "Cancel" button

3. Use shadcn Dialog, Select, Textarea, Button components
4. Show toast on success/error via sonner

**OverrideHistory.tsx:**

Create component to show override history:

1. Props: `engagementId: Id<"memberEngagement">`
2. Query engagementOverrideHistory by_engagement index
3. Display as simple timeline:
   - Date + action ("Overridden" / "Override cleared")
   - Previous level -> New level
   - Notes
   - Performed by (admin name if available)
4. Use if no history: "No override history"
  </action>
  <verify>Dialog opens, form validates notes as required, mutations fire correctly</verify>
  <done>Override dialog allows admin to set/clear override with required notes, history shows audit trail</done>
</task>

<task type="auto">
  <name>Task 3: Integrate engagement into member directory</name>
  <files>src/routes/org/$slug/admin/members.tsx</files>
  <action>
Update the admin members page to show engagement:

1. Add new query for engagement data:
   - Query `api.engagement.queries.getOrgEngagementForAdmin` with orgId
   - This returns engagement records for all org members

2. Add "Engagement" column to the table header (between "Profile" and "Actions"):
```tsx
<th className="text-left text-sm font-medium text-slate-500 px-4 py-3">
  Engagement
</th>
```

3. Update MemberRow component:
   - Add engagement prop from joined data
   - Render EngagementBadge in new column
   - Add state for override dialog open/close
   - Wire onClick on badge to open dialog

4. Add MemberRowProps update:
```typescript
interface MemberRowProps {
  member: {
    membership: Doc<"orgMemberships">;
    profile: Doc<"profiles"> | null;
    email: string | null;
    completeness: number;
  };
  engagement: {
    _id: Id<"memberEngagement">;
    level: string;
    adminExplanation: string;
    override?: { level: string; notes: string };
  } | null;
  orgId: Id<"organizations">;
  currentMembershipId: Id<"orgMemberships">;
}
```

5. Join engagement data in the parent component:
   - Create a Map from userId to engagement record
   - Pass to each MemberRow

6. Handle null engagement gracefully:
   - Show "Pending" badge if engagement not yet computed
   - This handles new members before first cron run

7. Add OverrideDialog import and render conditionally when dialog state is open

8. Add dropdown menu item "Override Engagement" that opens the dialog (alongside existing promote/demote options)
  </action>
  <verify>Member directory shows engagement column, clicking badge opens dialog, override persists after refresh</verify>
  <done>Member directory displays engagement levels with clickable badges and working override dialog</done>
</task>

</tasks>

<verification>
1. `bun run lint` passes
2. Navigate to /org/{slug}/admin/members as an admin
3. See "Engagement" column with badges for each member
4. Hover badge to see explanation tooltip
5. Click dropdown -> "Override Engagement" opens dialog
6. Submit override with notes -> badge updates, shows "Manual" indicator
7. Clear override -> badge reverts to computed level
8. Refresh page -> override persists
</verification>

<success_criteria>
- Engagement badges display in member directory with appropriate colors
- Tooltips show LLM-generated explanations
- Override dialog requires notes (cannot submit without)
- Override history is preserved and viewable
- UI is subtle and CRM-focused, not gamified
</success_criteria>

<output>
After completion, create `.planning/phases/15-engagement-scoring/15-02-SUMMARY.md`
</output>
