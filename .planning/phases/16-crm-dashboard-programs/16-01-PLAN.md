---
phase: 16-crm-dashboard-programs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/orgs/stats.ts
  - src/components/org/OrgStats.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view stats for different time ranges (7d, 30d, 90d, all)"
    - "Admin can see engagement level distribution in stats"
    - "Admin can see career stage breakdown in stats"
  artifacts:
    - path: "convex/orgs/stats.ts"
      provides: "Enhanced stats query with time range and engagement"
      exports: ["getOrgStats", "getEnhancedOrgStats"]
    - path: "src/components/org/OrgStats.tsx"
      provides: "Enhanced stats visualization with engagement distribution"
  key_links:
    - from: "src/components/org/OrgStats.tsx"
      to: "api.orgs.stats.getEnhancedOrgStats"
      via: "useQuery hook"
      pattern: "useQuery.*getEnhancedOrgStats"
---

<objective>
Enhance org stats backend and UI with time range filtering, engagement distribution, and career breakdown.

Purpose: Org admins need richer community insights beyond basic member counts. Phase 15 introduced engagement scoring - this plan surfaces that data in aggregate form on the admin dashboard.

Output: Enhanced stats query supporting time ranges and engagement/career distributions, plus updated OrgStats component with new visualizations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crm-dashboard-programs/16-CONTEXT.md
@.planning/phases/16-crm-dashboard-programs/16-RESEARCH.md
@convex/orgs/stats.ts
@convex/engagement/queries.ts
@src/components/org/OrgStats.tsx
@src/routes/org/$slug/admin/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance getOrgStats query with time range and distributions</name>
  <files>convex/orgs/stats.ts</files>
  <action>
    Create new `getEnhancedOrgStats` query that extends existing getOrgStats with:

    1. Add `timeRange` argument: `v.optional(v.union(v.literal("7d"), v.literal("30d"), v.literal("90d"), v.literal("all")))`

    2. Add engagement distribution calculation:
       - Query memberEngagement table for org
       - Count members in each level: highly_engaged, moderate, at_risk, new, inactive
       - Also count "pending" (members without engagement record yet)
       - Return as `engagementDistribution` object

    3. Add career stage distribution:
       - For each member's profile, extract `seeking` field
       - Count occurrences of each value
       - Return as `careerDistribution` record

    4. Add event attendance metrics (for the time range):
       - Query attendance table filtered by createdAt >= since
       - Count total responses and attended count
       - Calculate attendance rate percentage
       - Return as `eventMetrics` object

    Keep existing `getOrgStats` for backward compatibility. Use pattern from 16-RESEARCH.md Pattern 3.

    Use `requireOrgAdmin` helper (already exists in file) for auth check.
  </action>
  <verify>
    `bun run lint` passes. Type check with `npx tsc --noEmit` shows no errors in convex/orgs/stats.ts.
  </verify>
  <done>
    New getEnhancedOrgStats query exists and returns timeRange, engagementDistribution, careerDistribution, and eventMetrics alongside existing stats fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OrgStats component with engagement and career visualizations</name>
  <files>src/components/org/OrgStats.tsx</files>
  <action>
    Update OrgStats component to display new distributions:

    1. Update OrgStatsProps interface to accept enhanced stats:
       - Add `engagementDistribution`: object with highly_engaged, moderate, at_risk, new, inactive, pending counts
       - Add `careerDistribution`: Record<string, number>
       - Add `eventMetrics`: object with totalResponses, attendedCount, attendanceRate
       - Add `timeRange`: string (for display)

    2. Create EngagementDistribution card (new section):
       - Show bar for each engagement level using existing CompletenessBar pattern
       - Colors: green=highly_engaged, blue=moderate, amber=at_risk, purple=new, gray=inactive, slate=pending
       - Labels should use friendly names: "Active" not "highly_engaged", per Phase 15 decision

    3. Create CareerDistribution card (new section):
       - Show top career stages similar to skillsDistribution
       - Use horizontal bars with counts

    4. Add EventMetrics summary:
       - Show attendance rate as percentage
       - Show total responses and attended count

    Layout: Change from 2-column to 2x2 grid (4 cards):
    - Row 1: Skills Distribution, Engagement Distribution
    - Row 2: Profile Completeness, Career Breakdown

    Keep component backward compatible - handle case where new fields are undefined.
  </action>
  <verify>
    `bun run lint` passes. Component renders without errors when given both old and new stat shapes.
  </verify>
  <done>
    OrgStats component displays engagement distribution, career breakdown, and event metrics alongside existing visualizations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire enhanced stats to admin dashboard with time range selector</name>
  <files>src/routes/org/$slug/admin/index.tsx</files>
  <action>
    Update admin dashboard to use enhanced stats with time range:

    1. Add time range state: `const [timeRange, setTimeRange] = useState<"7d" | "30d" | "90d" | "all">("30d")`

    2. Switch from `getOrgStats` to `getEnhancedOrgStats` query, passing timeRange argument

    3. Add time range selector UI above stats section:
       - Use shadcn Select component
       - Options: "Last 7 days", "Last 30 days", "Last 90 days", "All time"
       - Position in header area near "Statistics" section

    4. Update OrgStats component props to pass new stats fields

    Import Select, SelectContent, SelectItem, SelectTrigger, SelectValue from ~/components/ui/select.
  </action>
  <verify>
    `bun run lint` passes. Run `bun run dev` and navigate to /org/{slug}/admin - verify time range selector appears and stats update when changed.
  </verify>
  <done>
    Admin dashboard shows time range selector and displays enhanced stats including engagement distribution and career breakdown.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /org/{slug}/admin as an org admin
2. Verify time range selector appears with 4 options (7d, 30d, 90d, all)
3. Verify engagement distribution card shows level counts
4. Verify career breakdown card shows seeking field distribution
5. Verify event metrics appear (attendance rate)
6. Change time range and verify stats update accordingly
7. Verify existing stats (member count, skills, completeness) still display correctly
</verification>

<success_criteria>
- getEnhancedOrgStats query returns engagement and career distributions
- Time range filtering works for event metrics
- OrgStats component displays 4 cards with all distributions
- Admin dashboard has working time range selector
- Backward compatibility maintained with existing getOrgStats
</success_criteria>

<output>
After completion, create `.planning/phases/16-crm-dashboard-programs/16-01-SUMMARY.md`
</output>
