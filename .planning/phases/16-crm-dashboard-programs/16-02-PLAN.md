---
phase: 16-crm-dashboard-programs
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/org/$slug/admin/members.tsx
  - src/components/org/MemberFilters.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can filter members by engagement level'
    - 'Admin can filter members by skills'
    - 'Admin can filter members by join date range'
    - 'Admin can paginate through member list (25 per page)'
    - 'Admin can search by name AND apply filters simultaneously'
  artifacts:
    - path: 'src/components/org/MemberFilters.tsx'
      provides: 'Reusable filter panel component'
      exports: ['MemberFilters', 'MemberFiltersType']
    - path: 'src/routes/org/$slug/admin/members.tsx'
      provides: 'Enhanced member directory with filtering and pagination'
  key_links:
    - from: 'src/routes/org/$slug/admin/members.tsx'
      to: 'src/components/org/MemberFilters.tsx'
      via: 'component import'
      pattern: 'import.*MemberFilters'
---

<objective>
Add comprehensive filtering and pagination to the member directory.

Purpose: CONTEXT.md specifies "comprehensive filtering: engagement level, career stage, skills, location, join date, program participation" and "paginated table with 25-50 members per page". This enables admins to quickly find specific members in larger communities.

Output: Enhanced member directory with filter panel and pagination controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crm-dashboard-programs/16-CONTEXT.md
@.planning/phases/16-crm-dashboard-programs/16-RESEARCH.md
@src/routes/org/$slug/admin/members.tsx
@src/components/engagement/EngagementBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MemberFilters component</name>
  <files>src/components/org/MemberFilters.tsx</files>
  <action>
    Create a new filter panel component following the pattern from 16-RESEARCH.md:

    1. Define MemberFiltersType interface:
       ```typescript
       export interface MemberFiltersType {
         search?: string;
         engagementLevels?: EngagementLevel[];
         skills?: string[];
         locations?: string[];
         joinedAfter?: number;
         joinedBefore?: number;
         directoryVisibility?: "visible" | "hidden" | "all";
       }
       ```

    2. Create MemberFilters component with props:
       - `filters: MemberFiltersType`
       - `onFiltersChange: (filters: MemberFiltersType) => void`
       - `availableSkills: string[]` (for skill filter options)
       - `availableLocations: string[]` (for location filter options)

    3. UI Layout (horizontal flex wrap):
       - Search input with Search icon (already in members.tsx, will move here)
       - Engagement level select (multi-select would be ideal, but start with single select for simplicity)
       - Skills select (single select from available skills)
       - Location select (single select from available locations)
       - Join date range picker (two date inputs: from/to)
       - Directory visibility select (All / Visible only / Hidden only)
       - Clear filters button (appears when any filter is active)

    Use shadcn components: Input, Select, Button, Popover for date picker.
    Import EngagementLevel type from ~/components/engagement/EngagementBadge.

    Style: `className="flex flex-wrap items-center gap-3 p-4 bg-slate-50 rounded-lg mb-6"`

  </action>
  <verify>
    `bun run lint` passes. Component file exists and exports MemberFilters and MemberFiltersType.
  </verify>
  <done>
    MemberFilters component created with search, engagement, skills, location, date range, and visibility filters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement client-side filtering logic in members page</name>
  <files>src/routes/org/$slug/admin/members.tsx</files>
  <action>
    Integrate MemberFilters and implement filtering:

    1. Import MemberFilters component and type

    2. Add filter state: `const [filters, setFilters] = useState<MemberFiltersType>({})`

    3. Extract available skills and locations from members data:
       ```typescript
       const availableSkills = useMemo(() => {
         const skills = new Set<string>();
         members?.forEach(m => m.profile?.skills?.forEach(s => skills.add(s)));
         return Array.from(skills).sort();
       }, [members]);

       const availableLocations = useMemo(() => {
         const locations = new Set<string>();
         members?.forEach(m => {
           if (m.profile?.location) locations.add(m.profile.location);
         });
         return Array.from(locations).sort();
       }, [members]);
       ```

    4. Create filterMembers function (before component, or as useMemo):
       ```typescript
       const filteredMembers = useMemo(() => {
         if (!members) return [];
         return members.filter(member => {
           // Search filter (name, email)
           if (filters.search) {
             const query = filters.search.toLowerCase();
             const name = member.profile?.name?.toLowerCase() ?? "";
             const email = member.email?.toLowerCase() ?? "";
             if (!name.includes(query) && !email.includes(query)) return false;
           }

           // Engagement filter
           if (filters.engagementLevels?.length) {
             const engagement = engagementMap.get(member.membership.userId);
             const level = engagement?.level ?? "new";
             if (!filters.engagementLevels.includes(level)) return false;
           }

           // Skills filter (any match)
           if (filters.skills?.length) {
             const memberSkills = member.profile?.skills ?? [];
             if (!filters.skills.some(s => memberSkills.includes(s))) return false;
           }

           // Location filter
           if (filters.locations?.length) {
             const location = member.profile?.location ?? "";
             if (!filters.locations.includes(location)) return false;
           }

           // Join date range
           if (filters.joinedAfter && member.membership.joinedAt < filters.joinedAfter) {
             return false;
           }
           if (filters.joinedBefore && member.membership.joinedAt > filters.joinedBefore) {
             return false;
           }

           // Directory visibility filter
           if (filters.directoryVisibility && filters.directoryVisibility !== "all") {
             if (member.membership.directoryVisibility !== filters.directoryVisibility) {
               return false;
             }
           }

           return true;
         });
       }, [members, engagementMap, filters]);
       ```

    5. Replace existing search-only filter with new MemberFilters component.
       Remove the standalone search Input and use the one inside MemberFilters.

    6. Update table to use filteredMembers (already does, just verify it works with new filters).

  </action>
  <verify>
    `bun run lint` passes. Run `bun run dev`, navigate to /org/{slug}/admin/members, verify filters appear and work.
  </verify>
  <done>
    Member directory filters by engagement, skills, location, date range, and visibility. All filters combine with search.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pagination to member table</name>
  <files>src/routes/org/$slug/admin/members.tsx</files>
  <action>
    Add pagination with 25 members per page:

    1. Add pagination state:
       ```typescript
       const [page, setPage] = useState(1);
       const pageSize = 25;
       ```

    2. Reset page to 1 when filters change:
       ```typescript
       const handleFiltersChange = (newFilters: MemberFiltersType) => {
         setFilters(newFilters);
         setPage(1);
       };
       ```

    3. Calculate paginated members:
       ```typescript
       const paginatedMembers = useMemo(() => {
         const start = (page - 1) * pageSize;
         return filteredMembers.slice(start, start + pageSize);
       }, [filteredMembers, page]);

       const totalPages = Math.ceil(filteredMembers.length / pageSize);
       ```

    4. Add pagination controls below table:
       ```tsx
       {totalPages > 1 && (
         <div className="flex items-center justify-between px-4 py-3 border-t">
           <div className="text-sm text-slate-500">
             Showing {((page - 1) * pageSize) + 1} to {Math.min(page * pageSize, filteredMembers.length)} of {filteredMembers.length} members
           </div>
           <div className="flex items-center gap-2">
             <Button
               variant="outline"
               size="sm"
               onClick={() => setPage(p => p - 1)}
               disabled={page === 1}
             >
               <ChevronLeft className="size-4" />
               Previous
             </Button>
             <span className="text-sm text-slate-600">
               Page {page} of {totalPages}
             </span>
             <Button
               variant="outline"
               size="sm"
               onClick={() => setPage(p => p + 1)}
               disabled={page === totalPages}
             >
               Next
               <ChevronRight className="size-4" />
             </Button>
           </div>
         </div>
       )}
       ```

    5. Import ChevronLeft, ChevronRight from lucide-react.

    6. Update table to render paginatedMembers instead of filteredMembers.

  </action>
  <verify>
    `bun run lint` passes. With enough test members, pagination controls appear and navigate correctly.
  </verify>
  <done>
    Member table shows 25 members per page with working Previous/Next controls and member count display.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /org/{slug}/admin/members as an org admin
2. Verify filter panel appears with all filter options
3. Test search filter - members filter by name/email
4. Test engagement filter - only selected engagement levels show
5. Test skills filter - only members with selected skill show
6. Test location filter - only members in selected location show
7. Test join date filters - members outside range are hidden
8. Test directory visibility filter - filters by visible/hidden
9. Combine multiple filters - verify they work together
10. Click "Clear" - all filters reset
11. With many members, verify pagination controls appear
12. Navigate between pages - correct members shown
13. Apply filter that reduces count - verify page resets to 1
</verification>

<success_criteria>

- MemberFilters component exists and is reusable
- All filter types work: search, engagement, skills, location, date range, visibility
- Filters combine correctly (AND logic)
- Pagination shows 25 members per page
- Page resets to 1 when filters change
- Clear button resets all filters
  </success_criteria>

<output>
After completion, create `.planning/phases/16-crm-dashboard-programs/16-02-SUMMARY.md`
</output>
