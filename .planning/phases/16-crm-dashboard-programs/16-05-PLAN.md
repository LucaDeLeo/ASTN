---
phase: 16-crm-dashboard-programs
plan: 05
type: execute
wave: 2
depends_on: ["16-03"]
files_modified:
  - src/routes/org/$slug/admin/members/$userId.tsx
  - src/routes/org/$slug/admin/members.tsx
  - src/components/org/ExportButton.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view full member profile page from directory"
    - "Profile page shows privacy-controlled data with visibility indicators"
    - "Profile page shows attendance history with event details"
    - "Profile page shows engagement timeline and override history"
    - "CSV export includes engagement data"
  artifacts:
    - path: "src/routes/org/$slug/admin/members/$userId.tsx"
      provides: "Member profile page route"
    - path: "src/components/org/ExportButton.tsx"
      provides: "Enhanced export with engagement data"
  key_links:
    - from: "src/routes/org/$slug/admin/members/$userId.tsx"
      to: "api.orgs.members.getMemberProfileForAdmin"
      via: "useQuery hook"
      pattern: "useQuery.*getMemberProfileForAdmin"
    - from: "src/routes/org/$slug/admin/members.tsx"
      to: "src/routes/org/$slug/admin/members/$userId.tsx"
      via: "Link navigation"
      pattern: "Link.*to=.*members/\\$userId"
---

<objective>
Create member profile page with attendance/engagement history and enhance CSV export.

Purpose: CONTEXT.md specifies "Full page navigation from directory (not modal or slide-over)" and "Full history view: engagement timeline, all attendance records". This gives admins comprehensive member visibility while respecting privacy settings.

Output: New member profile route, updated directory linking, and enhanced export.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crm-dashboard-programs/16-CONTEXT.md
@.planning/phases/16-crm-dashboard-programs/16-RESEARCH.md
@.planning/phases/16-crm-dashboard-programs/16-03-SUMMARY.md
@src/routes/org/$slug/admin/members.tsx
@src/components/org/ExportButton.tsx
@convex/orgs/members.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create member profile page route</name>
  <files>src/routes/org/$slug/admin/members/$userId.tsx</files>
  <action>
    Create new route file for individual member profile view:

    ```typescript
    import { Link, createFileRoute } from "@tanstack/react-router";
    import { useQuery } from "convex/react";
    import {
      Building2,
      Calendar,
      ChevronLeft,
      Clock,
      Eye,
      EyeOff,
      MapPin,
      Shield,
      Star,
      User,
    } from "lucide-react";
    import { format, formatDistanceToNow } from "date-fns";
    import { api } from "../../../../../../convex/_generated/api";
    import { AuthHeader } from "~/components/layout/auth-header";
    import { EngagementBadge } from "~/components/engagement/EngagementBadge";
    import { Badge } from "~/components/ui/badge";
    import { Button } from "~/components/ui/button";
    import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";
    import { Spinner } from "~/components/ui/spinner";

    export const Route = createFileRoute("/org/$slug/admin/members/$userId")({
      component: MemberProfilePage,
    });

    function MemberProfilePage() {
      const { slug, userId } = Route.useParams();

      const org = useQuery(api.orgs.directory.getOrgBySlug, { slug });
      const membership = useQuery(
        api.orgs.membership.getMembership,
        org ? { orgId: org._id } : "skip"
      );

      const memberProfile = useQuery(
        api.orgs.members.getMemberProfileForAdmin,
        org && membership?.role === "admin"
          ? { orgId: org._id, userId }
          : "skip"
      );

      const attendanceHistory = useQuery(
        api.orgs.members.getMemberAttendanceHistory,
        org && membership?.role === "admin"
          ? { orgId: org._id, userId }
          : "skip"
      );

      const engagementHistory = useQuery(
        api.orgs.members.getMemberEngagementHistory,
        org && membership?.role === "admin"
          ? { orgId: org._id, userId }
          : "skip"
      );

      // Loading state
      if (org === undefined || membership === undefined || memberProfile === undefined) {
        return (
          <div className="min-h-screen bg-slate-50">
            <AuthHeader />
            <main className="container mx-auto px-4 py-8">
              <div className="max-w-4xl mx-auto">
                <div className="animate-pulse space-y-6">
                  <div className="h-8 bg-slate-100 rounded w-1/4" />
                  <div className="h-48 bg-slate-100 rounded-xl" />
                  <div className="h-64 bg-slate-100 rounded-xl" />
                </div>
              </div>
            </main>
          </div>
        );
      }

      // Auth/access checks
      if (org === null) {
        return <NotFound message="Organization not found" />;
      }

      if (!membership || membership.role !== "admin") {
        return <AccessDenied slug={slug} />;
      }

      if (memberProfile === null) {
        return <NotFound message="Member not found" />;
      }

      if (memberProfile.restricted) {
        return (
          <div className="min-h-screen bg-slate-50">
            <AuthHeader />
            <main className="container mx-auto px-4 py-8">
              <div className="max-w-4xl mx-auto">
                <BackButton slug={slug} orgName={org.name} />
                <Card className="mt-6">
                  <CardContent className="py-12 text-center">
                    <EyeOff className="size-12 text-slate-300 mx-auto mb-4" />
                    <h2 className="text-xl font-semibold text-slate-900 mb-2">
                      Profile Hidden
                    </h2>
                    <p className="text-slate-500">
                      This member has chosen to hide their profile from your organization.
                    </p>
                  </CardContent>
                </Card>
              </div>
            </main>
          </div>
        );
      }

      const { profile, email, membership: memberMembership, visibleSections } = memberProfile;

      return (
        <div className="min-h-screen bg-slate-50">
          <AuthHeader />
          <main className="container mx-auto px-4 py-8">
            <div className="max-w-4xl mx-auto">
              <BackButton slug={slug} orgName={org.name} />

              {/* Profile Header */}
              <Card className="mt-6">
                <CardContent className="py-6">
                  <div className="flex items-start gap-6">
                    <div className="size-20 rounded-full bg-slate-100 flex items-center justify-center">
                      <User className="size-10 text-slate-400" />
                    </div>
                    <div className="flex-1">
                      <h1 className="text-2xl font-bold text-slate-900">
                        {profile.name ?? "No name"}
                      </h1>
                      {visibleSections.basicInfo && profile.headline && (
                        <p className="text-lg text-slate-600 mt-1">{profile.headline}</p>
                      )}
                      <div className="flex flex-wrap items-center gap-3 mt-3">
                        {visibleSections.basicInfo && profile.location && (
                          <span className="flex items-center gap-1 text-sm text-slate-500">
                            <MapPin className="size-4" />
                            {profile.location}
                          </span>
                        )}
                        {email && (
                          <span className="text-sm text-slate-500">{email}</span>
                        )}
                        <Badge variant={memberMembership.role === "admin" ? "default" : "secondary"}>
                          {memberMembership.role === "admin" && <Shield className="size-3 mr-1" />}
                          {memberMembership.role}
                        </Badge>
                      </div>
                      <p className="text-sm text-slate-400 mt-2">
                        Joined {format(new Date(memberMembership.joinedAt), "MMMM d, yyyy")}
                      </p>
                    </div>
                    {engagementHistory?.current && (
                      <div className="shrink-0">
                        <EngagementBadge
                          level={engagementHistory.current.level}
                          hasOverride={engagementHistory.current.hasOverride}
                          adminExplanation={engagementHistory.current.adminExplanation}
                        />
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>

              <div className="grid gap-6 mt-6 lg:grid-cols-2">
                {/* Profile Details */}
                <ProfileDetailsCard profile={profile} visibleSections={visibleSections} />

                {/* Engagement Card */}
                <EngagementCard history={engagementHistory} />
              </div>

              {/* Attendance History */}
              <AttendanceHistoryCard history={attendanceHistory} />
            </div>
          </main>
        </div>
      );
    }

    // Helper components defined below the main component...
    function BackButton({ slug, orgName }: { slug: string; orgName: string }) {
      return (
        <div className="flex items-center gap-2 text-slate-500 text-sm">
          <Link
            to="/org/$slug"
            params={{ slug }}
            className="hover:text-slate-700 transition-colors"
          >
            {orgName}
          </Link>
          <span>/</span>
          <Link
            to="/org/$slug/admin/members"
            params={{ slug }}
            className="hover:text-slate-700 transition-colors flex items-center gap-1"
          >
            <ChevronLeft className="size-4" />
            Members
          </Link>
        </div>
      );
    }

    function NotFound({ message }: { message: string }) {
      return (
        <div className="min-h-screen bg-slate-50">
          <AuthHeader />
          <main className="container mx-auto px-4 py-8">
            <div className="max-w-lg mx-auto text-center py-12">
              <Building2 className="size-16 text-slate-300 mx-auto mb-4" />
              <h1 className="text-2xl font-bold text-slate-900 mb-4">{message}</h1>
              <Button asChild>
                <Link to="/">Go Home</Link>
              </Button>
            </div>
          </main>
        </div>
      );
    }

    function AccessDenied({ slug }: { slug: string }) {
      return (
        <div className="min-h-screen bg-slate-50">
          <AuthHeader />
          <main className="container mx-auto px-4 py-8">
            <div className="max-w-lg mx-auto text-center py-12">
              <Shield className="size-16 text-slate-300 mx-auto mb-4" />
              <h1 className="text-2xl font-bold text-slate-900 mb-4">Admin Access Required</h1>
              <Button asChild>
                <Link to="/org/$slug" params={{ slug }}>Back to Organization</Link>
              </Button>
            </div>
          </main>
        </div>
      );
    }

    // ProfileDetailsCard, EngagementCard, AttendanceHistoryCard components
    // See detailed implementation in action...
    ```

    Create helper components in the same file:

    **ProfileDetailsCard**: Shows education, work history, skills, career goals with privacy indicators (Eye/EyeOff icons for visible/hidden sections).

    **EngagementCard**: Shows current engagement level, explanation, signals, and override history timeline.

    **AttendanceHistoryCard**: Table of attendance records with event title, date, status badge, feedback stars.

    Each card should handle empty/null states gracefully with placeholder messages.
  </action>
  <verify>
    `bun run lint` passes. Route file exists and renders without errors at /org/{slug}/admin/members/{userId}.
  </verify>
  <done>
    Member profile page displays privacy-controlled profile data, engagement info, and attendance history.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add link from member directory to profile page</name>
  <files>src/routes/org/$slug/admin/members.tsx</files>
  <action>
    Update MemberRow component to make member name clickable:

    1. Import Link from @tanstack/react-router if not already imported

    2. In MemberRow, wrap the member name in a Link:
       ```tsx
       <td className="px-4 py-3">
         <Link
           to="/org/$slug/admin/members/$userId"
           params={{ slug, userId: member.membership.userId }}
           className="block hover:bg-slate-50 -m-2 p-2 rounded transition-colors"
         >
           <div className="font-medium text-slate-900 hover:text-primary">
             {member.profile?.name || "No name"}
           </div>
           {member.profile?.headline && (
             <div className="text-sm text-slate-500 truncate max-w-[200px]">
               {member.profile.headline}
             </div>
           )}
         </Link>
       </td>
       ```

    3. Pass `slug` to MemberRow component (get from Route.useParams() in parent)

    4. Add "View Profile" option to the actions dropdown menu:
       ```tsx
       <DropdownMenuItem asChild>
         <Link to="/org/$slug/admin/members/$userId" params={{ slug, userId: member.membership.userId }}>
           <User className="size-4 mr-2" />
           View Profile
         </Link>
       </DropdownMenuItem>
       ```

    Import User icon from lucide-react.
  </action>
  <verify>
    `bun run lint` passes. Clicking member name or "View Profile" navigates to /org/{slug}/admin/members/{userId}.
  </verify>
  <done>
    Member directory has clickable names and "View Profile" action linking to member profile page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance CSV export with engagement data</name>
  <files>src/components/org/ExportButton.tsx</files>
  <action>
    Update ExportButton to include engagement data in exports:

    1. Add engagementData prop:
       ```typescript
       interface ExportButtonProps {
         orgId: Id<"organizations">;
         orgSlug: string;
         engagementData?: Array<{
           userId: string;
           level: string;
           hasOverride: boolean;
         }>;
       }
       ```

    2. Update transformMemberForExport to accept engagement map and include:
       - Engagement Level column
       - Override Status column (yes/no)

    3. Add new CSV headers: "Engagement Level", "Has Override"

    4. Update JSON export to include engagement fields

    5. Create helper to map engagement levels to friendly names:
       ```typescript
       const engagementLabels: Record<string, string> = {
         highly_engaged: "Active",
         moderate: "Moderate",
         at_risk: "At Risk",
         new: "New",
         inactive: "Inactive",
       };
       ```

    6. Update ExportButton usage in members.tsx to pass engagementData:
       ```tsx
       <ExportButton
         orgId={org._id}
         orgSlug={slug}
         engagementData={engagementData?.map(e => ({
           userId: e.userId,
           level: e.level,
           hasOverride: e.hasOverride,
         }))}
       />
       ```
  </action>
  <verify>
    `bun run lint` passes. Exported CSV includes Engagement Level and Has Override columns.
  </verify>
  <done>
    CSV and JSON exports include engagement level and override status for each member.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /org/{slug}/admin/members as an org admin
2. Click on a member name - navigates to profile page
3. Verify profile page shows member info with privacy indicators
4. Verify attendance history table shows events attended
5. Verify engagement card shows current level and override history
6. Test with a member who has hidden profile - shows "Profile Hidden" message
7. Export CSV - verify new Engagement columns appear
8. Test "View Profile" action in dropdown menu
</verification>

<success_criteria>
- Member profile page route exists and renders correctly
- Privacy settings respected - hidden sections show indicators
- Attendance history displays with event details
- Engagement timeline shows current state and override history
- Directory links to profile page via name click and action menu
- CSV export includes engagement level and override status
</success_criteria>

<output>
After completion, create `.planning/phases/16-crm-dashboard-programs/16-05-SUMMARY.md`
</output>
