---
phase: 16-crm-dashboard-programs
plan: 06
type: execute
wave: 2
depends_on: ['16-04']
files_modified:
  - src/routes/org/$slug/admin/programs/index.tsx
  - src/routes/org/$slug/admin/programs/$programId.tsx
  - src/components/programs/ProgramCard.tsx
  - src/components/programs/CreateProgramDialog.tsx
  - src/routes/org/$slug/admin/index.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can view list of org programs with status and participant counts'
    - 'Admin can create new programs with type, dates, and enrollment settings'
    - 'Admin can edit program details and status'
    - 'Admin can view and manage program participants'
    - 'Admin can enroll members into programs'
  artifacts:
    - path: 'src/routes/org/$slug/admin/programs/index.tsx'
      provides: 'Programs list page'
    - path: 'src/routes/org/$slug/admin/programs/$programId.tsx'
      provides: 'Program detail/participants page'
    - path: 'src/components/programs/ProgramCard.tsx'
      provides: 'Reusable program card component'
    - path: 'src/components/programs/CreateProgramDialog.tsx'
      provides: 'Program creation/edit dialog'
  key_links:
    - from: 'src/routes/org/$slug/admin/programs/index.tsx'
      to: 'api.programs.getOrgPrograms'
      via: 'useQuery hook'
      pattern: 'useQuery.*getOrgPrograms'
    - from: 'src/routes/org/$slug/admin/index.tsx'
      to: 'src/routes/org/$slug/admin/programs/index.tsx'
      via: 'Link navigation'
      pattern: 'Link.*to=.*admin/programs'
---

<objective>
Create admin UI for managing org-specific programs.

Purpose: CONTEXT.md specifies "Flexible with templates: reading groups, fellowships, mentorship, cohorts - plus custom types" and "Enrollment: configurable per program". This gives orgs the ability to track structured activities and member participation.

Output: Programs list page, program detail page with participant management, and creation dialog.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-crm-dashboard-programs/16-CONTEXT.md
@.planning/phases/16-crm-dashboard-programs/16-RESEARCH.md
@.planning/phases/16-crm-dashboard-programs/16-04-SUMMARY.md
@convex/programs.ts
@src/routes/org/$slug/admin/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProgramCard and CreateProgramDialog components</name>
  <files>src/components/programs/ProgramCard.tsx, src/components/programs/CreateProgramDialog.tsx</files>
  <action>
    Create two component files:

    **src/components/programs/ProgramCard.tsx:**
    ```typescript
    import { Link } from "@tanstack/react-router";
    import { Calendar, Users } from "lucide-react";
    import { format } from "date-fns";
    import type { Doc } from "../../../convex/_generated/dataModel";
    import { Badge } from "~/components/ui/badge";
    import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";

    const statusColors = {
      planning: "bg-slate-100 text-slate-700",
      active: "bg-green-100 text-green-700",
      completed: "bg-blue-100 text-blue-700",
      archived: "bg-slate-50 text-slate-500",
    };

    const typeLabels = {
      reading_group: "Reading Group",
      fellowship: "Fellowship",
      mentorship: "Mentorship",
      cohort: "Cohort",
      workshop_series: "Workshop Series",
      custom: "Custom",
    };

    interface ProgramCardProps {
      program: Doc<"programs"> & { participantCount: number };
      slug: string;
    }

    export function ProgramCard({ program, slug }: ProgramCardProps) {
      return (
        <Link
          to="/org/$slug/admin/programs/$programId"
          params={{ slug, programId: program._id }}
        >
          <Card className="hover:shadow-md transition-shadow cursor-pointer h-full">
            <CardHeader className="pb-2">
              <div className="flex items-start justify-between gap-2">
                <div className="min-w-0">
                  <CardTitle className="text-lg truncate">{program.name}</CardTitle>
                  <p className="text-sm text-slate-500">{typeLabels[program.type]}</p>
                </div>
                <Badge className={statusColors[program.status]}>
                  {program.status}
                </Badge>
              </div>
            </CardHeader>
            <CardContent>
              {program.description && (
                <p className="text-sm text-slate-600 line-clamp-2 mb-3">
                  {program.description}
                </p>
              )}
              <div className="flex items-center justify-between text-sm">
                <div className="flex items-center gap-1 text-slate-500">
                  <Users className="size-4" />
                  {program.participantCount} participant{program.participantCount !== 1 ? "s" : ""}
                </div>
                {program.startDate && (
                  <div className="flex items-center gap-1 text-slate-500">
                    <Calendar className="size-4" />
                    {format(new Date(program.startDate), "MMM d, yyyy")}
                  </div>
                )}
              </div>
              {program.completionCriteria && (
                <div className="mt-2 text-xs text-slate-400">
                  {program.completionCriteria.type === "attendance_count"
                    ? `${program.completionCriteria.requiredCount} sessions required`
                    : program.completionCriteria.type === "attendance_percentage"
                      ? `${program.completionCriteria.requiredPercentage}% attendance required`
                      : "Manual completion"}
                </div>
              )}
            </CardContent>
          </Card>
        </Link>
      );
    }
    ```

    **src/components/programs/CreateProgramDialog.tsx:**
    ```typescript
    import { useState } from "react";
    import { useMutation } from "convex/react";
    import { api } from "../../../convex/_generated/api";
    import type { Id } from "../../../convex/_generated/dataModel";
    import { Button } from "~/components/ui/button";
    import {
      Dialog,
      DialogContent,
      DialogHeader,
      DialogTitle,
      DialogTrigger,
    } from "~/components/ui/dialog";
    import { Input } from "~/components/ui/input";
    import { Label } from "~/components/ui/label";
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from "~/components/ui/select";
    import { Textarea } from "~/components/ui/textarea";
    import { Spinner } from "~/components/ui/spinner";
    import { toast } from "sonner";

    interface CreateProgramDialogProps {
      orgId: Id<"organizations">;
      trigger: React.ReactNode;
      onSuccess?: () => void;
    }

    export function CreateProgramDialog({ orgId, trigger, onSuccess }: CreateProgramDialogProps) {
      const [open, setOpen] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);

      // Form state
      const [name, setName] = useState("");
      const [description, setDescription] = useState("");
      const [type, setType] = useState<"reading_group" | "fellowship" | "mentorship" | "cohort" | "workshop_series" | "custom">("reading_group");
      const [enrollmentMethod, setEnrollmentMethod] = useState<"admin_only" | "self_enroll" | "approval_required">("admin_only");
      const [maxParticipants, setMaxParticipants] = useState("");
      const [completionType, setCompletionType] = useState<"none" | "attendance_count" | "attendance_percentage" | "manual">("none");
      const [requiredCount, setRequiredCount] = useState("");
      const [requiredPercentage, setRequiredPercentage] = useState("");

      const createProgram = useMutation(api.programs.createProgram);

      const resetForm = () => {
        setName("");
        setDescription("");
        setType("reading_group");
        setEnrollmentMethod("admin_only");
        setMaxParticipants("");
        setCompletionType("none");
        setRequiredCount("");
        setRequiredPercentage("");
      };

      const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!name.trim()) {
          toast.error("Program name is required");
          return;
        }

        setIsSubmitting(true);
        try {
          const completionCriteria = completionType !== "none"
            ? {
                type: completionType as "attendance_count" | "attendance_percentage" | "manual",
                requiredCount: completionType === "attendance_count" ? Number(requiredCount) : undefined,
                requiredPercentage: completionType === "attendance_percentage" ? Number(requiredPercentage) : undefined,
              }
            : undefined;

          await createProgram({
            orgId,
            name: name.trim(),
            description: description.trim() || undefined,
            type,
            enrollmentMethod,
            maxParticipants: maxParticipants ? Number(maxParticipants) : undefined,
            completionCriteria,
          });

          toast.success("Program created");
          resetForm();
          setOpen(false);
          onSuccess?.();
        } catch (error) {
          toast.error("Failed to create program");
          console.error(error);
        } finally {
          setIsSubmitting(false);
        }
      };

      return (
        <Dialog open={open} onOpenChange={setOpen}>
          <DialogTrigger asChild>{trigger}</DialogTrigger>
          <DialogContent className="max-w-lg">
            <DialogHeader>
              <DialogTitle>Create Program</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <Label htmlFor="name">Program Name *</Label>
                <Input
                  id="name"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="e.g., AGISF Reading Group - Spring 2026"
                />
              </div>

              <div>
                <Label htmlFor="description">Description</Label>
                <Textarea
                  id="description"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="Brief description of the program..."
                  rows={2}
                />
              </div>

              <div className="grid gap-4 sm:grid-cols-2">
                <div>
                  <Label>Program Type</Label>
                  <Select value={type} onValueChange={(v) => setType(v as typeof type)}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="reading_group">Reading Group</SelectItem>
                      <SelectItem value="fellowship">Fellowship</SelectItem>
                      <SelectItem value="mentorship">Mentorship</SelectItem>
                      <SelectItem value="cohort">Cohort</SelectItem>
                      <SelectItem value="workshop_series">Workshop Series</SelectItem>
                      <SelectItem value="custom">Custom</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Enrollment Method</Label>
                  <Select value={enrollmentMethod} onValueChange={(v) => setEnrollmentMethod(v as typeof enrollmentMethod)}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="admin_only">Admin Only</SelectItem>
                      <SelectItem value="self_enroll">Self Enroll</SelectItem>
                      <SelectItem value="approval_required">Approval Required</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div>
                <Label htmlFor="maxParticipants">Max Participants (optional)</Label>
                <Input
                  id="maxParticipants"
                  type="number"
                  min="1"
                  value={maxParticipants}
                  onChange={(e) => setMaxParticipants(e.target.value)}
                  placeholder="Leave empty for unlimited"
                />
              </div>

              <div>
                <Label>Completion Criteria</Label>
                <Select value={completionType} onValueChange={(v) => setCompletionType(v as typeof completionType)}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">None (no auto-completion)</SelectItem>
                    <SelectItem value="attendance_count">Attendance Count</SelectItem>
                    <SelectItem value="attendance_percentage">Attendance Percentage</SelectItem>
                    <SelectItem value="manual">Manual Only</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {completionType === "attendance_count" && (
                <div>
                  <Label htmlFor="requiredCount">Required Sessions</Label>
                  <Input
                    id="requiredCount"
                    type="number"
                    min="1"
                    value={requiredCount}
                    onChange={(e) => setRequiredCount(e.target.value)}
                    placeholder="e.g., 5"
                  />
                </div>
              )}

              {completionType === "attendance_percentage" && (
                <div>
                  <Label htmlFor="requiredPercentage">Required Percentage</Label>
                  <Input
                    id="requiredPercentage"
                    type="number"
                    min="1"
                    max="100"
                    value={requiredPercentage}
                    onChange={(e) => setRequiredPercentage(e.target.value)}
                    placeholder="e.g., 80"
                  />
                </div>
              )}

              <div className="flex justify-end gap-2 pt-4">
                <Button type="button" variant="outline" onClick={() => setOpen(false)}>
                  Cancel
                </Button>
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? <Spinner className="size-4 mr-2" /> : null}
                  Create Program
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>
      );
    }
    ```

  </action>
  <verify>
    `bun run lint` passes. Both component files exist and export correctly.
  </verify>
  <done>
    ProgramCard displays program info with status badge. CreateProgramDialog handles program creation with all fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create programs list page</name>
  <files>src/routes/org/$slug/admin/programs/index.tsx</files>
  <action>
    Create the programs list page route:

    ```typescript
    import { Link, createFileRoute } from "@tanstack/react-router";
    import { useQuery } from "convex/react";
    import { Building2, FolderPlus, Plus, Shield } from "lucide-react";
    import { useState } from "react";
    import { api } from "../../../../../../convex/_generated/api";
    import { AuthHeader } from "~/components/layout/auth-header";
    import { ProgramCard } from "~/components/programs/ProgramCard";
    import { CreateProgramDialog } from "~/components/programs/CreateProgramDialog";
    import { Button } from "~/components/ui/button";
    import { Card, CardContent } from "~/components/ui/card";
    import {
      Select,
      SelectContent,
      SelectItem,
      SelectTrigger,
      SelectValue,
    } from "~/components/ui/select";
    import { Spinner } from "~/components/ui/spinner";

    export const Route = createFileRoute("/org/$slug/admin/programs/")({
      component: ProgramsListPage,
    });

    function ProgramsListPage() {
      const { slug } = Route.useParams();
      const [statusFilter, setStatusFilter] = useState<string>("all");

      const org = useQuery(api.orgs.directory.getOrgBySlug, { slug });
      const membership = useQuery(
        api.orgs.membership.getMembership,
        org ? { orgId: org._id } : "skip"
      );
      const programs = useQuery(
        api.programs.getOrgPrograms,
        org && membership?.role === "admin"
          ? {
              orgId: org._id,
              status: statusFilter !== "all" ? (statusFilter as "planning" | "active" | "completed" | "archived") : undefined,
            }
          : "skip"
      );

      // Loading
      if (org === undefined || membership === undefined) {
        return (
          <div className="min-h-screen bg-slate-50">
            <AuthHeader />
            <main className="container mx-auto px-4 py-8">
              <div className="max-w-5xl mx-auto">
                <div className="animate-pulse space-y-6">
                  <div className="h-12 bg-slate-100 rounded-xl w-1/3" />
                  <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    {[1, 2, 3].map((i) => (
                      <div key={i} className="h-40 bg-slate-100 rounded-xl" />
                    ))}
                  </div>
                </div>
              </div>
            </main>
          </div>
        );
      }

      if (org === null) {
        return (
          <div className="min-h-screen bg-slate-50">
            <AuthHeader />
            <main className="container mx-auto px-4 py-8">
              <div className="max-w-lg mx-auto text-center py-12">
                <Building2 className="size-16 text-slate-300 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-slate-900 mb-4">Organization Not Found</h1>
                <Button asChild>
                  <Link to="/">Go Home</Link>
                </Button>
              </div>
            </main>
          </div>
        );
      }

      if (!membership || membership.role !== "admin") {
        return (
          <div className="min-h-screen bg-slate-50">
            <AuthHeader />
            <main className="container mx-auto px-4 py-8">
              <div className="max-w-lg mx-auto text-center py-12">
                <Shield className="size-16 text-slate-300 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-slate-900 mb-4">Admin Access Required</h1>
                <Button asChild>
                  <Link to="/org/$slug" params={{ slug }}>Back to Organization</Link>
                </Button>
              </div>
            </main>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-50">
          <AuthHeader />
          <main className="container mx-auto px-4 py-8">
            <div className="max-w-5xl mx-auto">
              {/* Header */}
              <div className="mb-8">
                <div className="flex items-center gap-2 text-slate-500 text-sm mb-2">
                  <Link to="/org/$slug" params={{ slug }} className="hover:text-slate-700 transition-colors">
                    {org.name}
                  </Link>
                  <span>/</span>
                  <Link to="/org/$slug/admin" params={{ slug }} className="hover:text-slate-700 transition-colors">
                    Admin
                  </Link>
                  <span>/</span>
                  <span className="text-slate-700">Programs</span>
                </div>
                <div className="flex items-center justify-between">
                  <div>
                    <h1 className="text-2xl font-bold text-slate-900">Programs</h1>
                    <p className="text-slate-600 mt-1">
                      Manage reading groups, fellowships, and other activities
                    </p>
                  </div>
                  <CreateProgramDialog
                    orgId={org._id}
                    trigger={
                      <Button>
                        <Plus className="size-4 mr-2" />
                        New Program
                      </Button>
                    }
                  />
                </div>
              </div>

              {/* Filters */}
              <div className="flex items-center gap-4 mb-6">
                <Select value={statusFilter} onValueChange={setStatusFilter}>
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="Filter by status" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Programs</SelectItem>
                    <SelectItem value="planning">Planning</SelectItem>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="completed">Completed</SelectItem>
                    <SelectItem value="archived">Archived</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Programs Grid */}
              {programs === undefined ? (
                <div className="flex justify-center py-12">
                  <Spinner className="size-8" />
                </div>
              ) : programs.length === 0 ? (
                <Card>
                  <CardContent className="py-12 text-center">
                    <FolderPlus className="size-12 text-slate-300 mx-auto mb-4" />
                    <h3 className="text-lg font-medium text-slate-900 mb-2">
                      {statusFilter === "all" ? "No programs yet" : `No ${statusFilter} programs`}
                    </h3>
                    <p className="text-slate-500 text-sm mb-4">
                      Create a program to track member participation in activities
                    </p>
                    {statusFilter === "all" && (
                      <CreateProgramDialog
                        orgId={org._id}
                        trigger={
                          <Button>
                            <Plus className="size-4 mr-2" />
                            Create First Program
                          </Button>
                        }
                      />
                    )}
                  </CardContent>
                </Card>
              ) : (
                <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  {programs.map((program) => (
                    <ProgramCard key={program._id} program={program} slug={slug} />
                  ))}
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }
    ```

  </action>
  <verify>
    `bun run lint` passes. Route renders at /org/{slug}/admin/programs/ and shows programs grid.
  </verify>
  <done>
    Programs list page shows all org programs with status filter and create button.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create program detail page with participant management</name>
  <files>src/routes/org/$slug/admin/programs/$programId.tsx, src/routes/org/$slug/admin/index.tsx</files>
  <action>
    Create program detail page and add Programs link to admin dashboard:

    **src/routes/org/$slug/admin/programs/$programId.tsx:**
    - Page layout with program header (name, type, status, dates)
    - Status change dropdown (Planning -> Active -> Completed -> Archived)
    - Participants section with enrolled members table
    - "Add Participant" dialog that searches org members
    - Actions per participant: View profile, Mark complete, Remove
    - Manual attendance counter with increment/decrement
    - Delete program button (archives)

    Key UI elements:
    ```typescript
    // Participant row in table
    <tr>
      <td>{participant.memberName}</td>
      <td><Badge>{participant.status}</Badge></td>
      <td>{participant.manualAttendanceCount ?? 0} sessions</td>
      <td>
        <DropdownMenu>
          // Mark complete, Update attendance, Remove actions
        </DropdownMenu>
      </td>
    </tr>

    // Add participant dialog
    <Dialog>
      <DialogContent>
        <Input placeholder="Search members..." />
        {/* List of org members not already enrolled */}
        {/* Click to enroll */}
      </DialogContent>
    </Dialog>
    ```

    Use existing patterns from members.tsx for table structure.

    **src/routes/org/$slug/admin/index.tsx:**
    Add Programs button to quick actions grid:
    ```tsx
    <Button variant="outline" className="h-auto py-4" asChild>
      <Link to="/org/$slug/admin/programs" params={{ slug }}>
        <FolderPlus className="size-5 mr-2" />
        Programs
      </Link>
    </Button>
    ```

    Import FolderPlus from lucide-react. Add this as a 5th button (may need to adjust grid to sm:grid-cols-5 or wrap to 2 rows).

  </action>
  <verify>
    `bun run lint` passes. Program detail page renders at /org/{slug}/admin/programs/{programId}. Admin dashboard has Programs link.
  </verify>
  <done>
    Program detail page manages participants with enrollment, completion, and attendance tracking. Admin dashboard links to programs.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /org/{slug}/admin as admin - verify "Programs" button appears
2. Click "Programs" - navigates to programs list
3. Click "New Program" - dialog opens with all fields
4. Create a program - appears in list with correct status
5. Click program card - navigates to detail page
6. Change status - updates correctly
7. Add participant - member appears in table
8. Update attendance count - saves correctly
9. Mark participant complete - status changes
10. Remove participant - removed from list
11. Filter programs by status - list updates
</verification>

<success_criteria>

- Programs list page displays all org programs
- Create dialog handles all program fields
- Program detail page shows participants
- Enrollment/unenrollment works correctly
- Manual attendance tracking works
- Status changes persist
- Admin dashboard links to programs
  </success_criteria>

<output>
After completion, create `.planning/phases/16-crm-dashboard-programs/16-06-SUMMARY.md`
</output>
