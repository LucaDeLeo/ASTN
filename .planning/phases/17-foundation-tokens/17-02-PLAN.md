---
phase: 17-foundation-tokens
plan: 02
type: execute
wave: 2
depends_on: ['17-01']
files_modified:
  - src/styles/app.css
  - src/routes/__root.tsx
autonomous: true

must_haves:
  truths:
    - 'Fonts load without FOIT/FOUT (no flash of unstyled or invisible text)'
    - 'Animation easing utilities work (ease-spring produces spring-like motion)'
    - 'Animation keyframes are available (animate-fade-in, animate-slide-up)'
    - 'Reduced motion preference is respected'
  artifacts:
    - path: 'src/routes/__root.tsx'
      provides: 'Font preload links'
      contains: "rel: 'preload'"
    - path: 'src/styles/app.css'
      provides: 'Animation easing tokens'
      contains: '--ease-spring:'
    - path: 'src/styles/app.css'
      provides: 'Animation duration tokens'
      contains: '--duration-normal:'
    - path: 'src/styles/app.css'
      provides: 'Entrance animation keyframes'
      contains: '@keyframes fade-in'
    - path: 'src/styles/app.css'
      provides: 'Reduced motion support'
      contains: 'prefers-reduced-motion'
  key_links:
    - from: 'src/routes/__root.tsx'
      to: '@fontsource packages'
      via: 'woff2?url imports'
      pattern: "@fontsource-variable.*woff2\\?url"
    - from: 'preload links'
      to: 'woff2 font files'
      via: 'href attribute'
      pattern: "rel: 'preload'.*as: 'font'"
    - from: '@theme inline'
      to: 'animation utilities'
      via: '--animate-* naming'
      pattern: '--animate-fade-in|--animate-slide-up'
---

<objective>
Add font preloading infrastructure and define animation tokens for the design system.

Purpose: Ensure fonts load without visual flash (FOIT/FOUT) and establish reusable animation primitives (easing, duration, keyframes) for Phase 19's motion system.
Output: Font preload links in \_\_root.tsx, animation tokens and keyframes in CSS, reduced motion support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-foundation-tokens/17-RESEARCH.md
@.planning/phases/17-foundation-tokens/17-CONTEXT.md
@.planning/phases/17-foundation-tokens/17-01-SUMMARY.md
@src/styles/app.css
@src/routes/__root.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define animation tokens and keyframes</name>
  <files>src/styles/app.css</files>
  <action>
Extend app.css with animation primitives. Add to the :root block and @theme inline block.

1. **Add animation primitives** in :root (with other primitives):

```css
/* Animation timing tokens */
--ease-linear: linear;
--ease-in: cubic-bezier(0.55, 0.055, 0.675, 0.19);
--ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
--ease-in-out: cubic-bezier(0.645, 0.045, 0.355, 1);
--ease-spring: cubic-bezier(
  0.34,
  1.56,
  0.64,
  1
); /* Slight overshoot, organic settle */
--ease-gentle: cubic-bezier(0.25, 0.1, 0.25, 1);

/* Duration tokens - per CONTEXT.md: 200-400ms range */
--duration-fast: 150ms;
--duration-normal: 250ms;
--duration-slow: 400ms;
--duration-slower: 600ms;

/* Transform tokens for hover/press effects */
--scale-press: 0.97;
--scale-hover: 1.02;
```

2. **Add @theme inline extensions** for Tailwind utility generation:

```css
/* Easing utilities - generates ease-spring, ease-gentle, etc. */
--ease-spring: var(--ease-spring);
--ease-gentle: var(--ease-gentle);
--ease-in: var(--ease-in);
--ease-out: var(--ease-out);
--ease-in-out: var(--ease-in-out);

/* Animation definitions - generates animate-fade-in, animate-slide-up, etc. */
--animate-fade-in: fade-in var(--duration-normal) var(--ease-gentle) forwards;
--animate-slide-up: slide-up var(--duration-slow) var(--ease-spring) forwards;
--animate-scale-in: scale-in var(--duration-normal) var(--ease-spring) forwards;
--animate-slide-down: slide-down var(--duration-slow) var(--ease-spring)
  forwards;

@keyframes fade-in {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slide-up {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slide-down {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scale-in {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
```

3. **Add reduced motion support** at the end of the file:

```css
/* Reduced motion: fade only, no movement - per CONTEXT.md */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }

  /* Preserve fade animations for basic feedback */
  .animate-fade-in {
    animation: fade-in 150ms var(--ease-out) forwards !important;
  }
}
```

IMPORTANT:

- Keep existing animations (shake, reveal, pulse-processing) intact
- Add new content, do not remove existing animations
- Keyframes go inside @theme inline block (per Tailwind v4 pattern)
  </action>
  <verify>

1. Check CSS syntax: `bun run dev` - no compilation errors
2. Verify easing token: In devtools, `getComputedStyle(document.documentElement).getPropertyValue('--ease-spring')` returns cubic-bezier value
3. Test animation utility: Temporarily add `animate-fade-in` class to an element, confirm it fades in
4. Test reduced motion: In devtools, toggle "Emulate CSS media feature prefers-reduced-motion" - animations should be instant/disabled
   </verify>
   <done>

- Animation easing tokens defined (--ease-spring, --ease-gentle, etc.)
- Duration tokens defined (--duration-fast through --duration-slower)
- Four entrance animation keyframes defined (fade-in, slide-up, slide-down, scale-in)
- @theme inline generates animate-\* utilities
- Reduced motion media query respects user preferences
- Existing animations (shake, reveal, pulse-processing) still work
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add font preloading to __root.tsx</name>
  <files>src/routes/__root.tsx</files>
  <action>
Add font preload links to eliminate FOIT/FOUT.

1. **Import woff2 font files** at the top of the file (after existing imports):

```tsx
// Font preloads for FOIT/FOUT prevention
import plusJakartaWoff2 from '@fontsource-variable/plus-jakarta-sans/files/plus-jakarta-sans-latin-wght-normal.woff2?url'
import loraWoff2 from '@fontsource-variable/lora/files/lora-latin-wght-normal.woff2?url'
```

Note: The `?url` suffix tells Vite to return the URL to the asset rather than processing it.

2. **Add preload links** in the head() function's links array. Preload links should come BEFORE the stylesheet link:

```tsx
head: () => ({
  meta: [
    // ... existing meta tags
  ],
  links: [
    // Font preloads (MUST come before stylesheet for browser prioritization)
    {
      rel: 'preload',
      href: plusJakartaWoff2,
      as: 'font',
      type: 'font/woff2',
      crossOrigin: 'anonymous'
    },
    {
      rel: 'preload',
      href: loraWoff2,
      as: 'font',
      type: 'font/woff2',
      crossOrigin: 'anonymous'
    },
    // Stylesheet (after preloads)
    { rel: 'stylesheet', href: appCss },
    // ... rest of existing links (Leaflet, favicons, etc.)
  ],
}),
```

CRITICAL:

- `crossOrigin: 'anonymous'` is REQUIRED for font preloads (CORS requirement)
- Preload links MUST appear before the stylesheet link
- Keep all existing links intact, just reorder and add
  </action>
  <verify>

1. Start dev server: `bun run dev`
2. Open browser Network tab, filter by "Font"
3. Verify both woff2 files load with "preload" initiator (not "stylesheet")
4. Hard refresh (Cmd+Shift+R) and watch for text flash - should be none or minimal
5. Check devtools Performance tab for "LCP" - fonts should not block render
6. Verify preload links appear in page source: View Source, search for "preload"
   </verify>
   <done>

- woff2 imports added to \_\_root.tsx
- Preload links added to head() before stylesheet
- Fonts load with preload initiator in Network tab
- No visible FOIT/FOUT on hard refresh
- crossOrigin attribute correctly set
  </done>
  </task>

</tasks>

<verification>
1. Run `bun run dev` - no errors
2. Network tab: Both woff2 files show "preload" as initiator
3. Hard refresh test: No flash of system fonts or invisible text
4. Animation test: Add `animate-slide-up` to any element, observe smooth entrance animation
5. Easing test: Compare `ease-spring` vs `ease-linear` - spring should have slight overshoot
6. Reduced motion test: Enable "Reduce motion" in OS or devtools, animations should be instant
7. Existing features: Verify shake animation on auth error still works (if reachable)
</verification>

<success_criteria>

- Fonts load without FOIT/FOUT (preload links functioning)
- Animation easing tokens generate Tailwind utilities (ease-spring, ease-gentle)
- Animation keyframes available as Tailwind utilities (animate-fade-in, animate-slide-up, animate-scale-in)
- Reduced motion preference respected (animations disable or simplify)
- No regressions to existing animations (shake, reveal, pulse-processing)
- LCP not negatively impacted by font loading
  </success_criteria>

<output>
After completion, create `.planning/phases/17-foundation-tokens/17-02-SUMMARY.md`
</output>
