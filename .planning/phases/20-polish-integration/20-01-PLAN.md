---
phase: 20-polish-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/theme/theme-provider.tsx
  - src/components/theme/theme-toggle.tsx
  - src/styles/app.css
  - src/routes/__root.tsx
  - src/components/layout/auth-header.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between light, dark, and system theme"
    - "Theme preference persists across page reloads"
    - "System preference is respected by default"
    - "Dark mode uses warm coral palette (not inverted gray)"
    - "No flash of incorrect theme on page load"
  artifacts:
    - path: "src/components/theme/theme-provider.tsx"
      provides: "ThemeProvider context and useTheme hook"
      exports: ["ThemeProvider", "useTheme"]
    - path: "src/components/theme/theme-toggle.tsx"
      provides: "Theme toggle dropdown component"
      exports: ["ThemeToggle"]
    - path: "src/styles/app.css"
      provides: "Coral-based dark mode tokens"
      contains: ".dark { --primary: oklch(0.70"
  key_links:
    - from: "src/routes/__root.tsx"
      to: "ThemeProvider"
      via: "wraps children"
      pattern: "<ThemeProvider"
    - from: "src/components/layout/auth-header.tsx"
      to: "ThemeToggle"
      via: "renders in nav"
      pattern: "<ThemeToggle"
---

<objective>
Create the theme system infrastructure for dark mode with an intentional coral-based palette.

Purpose: Enable users to switch between light/dark modes while maintaining the warm coral identity established in v1.3. Dark mode should feel like "soft dark" (charcoal) with preserved coral accents, not just inverted colors.

Output: ThemeProvider context, ThemeToggle component, coral-based dark mode CSS tokens, FOIT prevention script, and theme toggle in header.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-polish-integration/20-CONTEXT.md
@.planning/phases/20-polish-integration/20-RESEARCH.md
@src/styles/app.css
@src/routes/__root.tsx
@src/components/layout/auth-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme components</name>
  <files>
    src/components/theme/theme-provider.tsx
    src/components/theme/theme-toggle.tsx
  </files>
  <action>
Create src/components/theme/ directory with two files:

**theme-provider.tsx:**
- Create ThemeProviderContext with type `{ theme: Theme; setTheme: (theme: Theme) => void }`
- Theme type: `'dark' | 'light' | 'system'`
- ThemeProvider component:
  - Props: children, defaultTheme='system', storageKey='astn-theme'
  - useState initializes from localStorage or defaultTheme
  - useEffect applies theme class to document.documentElement:
    - Remove 'light' and 'dark' classes first
    - If 'system', check matchMedia('(prefers-color-scheme: dark)') and apply result
    - Otherwise apply the theme directly
  - setTheme also writes to localStorage
- Export useTheme hook that throws if used outside provider

**theme-toggle.tsx:**
- Import Moon, Sun, Monitor from lucide-react
- Import Button, DropdownMenu components
- Import useTheme from theme-provider
- ThemeToggle component:
  - DropdownMenu with trigger Button (variant="ghost", size="icon")
  - Trigger shows Sun icon with rotation/scale transition to Moon in dark mode
  - Three menu items: Light (Sun), Dark (Moon), System (Monitor)
  - Each calls setTheme with respective value
  - Include sr-only span "Toggle theme" for accessibility
  </action>
  <verify>Files exist and TypeScript compiles without errors: `bun run lint`</verify>
  <done>ThemeProvider exports context, hook. ThemeToggle exports dropdown component.</done>
</task>

<task type="auto">
  <name>Task 2: Update dark mode CSS tokens</name>
  <files>src/styles/app.css</files>
  <action>
Replace the current `.dark` block (lines ~301-333) with coral-based dark mode palette:

```css
.dark {
  /* Base backgrounds - soft charcoal, not OLED black */
  --background: oklch(0.13 0.005 30);        /* Subtle warm undertone */
  --foreground: oklch(0.93 0.01 90);         /* Warm off-white */

  /* Card/popover - slightly elevated from background */
  --card: oklch(0.17 0.005 30);
  --card-foreground: oklch(0.93 0.01 90);
  --popover: oklch(0.17 0.005 30);
  --popover-foreground: oklch(0.93 0.01 90);

  /* Primary - KEEP coral accent (same as light mode) */
  --primary: oklch(0.70 0.16 30);
  --primary-foreground: oklch(0.13 0.005 30);

  /* Secondary - warm dark gray */
  --secondary: oklch(0.22 0.01 30);
  --secondary-foreground: oklch(0.93 0.01 90);

  /* Muted - for subtle backgrounds */
  --muted: oklch(0.22 0.01 30);
  --muted-foreground: oklch(0.65 0.02 90);

  /* Accent - coral-tinted for hover states */
  --accent: oklch(0.25 0.03 30);
  --accent-foreground: oklch(0.93 0.01 90);

  /* Destructive - brighter in dark mode for visibility */
  --destructive: oklch(0.65 0.20 25);

  /* Borders - subtle warm tint */
  --border: oklch(0.28 0.01 30);
  --input: oklch(0.22 0.01 30);

  /* Ring - coral for focus states */
  --ring: oklch(0.70 0.16 30);

  /* Chart colors - warm-shifted */
  --chart-1: oklch(0.70 0.16 30);
  --chart-2: oklch(0.65 0.10 180);
  --chart-3: oklch(0.75 0.15 75);
  --chart-4: oklch(0.65 0.15 145);
  --chart-5: oklch(0.55 0.18 25);

  /* Sidebar - consistent with card */
  --sidebar: oklch(0.15 0.005 30);
  --sidebar-foreground: oklch(0.93 0.01 90);
  --sidebar-primary: oklch(0.70 0.16 30);
  --sidebar-primary-foreground: oklch(0.13 0.005 30);
  --sidebar-accent: oklch(0.22 0.01 30);
  --sidebar-accent-foreground: oklch(0.93 0.01 90);
  --sidebar-border: oklch(0.28 0.01 30);
  --sidebar-ring: oklch(0.70 0.16 30);

  /* Dark mode shadow tokens - subtle glow instead of drop shadow */
  --shadow-warm-sm: 0 1px 3px oklch(0 0 0 / 0.3), 0 0 8px oklch(0.70 0.08 30 / 0.05);
  --shadow-warm: 0 4px 12px oklch(0 0 0 / 0.4), 0 0 16px oklch(0.70 0.08 30 / 0.08);
  --shadow-warm-md: 0 8px 24px oklch(0 0 0 / 0.5), 0 0 24px oklch(0.70 0.08 30 / 0.10);
  --shadow-warm-lg: 0 12px 40px oklch(0 0 0 / 0.6), 0 0 32px oklch(0.70 0.08 30 / 0.12);
}
```

Key changes from current dark tokens:
- Primary stays coral (oklch(0.70 0.16 30)) instead of becoming gray
- Background uses warm charcoal (0.13 lightness with hue 30) not pure black
- All neutrals have subtle warm undertone (hue 30)
- Shadows get coral glow effect in dark mode
  </action>
  <verify>CSS is valid: `bun run lint` passes. Toggle browser to dark mode and verify tokens apply.</verify>
  <done>Dark mode uses intentional coral palette with warm undertones throughout.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate theme into app</name>
  <files>
    src/routes/__root.tsx
    src/components/layout/auth-header.tsx
  </files>
  <action>
**__root.tsx:**
1. Import ThemeProvider from '~/components/theme/theme-provider'
2. Add inline script to head for FOIT prevention (before stylesheet):
   ```tsx
   {
     tag: 'script',
     children: `(function(){
       try {
         const theme = localStorage.getItem('astn-theme');
         const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
         if (theme === 'dark' || (theme === 'system' && systemDark) || (!theme && systemDark)) {
           document.documentElement.classList.add('dark');
         }
       } catch (e) {}
     })()`,
   }
   ```
   Add this to the head() return object's meta array (or create a scripts array if needed - check TanStack Start docs pattern)
3. Wrap children in RootDocument with ThemeProvider:
   ```tsx
   <ThemeProvider defaultTheme="system" storageKey="astn-theme">
     {children}
     <Toaster ... />
   </ThemeProvider>
   ```

**auth-header.tsx:**
1. Import ThemeToggle from '~/components/theme/theme-toggle'
2. Add ThemeToggle to the nav, before the NotificationBell:
   ```tsx
   <nav className="flex items-center gap-4">
     ...
     <ThemeToggle />
     <Authenticated>
       <NotificationBell />
       ...
     </Authenticated>
   </nav>
   ```
   Note: ThemeToggle should be visible to both authenticated and unauthenticated users.
  </action>
  <verify>
1. `bun run dev` - app loads without hydration errors
2. Click theme toggle - switches between light/dark/system
3. Refresh page - theme persists
4. Hard refresh in dark mode - no flash of light theme
5. Set to System, change OS preference - app follows
  </verify>
  <done>Theme toggle in header, preference persists, no FOIT, system preference respected.</done>
</task>

</tasks>

<verification>
1. **Theme toggle works**: Click toggle in header, theme changes instantly
2. **Persistence**: Set to dark, refresh page - stays dark
3. **System preference**: Set to system, toggle OS dark mode - app follows
4. **No FOIT**: Hard refresh in dark mode - no flash of light theme
5. **Coral preserved**: In dark mode, primary buttons are still coral, not gray
6. **Warm undertones**: Dark backgrounds have subtle warmth, not cold gray
7. **Shadows work**: Cards have subtle coral glow in dark mode
</verification>

<success_criteria>
- Theme toggle visible in header (all users, auth and unauth)
- Three options work: Light, Dark, System
- localStorage stores preference as 'astn-theme'
- No hydration mismatches or console errors
- Dark mode primary color is coral (oklch(0.70 0.16 30))
- Dark mode background is warm charcoal (oklch(0.13 0.005 30))
</success_criteria>

<output>
After completion, create `.planning/phases/20-polish-integration/20-01-SUMMARY.md`
</output>
