---
phase: 25-tauri-mobile-native-features
plan: 04
type: execute
wave: 3
depends_on: ["25-02", "25-03"]
files_modified:
  - src/lib/tauri/auth.ts
  - src/components/auth/login-card.tsx
  - src/router.tsx
  - convex/auth.ts
autonomous: false
user_setup:
  - service: github-oauth
    why: "GitHub OAuth for Tauri deep link redirect"
    env_vars: []
    dashboard_config:
      - task: "Add astn://auth/callback to GitHub OAuth app's callback URLs"
        location: "GitHub > Settings > Developer settings > OAuth Apps > ASTN"
  - service: google-oauth
    why: "Google OAuth for Tauri deep link redirect"
    env_vars: []
    dashboard_config:
      - task: "Add astn://auth/callback to Google OAuth client's authorized redirect URIs"
        location: "Google Cloud Console > APIs & Services > Credentials > OAuth 2.0 Client IDs"

must_haves:
  truths:
    - "User can log in with GitHub OAuth in Tauri app via deep link callback"
    - "User can log in with Google OAuth in Tauri app via deep link callback"
    - "Password login continues to work in Tauri app"
    - "Convex client connects successfully in WebView"
  artifacts:
    - path: "src/lib/tauri/auth.ts"
      provides: "Deep link OAuth handler for Tauri"
      exports: ["initDeepLinkAuth", "handleOAuthCallback"]
      min_lines: 40
    - path: "src/components/auth/login-card.tsx"
      provides: "Login UI with Tauri-aware OAuth flow"
      contains: "isTauri"
  key_links:
    - from: "src/lib/tauri/auth.ts"
      to: "@tauri-apps/plugin-deep-link"
      via: "deep link listener"
      pattern: "onOpenUrl|getCurrent"
    - from: "src/components/auth/login-card.tsx"
      to: "src/lib/tauri/auth.ts"
      via: "OAuth redirect handling"
      pattern: "handleOAuthCallback|initDeepLinkAuth"
---

<objective>
Implement OAuth authentication via deep links for Tauri mobile apps

Purpose: Enable GitHub and Google OAuth login in the Tauri mobile app by handling OAuth redirects through the custom URL scheme (astn://auth/callback) instead of web redirects, which don't work properly in WebViews.

Output: Working OAuth login flow where the system browser opens for auth, then deep links back to the app with the auth code, completing the login process.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-tauri-mobile-native-features/25-RESEARCH.md
@.planning/phases/25-tauri-mobile-native-features/25-01-SUMMARY.md
@.planning/phases/25-tauri-mobile-native-features/25-02-SUMMARY.md
@.planning/phases/25-tauri-mobile-native-features/25-03-SUMMARY.md

@src/lib/platform.ts
@src/components/auth/login-card.tsx
@src/router.tsx
@convex/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deep link auth handler</name>
  <files>src/lib/tauri/auth.ts</files>
  <action>
Create src/lib/tauri/auth.ts with OAuth deep link handling:

```typescript
// src/lib/tauri/auth.ts
// Deep link OAuth handler for Tauri mobile apps

import { isTauri } from '../platform'

type AuthCallback = (params: {
  code: string
  state: string
  provider: 'github' | 'google'
}) => void

let authCallbackHandler: AuthCallback | null = null

/**
 * Initialize deep link listener for OAuth callbacks
 * Call this on app startup before any OAuth flow
 */
export async function initDeepLinkAuth(onCallback: AuthCallback): Promise<void> {
  if (!isTauri()) return

  authCallbackHandler = onCallback

  try {
    const { getCurrent, onOpenUrl } = await import('@tauri-apps/plugin-deep-link')

    // Check if app was launched via deep link (cold start)
    const startUrls = await getCurrent()
    if (startUrls && startUrls.length > 0) {
      handleDeepLinkUrl(startUrls[0])
    }

    // Listen for deep links while app is running (warm start)
    await onOpenUrl((urls) => {
      if (urls.length > 0) {
        handleDeepLinkUrl(urls[0])
      }
    })
  } catch (error) {
    console.error('Failed to initialize deep link auth:', error)
  }
}

/**
 * Parse deep link URL and trigger auth callback
 */
function handleDeepLinkUrl(url: string): void {
  if (!authCallbackHandler) {
    console.warn('Deep link received but no auth callback registered')
    return
  }

  try {
    const parsed = new URL(url)

    // Expected format: astn://auth/callback?code=xxx&state=xxx
    if (parsed.hostname !== 'auth' || parsed.pathname !== '/callback') {
      console.log('Deep link not an auth callback:', url)
      return
    }

    const code = parsed.searchParams.get('code')
    const state = parsed.searchParams.get('state')

    if (!code || !state) {
      console.error('Auth callback missing code or state')
      return
    }

    // Determine provider from state or a custom parameter
    // For now, we'll need to track which provider initiated the flow
    const provider = determineProvider(state)

    authCallbackHandler({ code, state, provider })
  } catch (error) {
    console.error('Failed to parse auth deep link:', error)
  }
}

// Provider tracking - store which provider the OAuth flow was started with
let pendingOAuthProvider: 'github' | 'google' | null = null

export function setPendingOAuthProvider(provider: 'github' | 'google'): void {
  pendingOAuthProvider = provider
}

function determineProvider(state: string): 'github' | 'google' {
  // Return the tracked provider, defaulting to github
  return pendingOAuthProvider || 'github'
}

/**
 * Get the OAuth redirect URL for Tauri (deep link) or web
 */
export function getOAuthRedirectUrl(): string {
  if (isTauri()) {
    return 'astn://auth/callback'
  }
  // Web fallback - use the current origin
  return typeof window !== 'undefined'
    ? `${window.location.origin}/api/auth/callback`
    : '/api/auth/callback'
}

/**
 * Open OAuth provider in system browser (for Tauri)
 * This opens the browser outside the WebView for a proper OAuth flow
 */
export async function openOAuthInBrowser(url: string): Promise<void> {
  if (!isTauri()) {
    // Web: just navigate
    window.location.href = url
    return
  }

  try {
    // Use Tauri shell to open in system browser
    const { open } = await import('@tauri-apps/plugin-shell')
    await open(url)
  } catch (error) {
    // Fallback: try window.open
    console.warn('Failed to open with Tauri shell, falling back to window.open:', error)
    window.open(url, '_blank')
  }
}
```

Note: This requires adding @tauri-apps/plugin-shell. Run:
```bash
bun add @tauri-apps/plugin-shell
```

And add to Cargo.toml:
```toml
tauri-plugin-shell = "2"
```

And update lib.rs:
```rust
.plugin(tauri_plugin_shell::init())
```

And add permission to capabilities/default.json:
```json
"shell:allow-open"
```
  </action>
  <verify>TypeScript compiles without errors for src/lib/tauri/auth.ts</verify>
  <done>Deep link auth handler created with OAuth URL parsing and browser opening</done>
</task>

<task type="auto">
  <name>Task 2: Integrate OAuth deep links into login flow</name>
  <files>
    src/components/auth/login-card.tsx
    src/router.tsx
  </files>
  <action>
First, update src/router.tsx to initialize deep link auth on app start:

```typescript
// Add at the top of getRouter() function, after creating convexQueryClient:
import { initDeepLinkAuth } from '~/lib/tauri/auth'
import { isTauri } from '~/lib/platform'

// Inside getRouter(), after convexQueryClient.connect(queryClient):
if (typeof window !== 'undefined' && isTauri()) {
  // Initialize deep link auth listener
  initDeepLinkAuth(async ({ code, state, provider }) => {
    console.log('OAuth callback received:', { code, state, provider })
    // The auth callback will be handled by Convex auth
    // We need to trigger the signIn flow with the received code
    // This depends on how @convex-dev/auth handles OAuth callbacks
  })
}
```

Now update src/components/auth/login-card.tsx to handle Tauri OAuth differently.

Find the OAuth button handlers (GitHub and Google sign-in) and modify them:

```typescript
// Add imports at the top
import { isTauri } from '~/lib/platform'
import { setPendingOAuthProvider, openOAuthInBrowser, getOAuthRedirectUrl } from '~/lib/tauri/auth'

// In the component, modify the OAuth sign-in handlers:
// For GitHub button onClick:
const handleGitHubSignIn = async () => {
  if (isTauri()) {
    setPendingOAuthProvider('github')
    // Build OAuth URL with our custom redirect
    const redirectUri = encodeURIComponent(getOAuthRedirectUrl())
    // Note: You'll need to get the actual GitHub OAuth client ID from env
    const clientId = import.meta.env.VITE_GITHUB_CLIENT_ID
    if (!clientId) {
      console.error('VITE_GITHUB_CLIENT_ID not set')
      return
    }
    const state = crypto.randomUUID() // Generate state for CSRF protection
    const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}&scope=read:user,user:email`
    await openOAuthInBrowser(authUrl)
  } else {
    // Web: use Convex auth's built-in flow
    await signIn('github')
  }
}

// Similar for Google
const handleGoogleSignIn = async () => {
  if (isTauri()) {
    setPendingOAuthProvider('google')
    const redirectUri = encodeURIComponent(getOAuthRedirectUrl())
    const clientId = import.meta.env.VITE_GOOGLE_CLIENT_ID
    if (!clientId) {
      console.error('VITE_GOOGLE_CLIENT_ID not set')
      return
    }
    const state = crypto.randomUUID()
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&state=${state}&scope=openid%20email%20profile`
    await openOAuthInBrowser(authUrl)
  } else {
    await signIn('google')
  }
}
```

**Important Note:** The Convex auth integration for handling the OAuth code exchange is complex. The @convex-dev/auth library handles this internally for web flows. For Tauri, we may need to:

1. Create a Convex action that exchanges the code for tokens
2. Or configure the OAuth providers to accept the deep link redirect

This is the "Open Question" from research - the exact integration point. For now, implement the client-side flow and we'll verify/adjust in the checkpoint.
  </action>
  <verify>
1. Build compiles without TypeScript errors
2. OAuth buttons exist with isTauri() conditional logic
  </verify>
  <done>Login card handles OAuth differently for Tauri vs web</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>OAuth login flow via deep links for Tauri mobile app</what-built>
  <how-to-verify>
**Before testing, configure OAuth providers:**

1. **GitHub OAuth App:**
   - Go to GitHub > Settings > Developer settings > OAuth Apps
   - Find your ASTN OAuth App (or create one)
   - Add `astn://auth/callback` to Authorization callback URL
   - Note: GitHub allows multiple callback URLs, add this alongside the web URL

2. **Google OAuth Client:**
   - Go to Google Cloud Console > APIs & Services > Credentials
   - Find your OAuth 2.0 Client ID
   - Add `astn://auth/callback` to Authorized redirect URIs
   - You may need to configure "Custom URI scheme" in the client type

3. **Environment Variables:**
   - Ensure VITE_GITHUB_CLIENT_ID is set in .env.local
   - Ensure VITE_GOOGLE_CLIENT_ID is set in .env.local

**Test the flow:**

1. Run `bun tauri ios dev` or `bun tauri android dev`
2. Navigate to the login screen
3. Tap "Continue with GitHub"
4. The system browser should open to GitHub's login page
5. After authorizing, you should be redirected back to the app
6. Check if login completes or if there are errors in the console

**Known Limitations:**
- The OAuth code exchange may not work automatically with Convex auth
- If login doesn't complete, we may need to implement custom token exchange
- Password login should still work as a fallback

**Report:**
- Does the system browser open for OAuth?
- Does the app receive the deep link callback?
- Does login complete successfully?
- Any error messages in the console?
  </how-to-verify>
  <resume-signal>Describe the results of OAuth testing - what worked, what didn't, and any error messages</resume-signal>
</task>

</tasks>

<verification>
1. src/lib/tauri/auth.ts exports initDeepLinkAuth and getOAuthRedirectUrl
2. Login card has conditional OAuth handling for Tauri
3. Deep link listener is initialized in router.tsx
4. OAuth flow opens system browser (not WebView) for authentication
</verification>

<success_criteria>
- Deep link auth handler listens for astn://auth/callback URLs
- OAuth buttons open system browser in Tauri context
- App receives OAuth callback via deep link
- Password login continues to work in both web and Tauri
- User has tested OAuth flow and reported results
</success_criteria>

<output>
After completion, create `.planning/phases/25-tauri-mobile-native-features/25-04-SUMMARY.md`

Note: If OAuth code exchange doesn't work with Convex auth, document the findings and create a follow-up task in STATE.md for custom token exchange implementation.
</output>
