---
phase: 25-tauri-mobile-native-features
plan: 05
type: execute
wave: 4
depends_on: ['25-04']
files_modified:
  - src/lib/tauri/store.ts
  - src/lib/tauri/biometric.ts
  - src/components/auth/biometric-unlock.tsx
  - src/routes/__root.tsx
autonomous: false

must_haves:
  truths:
    - 'Auth tokens persist across app restarts in Tauri'
    - 'User can unlock app with Face ID / Touch ID / fingerprint'
    - 'Biometric unlock is optional and can be disabled'
    - 'Web app continues to work without biometric features'
  artifacts:
    - path: 'src/lib/tauri/store.ts'
      provides: 'Token persistence with Tauri store plugin'
      exports: ['saveAuthTokens', 'getAuthTokens', 'clearAuthTokens']
      min_lines: 30
    - path: 'src/lib/tauri/biometric.ts'
      provides: 'Biometric authentication wrapper'
      exports: ['checkBiometricAvailability', 'authenticateWithBiometric']
      min_lines: 40
    - path: 'src/components/auth/biometric-unlock.tsx'
      provides: 'Biometric unlock UI component'
      min_lines: 50
  key_links:
    - from: 'src/lib/tauri/store.ts'
      to: '@tauri-apps/plugin-store'
      via: 'store API'
      pattern: "load.*autoSave|store\\.set|store\\.get"
    - from: 'src/lib/tauri/biometric.ts'
      to: '@tauri-apps/plugin-biometric'
      via: 'biometric API'
      pattern: 'authenticate|checkStatus'
    - from: 'src/routes/__root.tsx'
      to: 'src/components/auth/biometric-unlock.tsx'
      via: 'app launch check'
      pattern: 'BiometricUnlock'
---

<objective>
Implement secure token storage and biometric authentication for quick app access

Purpose: Store auth tokens securely using Tauri's store plugin so users stay logged in across app restarts. Add optional biometric unlock (Face ID / Touch ID / fingerprint) for quick app access without re-entering credentials.

Output: Persistent auth sessions in Tauri app with optional biometric unlock on app launch.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-tauri-mobile-native-features/25-RESEARCH.md
@.planning/phases/25-tauri-mobile-native-features/25-04-SUMMARY.md

@src/lib/platform.ts
@src/lib/tauri/auth.ts
@src/routes/\_\_root.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create secure token storage utilities</name>
  <files>src/lib/tauri/store.ts</files>
  <action>
Create src/lib/tauri/store.ts for token persistence:

```typescript
// src/lib/tauri/store.ts
// Secure token storage using Tauri store plugin
// Falls back to localStorage for web

import { isTauri } from '../platform'

const AUTH_STORE_FILE = 'auth.json'
const TOKENS_KEY = 'tokens'
const BIOMETRIC_ENABLED_KEY = 'biometricEnabled'

interface AuthTokens {
  accessToken: string
  refreshToken?: string
  expiresAt?: number
}

interface StoreInterface {
  get<T>(key: string): Promise<T | null>
  set<T>(key: string, value: T): Promise<void>
  delete(key: string): Promise<void>
  save(): Promise<void>
}

/**
 * Get the appropriate storage interface (Tauri store or localStorage wrapper)
 */
async function getStore(): Promise<StoreInterface> {
  if (isTauri()) {
    const { load } = await import('@tauri-apps/plugin-store')
    const store = await load(AUTH_STORE_FILE, { autoSave: false })
    return {
      get: async <T>(key: string) => store.get<T>(key),
      set: async <T>(key: string, value: T) => {
        await store.set(key, value)
      },
      delete: async (key: string) => {
        await store.delete(key)
      },
      save: async () => {
        await store.save()
      },
    }
  }

  // Web fallback using localStorage
  return {
    get: async <T>(key: string) => {
      const value = localStorage.getItem(`astn_${key}`)
      return value ? (JSON.parse(value) as T) : null
    },
    set: async <T>(key: string, value: T) => {
      localStorage.setItem(`astn_${key}`, JSON.stringify(value))
    },
    delete: async (key: string) => {
      localStorage.removeItem(`astn_${key}`)
    },
    save: async () => {
      // No-op for localStorage
    },
  }
}

/**
 * Save auth tokens to secure storage
 */
export async function saveAuthTokens(tokens: AuthTokens): Promise<void> {
  const store = await getStore()
  await store.set(TOKENS_KEY, tokens)
  await store.save()
}

/**
 * Get stored auth tokens
 */
export async function getAuthTokens(): Promise<AuthTokens | null> {
  const store = await getStore()
  return store.get<AuthTokens>(TOKENS_KEY)
}

/**
 * Clear auth tokens (logout)
 */
export async function clearAuthTokens(): Promise<void> {
  const store = await getStore()
  await store.delete(TOKENS_KEY)
  await store.save()
}

/**
 * Check if biometric unlock is enabled
 */
export async function isBiometricUnlockEnabled(): Promise<boolean> {
  const store = await getStore()
  const enabled = await store.get<boolean>(BIOMETRIC_ENABLED_KEY)
  return enabled === true
}

/**
 * Enable or disable biometric unlock
 */
export async function setBiometricUnlockEnabled(
  enabled: boolean,
): Promise<void> {
  const store = await getStore()
  await store.set(BIOMETRIC_ENABLED_KEY, enabled)
  await store.save()
}
```

  </action>
  <verify>TypeScript compiles without errors for src/lib/tauri/store.ts</verify>
  <done>Token storage utilities with Tauri store and localStorage fallback</done>
</task>

<task type="auto">
  <name>Task 2: Create biometric authentication wrapper</name>
  <files>src/lib/tauri/biometric.ts</files>
  <action>
Create src/lib/tauri/biometric.ts:

```typescript
// src/lib/tauri/biometric.ts
// Biometric authentication wrapper for Face ID / Touch ID / Fingerprint

import { isTauri } from '../platform'

export interface BiometricStatus {
  isAvailable: boolean
  biometryType: 'faceId' | 'touchId' | 'fingerprint' | 'none'
  error?: string
}

/**
 * Check if biometric authentication is available on this device
 */
export async function checkBiometricAvailability(): Promise<BiometricStatus> {
  if (!isTauri()) {
    return {
      isAvailable: false,
      biometryType: 'none',
      error: 'Not running in Tauri',
    }
  }

  try {
    const { checkStatus } = await import('@tauri-apps/plugin-biometric')
    const status = await checkStatus()

    if (!status.isAvailable) {
      return {
        isAvailable: false,
        biometryType: 'none',
        error: status.error || 'Biometrics not available',
      }
    }

    // Determine biometry type based on platform and status
    let biometryType: BiometricStatus['biometryType'] = 'fingerprint'

    // The biometric plugin provides biometryType in status
    if ('biometryType' in status) {
      const type = (status as any).biometryType
      if (type === 'faceId' || type === 'FaceID') biometryType = 'faceId'
      else if (type === 'touchId' || type === 'TouchID')
        biometryType = 'touchId'
      else biometryType = 'fingerprint'
    }

    return {
      isAvailable: true,
      biometryType,
    }
  } catch (error) {
    return {
      isAvailable: false,
      biometryType: 'none',
      error: error instanceof Error ? error.message : 'Unknown error',
    }
  }
}

/**
 * Prompt user for biometric authentication
 * @returns true if authentication succeeded, false otherwise
 */
export async function authenticateWithBiometric(
  reason: string = 'Unlock ASTN',
): Promise<boolean> {
  if (!isTauri()) {
    return false
  }

  try {
    const { authenticate } = await import('@tauri-apps/plugin-biometric')

    await authenticate(reason, {
      title: 'Authenticate',
      subtitle: 'Verify your identity to access ASTN',
      allowDeviceCredential: true, // Allow PIN/password fallback
      confirmationRequired: false, // Don't require explicit confirmation after biometric
    })

    return true
  } catch (error) {
    console.error('Biometric authentication failed:', error)
    return false
  }
}

/**
 * Get user-friendly name for biometry type
 */
export function getBiometryDisplayName(
  type: BiometricStatus['biometryType'],
): string {
  switch (type) {
    case 'faceId':
      return 'Face ID'
    case 'touchId':
      return 'Touch ID'
    case 'fingerprint':
      return 'Fingerprint'
    default:
      return 'Biometric'
  }
}
```

  </action>
  <verify>TypeScript compiles without errors for src/lib/tauri/biometric.ts</verify>
  <done>Biometric authentication wrapper with availability check and auth prompt</done>
</task>

<task type="auto">
  <name>Task 3: Create biometric unlock UI and integrate into app</name>
  <files>
    src/components/auth/biometric-unlock.tsx
    src/routes/__root.tsx
  </files>
  <action>
Create src/components/auth/biometric-unlock.tsx:

```typescript
// src/components/auth/biometric-unlock.tsx
// Biometric unlock screen shown on app launch (Tauri only)

import { useEffect, useState } from 'react'
import { isTauri } from '~/lib/platform'
import {
  checkBiometricAvailability,
  authenticateWithBiometric,
  getBiometryDisplayName,
  BiometricStatus,
} from '~/lib/tauri/biometric'
import { isBiometricUnlockEnabled, getAuthTokens } from '~/lib/tauri/store'
import { Button } from '~/components/ui/button'
import { Fingerprint, Scan, Lock } from 'lucide-react'

interface BiometricUnlockProps {
  onUnlocked: () => void
  onSkip: () => void
}

export function BiometricUnlock({ onUnlocked, onSkip }: BiometricUnlockProps) {
  const [status, setStatus] = useState<BiometricStatus | null>(null)
  const [isAuthenticating, setIsAuthenticating] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    checkBiometricAvailability().then(setStatus)
  }, [])

  const handleAuthenticate = async () => {
    setIsAuthenticating(true)
    setError(null)

    const success = await authenticateWithBiometric('Unlock ASTN')

    setIsAuthenticating(false)

    if (success) {
      onUnlocked()
    } else {
      setError('Authentication failed. Try again or use password.')
    }
  }

  // Auto-prompt on mount if biometrics available
  useEffect(() => {
    if (status?.isAvailable && !isAuthenticating) {
      handleAuthenticate()
    }
  }, [status?.isAvailable])

  const BiometricIcon = status?.biometryType === 'faceId' ? Scan : Fingerprint

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-background">
      <div className="text-center space-y-6 max-w-sm">
        {/* App logo placeholder */}
        <div className="mx-auto w-20 h-20 rounded-2xl bg-primary/10 flex items-center justify-center">
          <Lock className="w-10 h-10 text-primary" />
        </div>

        <div className="space-y-2">
          <h1 className="text-2xl font-display font-semibold">Welcome back</h1>
          <p className="text-muted-foreground">
            {status?.isAvailable
              ? `Use ${getBiometryDisplayName(status.biometryType)} to unlock`
              : 'Tap below to unlock ASTN'}
          </p>
        </div>

        {error && (
          <p className="text-sm text-destructive">{error}</p>
        )}

        <div className="space-y-3">
          {status?.isAvailable && (
            <Button
              onClick={handleAuthenticate}
              disabled={isAuthenticating}
              size="lg"
              className="w-full gap-2"
            >
              <BiometricIcon className="w-5 h-5" />
              {isAuthenticating
                ? 'Authenticating...'
                : `Unlock with ${getBiometryDisplayName(status.biometryType)}`}
            </Button>
          )}

          <Button
            variant="ghost"
            onClick={onSkip}
            className="w-full"
          >
            Use password instead
          </Button>
        </div>
      </div>
    </div>
  )
}

/**
 * Hook to manage biometric unlock state on app launch
 */
export function useBiometricUnlock() {
  const [needsUnlock, setNeedsUnlock] = useState(false)
  const [isChecking, setIsChecking] = useState(true)

  useEffect(() => {
    async function checkUnlockNeeded() {
      if (!isTauri()) {
        setIsChecking(false)
        return
      }

      // Check if biometric is enabled and user has stored tokens
      const [biometricEnabled, tokens] = await Promise.all([
        isBiometricUnlockEnabled(),
        getAuthTokens(),
      ])

      // Only show biometric unlock if enabled AND user has stored tokens
      if (biometricEnabled && tokens) {
        setNeedsUnlock(true)
      }

      setIsChecking(false)
    }

    checkUnlockNeeded()
  }, [])

  const handleUnlocked = () => setNeedsUnlock(false)
  const handleSkip = () => setNeedsUnlock(false)

  return {
    needsUnlock,
    isChecking,
    handleUnlocked,
    handleSkip,
  }
}
```

Now integrate into src/routes/\_\_root.tsx. Add the biometric unlock layer at the root:

Find the component export and wrap the children with the biometric check:

```typescript
// Add imports at the top
import { BiometricUnlock, useBiometricUnlock } from '~/components/auth/biometric-unlock'

// Inside the root component, add biometric unlock check:
function RootComponent() {
  const { needsUnlock, isChecking, handleUnlocked, handleSkip } = useBiometricUnlock()

  // Show loading while checking biometric status
  if (isChecking) {
    return <div className="min-h-screen bg-background" /> // Brief blank screen
  }

  // Show biometric unlock if needed
  if (needsUnlock) {
    return <BiometricUnlock onUnlocked={handleUnlocked} onSkip={handleSkip} />
  }

  // Render normal app content
  return (
    // ... existing root layout
  )
}
```

Note: The exact integration depends on the current \_\_root.tsx structure. Wrap the main content, not the entire router.
</action>
<verify>

1. Build compiles without TypeScript errors
2. BiometricUnlock component renders correctly (can test in web mode, will show "Use password instead" only)
   </verify>
   <done>Biometric unlock UI integrated at app root for Tauri launch</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Secure token storage and biometric unlock for Tauri app</what-built>
  <how-to-verify>
**Test secure storage:**

1. Run the app in simulator/emulator: `bun tauri ios dev` or `bun tauri android dev`
2. Log in with any method (password is fine)
3. Force quit the app (swipe up to close)
4. Reopen the app
5. You should still be logged in (tokens persisted)

**Test biometric unlock:**

1. First, enable biometric unlock (need to add a toggle in settings - for now, manually test):
   - In the app console, run: `await import('~/lib/tauri/store').then(m => m.setBiometricUnlockEnabled(true))`

2. Force quit and reopen the app

3. **iOS:** You should see the Face ID / Touch ID prompt
4. **Android:** You should see the fingerprint/face unlock prompt

5. Authenticate with biometrics - app should unlock

6. Test failure: Cancel biometric prompt, then tap "Use password instead"

**Report:**

- Do tokens persist across app restarts?
- Does biometric prompt appear on launch (after enabling)?
- Does biometric authentication succeed?
- Does "Use password instead" work as fallback?
  </how-to-verify>
  <resume-signal>Describe the results of storage and biometric testing</resume-signal>
  </task>

</tasks>

<verification>
1. src/lib/tauri/store.ts exports saveAuthTokens, getAuthTokens, clearAuthTokens
2. src/lib/tauri/biometric.ts exports checkBiometricAvailability, authenticateWithBiometric
3. BiometricUnlock component integrates at app root
4. Tokens persist across app restarts in Tauri
5. Biometric prompt shows on launch when enabled
</verification>

<success_criteria>

- Auth tokens persist securely via Tauri store plugin
- Biometric status check correctly identifies device capabilities
- Biometric authentication prompts Face ID / Touch ID / fingerprint
- Biometric unlock is optional (can use password fallback)
- Web app continues to work without biometric features
- User has verified storage and biometric flows
  </success_criteria>

<output>
After completion, create `.planning/phases/25-tauri-mobile-native-features/25-05-SUMMARY.md`
</output>
