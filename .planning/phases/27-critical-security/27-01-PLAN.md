---
phase: 27-critical-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/lib/auth.ts
  - convex/enrichment/conversation.ts
  - convex/enrichment/queries.ts
  - convex/enrichment/extraction.ts
  - convex/admin.ts
  - convex/profiles.ts
  - convex/opportunities.ts
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user calling sendMessage receives 'Not authenticated' error"
    - "Unauthenticated user calling getMessagesPublic receives empty array, not other users' messages"
    - "Unauthenticated user calling extractFromConversation receives 'Not authenticated' error"
    - "Authenticated user calling sendMessage with someone else's profileId receives 'Not authorized' error"
    - "Unauthenticated user calling createOpportunity/updateOpportunity/deleteOpportunity/archiveOpportunity receives an error"
    - "Non-admin authenticated user calling opportunity CRUD receives 'Admin access required' error"
    - "Unauthenticated user calling listAll (admin opportunities query) receives empty array"
    - "getCompleteness(profileId) no longer exposes data without auth (deprecated or auth-gated)"
  artifacts:
    - path: "convex/lib/auth.ts"
      provides: "Shared requireAuth helper"
      exports: ["requireAuth"]
    - path: "convex/enrichment/conversation.ts"
      provides: "Auth-gated sendMessage action"
      contains: "requireAuth"
    - path: "convex/enrichment/queries.ts"
      provides: "Auth-gated getMessagesPublic query"
      contains: "auth.getUserId"
    - path: "convex/enrichment/extraction.ts"
      provides: "Auth-gated extractFromConversation action with profileId arg"
      contains: "requireAuth"
    - path: "convex/admin.ts"
      provides: "Auth-gated opportunity CRUD with orgId parameter"
      contains: "requireOrgAdmin"
    - path: "convex/profiles.ts"
      provides: "Deprecated getCompleteness or auth-gated version"
      contains: "getMyCompleteness"
    - path: "convex/opportunities.ts"
      provides: "Auth-gated listAll query"
      contains: "requireOrgAdmin"
  key_links:
    - from: "convex/enrichment/conversation.ts"
      to: "convex/lib/auth.ts"
      via: "import requireAuth"
      pattern: "import.*requireAuth.*from.*lib/auth"
    - from: "convex/enrichment/conversation.ts"
      to: "internal.enrichment.queries.getProfileInternal"
      via: "ctx.runQuery for ownership check"
      pattern: "profile\\.userId !== userId"
    - from: "convex/admin.ts"
      to: "requireOrgAdmin helper"
      via: "admin auth check on all 4 mutations"
      pattern: "requireOrgAdmin.*ctx.*orgId"
---

<objective>
Add authentication and authorization checks to all unprotected endpoints: enrichment endpoints (sendMessage, getMessagesPublic, extractFromConversation), opportunity admin CRUD (create/update/delete/archive), admin listAll query, and deprecate the unprotected getCompleteness query.

Purpose: Close the three highest-severity auth gaps in the codebase -- unauthenticated enrichment endpoints that expose LLM access, unprotected opportunity CRUD that allows anyone to modify the database, and a public query that leaks profile data.

Output: A shared `requireAuth` helper in `convex/lib/auth.ts`, auth + ownership checks on all enrichment endpoints, admin auth on all opportunity CRUD, and deprecation of `getCompleteness`.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-critical-security/27-CONTEXT.md
@.planning/phases/27-critical-security/27-RESEARCH.md

Key source files to read before starting:
@convex/auth.ts (auth.getUserId pattern)
@convex/orgs/admin.ts (requireOrgAdmin pattern to replicate for admin.ts)
@convex/enrichment/conversation.ts (sendMessage -- add auth)
@convex/enrichment/queries.ts (getMessagesPublic -- add auth, getProfileInternal -- already internal)
@convex/enrichment/extraction.ts (extractFromConversation -- add auth + profileId arg)
@convex/admin.ts (opportunity CRUD -- add admin auth)
@convex/profiles.ts (getCompleteness -- deprecate)
@convex/opportunities.ts (listAll -- add admin auth)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create requireAuth helper and harden enrichment endpoints</name>
  <files>convex/lib/auth.ts, convex/enrichment/conversation.ts, convex/enrichment/queries.ts, convex/enrichment/extraction.ts</files>
  <action>
1. Create `convex/lib/auth.ts` with a `requireAuth` helper:
   - Import `auth` from `../auth`
   - Import `QueryCtx`, `MutationCtx`, `ActionCtx` types from `../_generated/server`
   - Function calls `auth.getUserId(ctx)`, throws `new Error("Not authenticated")` if null, returns userId string
   - Export the function

2. Modify `convex/enrichment/conversation.ts` (sendMessage action):
   - Add import: `import { requireAuth } from "../lib/auth"`
   - At the start of the handler (before any existing logic), add:
     ```
     const userId = await requireAuth(ctx);
     ```
   - After fetching the profile via `ctx.runQuery(internal.enrichment.queries.getProfileInternal, { profileId })` (which already happens on line 62-65), add ownership check:
     ```
     if (!profile || profile.userId !== userId) {
       throw new Error("Not authorized");
     }
     ```
   - The profile fetch already exists -- just add the ownership check after it
   - Do NOT change the message saving, LLM call, or return logic

3. Modify `convex/enrichment/queries.ts` (getMessagesPublic query):
   - Add import: `import { auth } from "../auth"`
   - At the start of the handler, add auth + ownership check that returns `[]` (not throws):
     ```
     const userId = await auth.getUserId(ctx);
     if (!userId) return [];
     const profile = await ctx.db.get(profileId);
     if (!profile || profile.userId !== userId) return [];
     ```
   - Keep the existing query logic after the check
   - IMPORTANT: Return empty array for unauthenticated/unauthorized, do NOT throw. Frontend uses `?? []` fallback.

4. Modify `convex/enrichment/extraction.ts` (extractFromConversation action):
   - Add import: `import { requireAuth } from "../lib/auth"`
   - Add import: `import { internal } from "../_generated/api"` (if not already present)
   - Add `profileId: v.id("profiles")` to the args object (alongside existing `messages` arg)
   - In handler, add auth + ownership check at the start:
     ```
     const userId = await requireAuth(ctx);
     // Actions can't use ctx.db directly, use runQuery
     const profile = await ctx.runQuery(internal.enrichment.queries.getProfileInternal, { profileId });
     if (!profile || profile.userId !== userId) {
       throw new Error("Not authorized");
     }
     ```
   - Note: the handler first arg is `ctx` not `_` -- update the destructured param from `_` to `ctx`
   - Keep all existing LLM extraction logic unchanged
   - The frontend hook (useEnrichment.ts) will need to pass profileId when calling this action -- search for callers with `grep -r "extractFromConversation" src/` and update them to include `profileId`. The hook already has access to profileId.
  </action>
  <verify>
Run `npx convex dev --once` (or equivalent typecheck) to verify all files compile without errors. Specifically check:
- `convex/lib/auth.ts` exports `requireAuth`
- `convex/enrichment/conversation.ts` compiles with new auth import
- `convex/enrichment/queries.ts` compiles with auth check
- `convex/enrichment/extraction.ts` compiles with new profileId arg and auth
- Search for all callers of `extractFromConversation` and verify they pass profileId
  </verify>
  <done>
- sendMessage throws "Not authenticated" for unauthenticated users and "Not authorized" for wrong-profile access
- getMessagesPublic returns [] for unauthenticated or unauthorized users
- extractFromConversation requires profileId arg and throws for unauthenticated/unauthorized
- All frontend callers of extractFromConversation updated to pass profileId
  </done>
</task>

<task type="auto">
  <name>Task 2: Add admin auth to opportunity CRUD, deprecate getCompleteness, gate listAll</name>
  <files>convex/admin.ts, convex/profiles.ts, convex/opportunities.ts</files>
  <action>
1. Modify `convex/admin.ts` -- add admin auth to all four mutations:
   - Add imports: `import { auth } from "./auth"` and `import type { MutationCtx } from "./_generated/server"` and `import type { Doc, Id } from "./_generated/dataModel"`
   - Add a local `requireOrgAdmin` helper (same pattern as `convex/orgs/admin.ts` lines 8-31):
     ```typescript
     async function requireOrgAdmin(
       ctx: MutationCtx,
       orgId: Id<"organizations">
     ): Promise<Doc<"orgMemberships">> {
       const userId = await auth.getUserId(ctx);
       if (!userId) throw new Error("Not authenticated");
       const membership = await ctx.db
         .query("orgMemberships")
         .withIndex("by_user", (q) => q.eq("userId", userId))
         .filter((q) => q.eq(q.field("orgId"), orgId))
         .first();
       if (!membership) throw new Error("Not a member of this organization");
       if (membership.role !== "admin") throw new Error("Admin access required");
       return membership;
     }
     ```
   - For `createOpportunity`: Add `orgId: v.id("organizations")` to args. Call `await requireOrgAdmin(ctx, args.orgId)` at start of handler. Destructure orgId out before spreading: `const { orgId, ...opportunityData } = args;` then use `opportunityData` in the insert.
   - For `updateOpportunity`: Add `orgId: v.id("organizations")` to args. Call `await requireOrgAdmin(ctx, args.orgId)` at start of handler. Exclude orgId from the update spread.
   - For `deleteOpportunity`: Add `orgId: v.id("organizations")` to args. Call `await requireOrgAdmin(ctx, args.orgId)` at start of handler.
   - For `archiveOpportunity`: Add `orgId: v.id("organizations")` to args. Call `await requireOrgAdmin(ctx, args.orgId)` at start of handler.
   - Search for all frontend callers of these mutations (`grep -r "createOpportunity\|updateOpportunity\|deleteOpportunity\|archiveOpportunity" src/`) and update them to pass `orgId`. The admin UI components should already have org context available.

2. Modify `convex/profiles.ts` -- deprecate `getCompleteness`:
   - Add a JSDoc deprecation comment: `/** @deprecated Use getMyCompleteness instead. This endpoint will be removed. */`
   - Add auth check: at start of handler, call `const userId = await auth.getUserId(ctx)`. If not authenticated, return null.
   - Add ownership check: after fetching profile, verify `profile.userId === userId`. If not, return null.
   - Keep `getMyCompleteness` unchanged (already properly auth-gated).
   - Search for frontend callers of `getCompleteness` (not `getMyCompleteness`) and replace with `getMyCompleteness` if found: `grep -r "getCompleteness" src/ --include="*.ts" --include="*.tsx"`

3. Modify `convex/opportunities.ts` -- gate `listAll`:
   - Add imports: `import { auth } from "./auth"` and `import type { Id } from "./_generated/dataModel"`
   - Add `orgId: v.id("organizations")` to listAll args
   - Add admin auth check at start of handler (inline or local helper):
     ```typescript
     const userId = await auth.getUserId(ctx);
     if (!userId) return [];
     const membership = await ctx.db
       .query("orgMemberships")
       .withIndex("by_user", (q) => q.eq("userId", userId))
       .filter((q) => q.eq(q.field("orgId"), args.orgId))
       .first();
     if (!membership || membership.role !== "admin") return [];
     ```
   - Return empty array for unauthenticated/non-admin (it's a query, not a mutation -- graceful degradation)
   - Search for frontend callers of `listAll` and update them to pass orgId: `grep -r "listAll" src/`
  </action>
  <verify>
Run `npx convex dev --once` to verify all files compile. Check:
- `convex/admin.ts` compiles with orgId args and requireOrgAdmin
- `convex/profiles.ts` compiles with auth check on getCompleteness
- `convex/opportunities.ts` compiles with admin check on listAll
- All frontend callers updated to pass new orgId arguments
- No TypeScript errors from changed function signatures
  </verify>
  <done>
- All four opportunity CRUD mutations require authenticated org admin with orgId parameter
- getCompleteness is deprecated and auth-gated (returns null for unauthenticated/unauthorized)
- listAll requires admin auth and orgId parameter (returns [] for non-admin)
- All frontend callers updated to pass orgId where required
- `npx convex dev --once` passes with zero type errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript compilation: `npx convex dev --once` succeeds with no errors
2. Build check: `bun run build` completes successfully
3. Auth coverage audit: Every public endpoint in the modified files has an auth check:
   - `convex/enrichment/conversation.ts:sendMessage` -- requireAuth + ownership
   - `convex/enrichment/queries.ts:getMessagesPublic` -- auth + ownership (returns [])
   - `convex/enrichment/extraction.ts:extractFromConversation` -- requireAuth + ownership
   - `convex/admin.ts:createOpportunity` -- requireOrgAdmin
   - `convex/admin.ts:updateOpportunity` -- requireOrgAdmin
   - `convex/admin.ts:deleteOpportunity` -- requireOrgAdmin
   - `convex/admin.ts:archiveOpportunity` -- requireOrgAdmin
   - `convex/profiles.ts:getCompleteness` -- auth + ownership (returns null)
   - `convex/opportunities.ts:listAll` -- admin auth (returns [])
</verification>

<success_criteria>
- requireAuth helper exists at convex/lib/auth.ts and is used by enrichment endpoints
- All 9 previously-unprotected endpoints now have authentication checks
- Enrichment endpoints verify profile ownership (user can only access their own data)
- Opportunity CRUD requires org admin role
- getCompleteness is deprecated with auth fallback
- Zero TypeScript compilation errors
- All frontend callers updated to match new function signatures
</success_criteria>

<output>
After completion, create `.planning/phases/27-critical-security/27-01-SUMMARY.md`
</output>
