---
phase: 27-critical-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/lib/auth.ts
  - convex/enrichment/conversation.ts
  - convex/enrichment/queries.ts
  - convex/enrichment/extraction.ts
  - src/components/profile/enrichment/hooks/useEnrichment.ts
  - convex/admin.ts
  - convex/profiles.ts
  - convex/opportunities.ts
  - src/routes/admin/opportunities/index.tsx
  - src/components/admin/opportunity-form.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user calling sendMessage receives 'Not authenticated' error"
    - "Unauthenticated user calling getMessagesPublic receives empty array, not other users' messages"
    - "Unauthenticated user calling extractFromConversation receives 'Not authenticated' error"
    - "Authenticated user calling sendMessage with someone else's profileId receives 'Not authorized' error"
    - "Unauthenticated user calling createOpportunity/updateOpportunity/deleteOpportunity/archiveOpportunity receives an error"
    - "Non-admin authenticated user calling opportunity CRUD receives 'Admin access required' error"
    - "Unauthenticated user calling listAll (admin opportunities query) receives empty array"
    - "getCompleteness(profileId) no longer exposes data without auth (deprecated or auth-gated)"
  artifacts:
    - path: "convex/lib/auth.ts"
      provides: "Shared requireAuth and requireAnyOrgAdmin helpers"
      exports: ["requireAuth", "requireAnyOrgAdmin"]
    - path: "convex/enrichment/conversation.ts"
      provides: "Auth-gated sendMessage action"
      contains: "requireAuth"
    - path: "convex/enrichment/queries.ts"
      provides: "Auth-gated getMessagesPublic query"
      contains: "auth.getUserId"
    - path: "convex/enrichment/extraction.ts"
      provides: "Auth-gated extractFromConversation action with profileId arg"
      contains: "requireAuth"
    - path: "src/components/profile/enrichment/hooks/useEnrichment.ts"
      provides: "Frontend hook passing profileId to extractFromConversation"
      contains: "extractAction({ profileId"
    - path: "convex/admin.ts"
      provides: "Auth-gated opportunity CRUD requiring any-org admin"
      contains: "requireAnyOrgAdmin"
    - path: "convex/profiles.ts"
      provides: "Deprecated getCompleteness or auth-gated version"
      contains: "getMyCompleteness"
    - path: "convex/opportunities.ts"
      provides: "Auth-gated listAll query"
      contains: "requireAnyOrgAdmin"
  key_links:
    - from: "convex/enrichment/conversation.ts"
      to: "convex/lib/auth.ts"
      via: "import requireAuth"
      pattern: "import.*requireAuth.*from.*lib/auth"
    - from: "convex/enrichment/conversation.ts"
      to: "internal.enrichment.queries.getProfileInternal"
      via: "ctx.runQuery for ownership check"
      pattern: "profile\\.userId !== userId"
    - from: "src/components/profile/enrichment/hooks/useEnrichment.ts"
      to: "convex/enrichment/extraction.ts"
      via: "extractAction call with profileId in args"
      pattern: "extractAction\\(\\{\\s*profileId"
    - from: "convex/admin.ts"
      to: "convex/lib/auth.ts"
      via: "import requireAnyOrgAdmin for admin auth check on all 4 mutations"
      pattern: "requireAnyOrgAdmin"
---

<objective>
Add authentication and authorization checks to all unprotected endpoints: enrichment endpoints (sendMessage, getMessagesPublic, extractFromConversation), opportunity admin CRUD (create/update/delete/archive), admin listAll query, and deprecate the unprotected getCompleteness query.

Purpose: Close the three highest-severity auth gaps in the codebase -- unauthenticated enrichment endpoints that expose LLM access, unprotected opportunity CRUD that allows anyone to modify the database, and a public query that leaks profile data.

Output: A shared `requireAuth` helper in `convex/lib/auth.ts`, auth + ownership checks on all enrichment endpoints, admin auth on all opportunity CRUD, and deprecation of `getCompleteness`.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-critical-security/27-CONTEXT.md
@.planning/phases/27-critical-security/27-RESEARCH.md

Key source files to read before starting:
@convex/auth.ts (auth.getUserId pattern)
@convex/orgs/admin.ts (requireOrgAdmin pattern to replicate for admin.ts)
@convex/enrichment/conversation.ts (sendMessage -- add auth)
@convex/enrichment/queries.ts (getMessagesPublic -- add auth, getProfileInternal -- already internal)
@convex/enrichment/extraction.ts (extractFromConversation -- add auth + profileId arg)
@convex/admin.ts (opportunity CRUD -- add admin auth)
@convex/profiles.ts (getCompleteness -- deprecate)
@convex/opportunities.ts (listAll -- add admin auth)
@src/components/profile/enrichment/hooks/useEnrichment.ts (frontend caller of extractFromConversation)
@src/routes/admin/opportunities/index.tsx (frontend caller of listAll, deleteOpportunity, archiveOpportunity)
@src/components/admin/opportunity-form.tsx (frontend caller of createOpportunity, updateOpportunity)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create requireAuth helper and harden enrichment endpoints</name>
  <files>convex/lib/auth.ts, convex/enrichment/conversation.ts, convex/enrichment/queries.ts, convex/enrichment/extraction.ts, src/components/profile/enrichment/hooks/useEnrichment.ts</files>
  <action>
1. Create `convex/lib/auth.ts` with a `requireAuth` helper:
   - Import `auth` from `../auth`
   - Import `QueryCtx`, `MutationCtx`, `ActionCtx` types from `../_generated/server`
   - Function calls `auth.getUserId(ctx)`, throws `new Error("Not authenticated")` if null, returns userId string
   - Export the function

2. Modify `convex/enrichment/conversation.ts` (sendMessage action):
   - Add import: `import { requireAuth } from "../lib/auth"`
   - At the start of the handler (before any existing logic), add:
     ```
     const userId = await requireAuth(ctx);
     ```
   - After fetching the profile via `ctx.runQuery(internal.enrichment.queries.getProfileInternal, { profileId })` (which already happens on line 62-65), add ownership check:
     ```
     if (!profile || profile.userId !== userId) {
       throw new Error("Not authorized");
     }
     ```
   - The profile fetch already exists -- just add the ownership check after it
   - Do NOT change the message saving, LLM call, or return logic

3. Modify `convex/enrichment/queries.ts` (getMessagesPublic query):
   - Add import: `import { auth } from "../auth"`
   - At the start of the handler, add auth + ownership check that returns `[]` (not throws):
     ```
     const userId = await auth.getUserId(ctx);
     if (!userId) return [];
     const profile = await ctx.db.get(profileId);
     if (!profile || profile.userId !== userId) return [];
     ```
   - Keep the existing query logic after the check
   - IMPORTANT: Return empty array for unauthenticated/unauthorized, do NOT throw. Frontend uses `?? []` fallback.

4. Modify `convex/enrichment/extraction.ts` (extractFromConversation action):
   - Add import: `import { requireAuth } from "../lib/auth"`
   - Add import: `import { internal } from "../_generated/api"` (if not already present)
   - Add `profileId: v.id("profiles")` to the args object (alongside existing `messages` arg)
   - In handler, add auth + ownership check at the start:
     ```
     const userId = await requireAuth(ctx);
     // Actions can't use ctx.db directly, use runQuery
     const profile = await ctx.runQuery(internal.enrichment.queries.getProfileInternal, { profileId });
     if (!profile || profile.userId !== userId) {
       throw new Error("Not authorized");
     }
     ```
   - Note: the handler first arg is `ctx` not `_` -- update the destructured param from `_` to `ctx`
   - Keep all existing LLM extraction logic unchanged

5. Modify `src/components/profile/enrichment/hooks/useEnrichment.ts` -- update the extractFromConversation caller:
   - The hook receives `profileId: Id<"profiles"> | null` as its parameter (line 26)
   - On line 88, the call is currently:
     ```typescript
     const result = await extractAction({ messages: conversationMessages });
     ```
   - Change it to pass profileId:
     ```typescript
     const result = await extractAction({ profileId: profileId!, messages: conversationMessages });
     ```
   - The `profileId!` non-null assertion is safe because line 77 already guards: `if (!profileId || messages.length === 0) return;`
   - This is the ONLY frontend caller of `extractFromConversation` (confirmed via grep)
  </action>
  <verify>
Run `npx convex dev --once` (or equivalent typecheck) to verify all files compile without errors. Specifically check:
- `convex/lib/auth.ts` exports `requireAuth`
- `convex/enrichment/conversation.ts` compiles with new auth import
- `convex/enrichment/queries.ts` compiles with auth check
- `convex/enrichment/extraction.ts` compiles with new profileId arg and auth
- `bun run build` to verify frontend compiles with updated useEnrichment.ts
- Verify line 88 of useEnrichment.ts passes `profileId` in the extractAction call
  </verify>
  <done>
- sendMessage throws "Not authenticated" for unauthenticated users and "Not authorized" for wrong-profile access
- getMessagesPublic returns [] for unauthenticated or unauthorized users
- extractFromConversation requires profileId arg and throws for unauthenticated/unauthorized
- useEnrichment.ts passes profileId to extractAction call on line 88
  </done>
</task>

<task type="auto">
  <name>Task 2: Add admin auth to opportunity CRUD, deprecate getCompleteness, gate listAll</name>
  <files>convex/lib/auth.ts, convex/admin.ts, convex/profiles.ts, convex/opportunities.ts, src/routes/admin/opportunities/index.tsx, src/components/admin/opportunity-form.tsx</files>
  <action>
IMPORTANT DESIGN NOTE: The legacy admin routes at `/admin/opportunities/` do NOT have org context.
They are NOT under the org-scoped `/org/$slug/admin/` routes. The frontend components (opportunity-form.tsx,
admin/opportunities/index.tsx) have no orgId available and no org selection UI.

Therefore, instead of requiring a specific `orgId` parameter (which the frontend cannot provide),
use a `requireAnyOrgAdmin` pattern: verify the user is an admin of ANY organization. This secures
the endpoint (only org admins can manage opportunities) without requiring frontend org-context changes.
Opportunities are a global pool, not org-scoped data.

1. Add `requireAnyOrgAdmin` helper to `convex/lib/auth.ts` (the file created in Task 1):
   - Add to the existing file (do not overwrite Task 1's work):
     ```typescript
     export async function requireAnyOrgAdmin(
       ctx: QueryCtx | MutationCtx
     ): Promise<string> {
       const userId = await auth.getUserId(ctx);
       if (!userId) throw new Error("Not authenticated");
       const membership = await ctx.db
         .query("orgMemberships")
         .withIndex("by_user", (q) => q.eq("userId", userId))
         .filter((q) => q.eq(q.field("role"), "admin"))
         .first();
       if (!membership) throw new Error("Admin access required");
       return userId;
     }
     ```
   - Import `QueryCtx` type if not already imported from Task 1
   - This helper verifies the user is authenticated AND is an admin of at least one organization

2. Modify `convex/admin.ts` -- add admin auth to all four mutations:
   - Add imports: `import { requireAnyOrgAdmin } from "./lib/auth"`
   - For `createOpportunity`: Call `await requireAnyOrgAdmin(ctx)` as first line of handler. No changes to args or the rest of the handler.
   - For `updateOpportunity`: Call `await requireAnyOrgAdmin(ctx)` as first line of handler. No changes to args.
   - For `deleteOpportunity`: Call `await requireAnyOrgAdmin(ctx)` as first line of handler. No changes to args.
   - For `archiveOpportunity`: Call `await requireAnyOrgAdmin(ctx)` as first line of handler. No changes to args.
   - NO `orgId` parameter is added to any mutation args. The frontend callers (opportunity-form.tsx, admin/opportunities/index.tsx) do NOT need to change their mutation call arguments.

3. Modify `convex/profiles.ts` -- deprecate `getCompleteness`:
   - Add a JSDoc deprecation comment: `/** @deprecated Use getMyCompleteness instead. This endpoint will be removed. */`
   - Add auth check: at start of handler, call `const userId = await auth.getUserId(ctx)`. If not authenticated, return null.
   - Add ownership check: after fetching profile, verify `profile.userId === userId`. If not, return null.
   - Keep `getMyCompleteness` unchanged (already properly auth-gated).
   - Search for frontend callers of `getCompleteness` (not `getMyCompleteness`) and replace with `getMyCompleteness` if found: `grep -r "getCompleteness" src/ --include="*.ts" --include="*.tsx"`

4. Modify `convex/opportunities.ts` -- gate `listAll`:
   - Add import: `import { auth } from "./auth"`
   - Do NOT add `orgId` to listAll args (the frontend caller at src/routes/admin/opportunities/index.tsx passes `{ includeArchived: true }` and has no org context)
   - Add admin auth check at start of handler using inline logic:
     ```typescript
     const userId = await auth.getUserId(ctx);
     if (!userId) return [];
     const adminMembership = await ctx.db
       .query("orgMemberships")
       .withIndex("by_user", (q) => q.eq("userId", userId))
       .filter((q) => q.eq(q.field("role"), "admin"))
       .first();
     if (!adminMembership) return [];
     ```
   - Return empty array for unauthenticated/non-admin (it's a query -- graceful degradation)
   - The frontend callers at `src/routes/admin/opportunities/index.tsx` (lines 14 and 22) do NOT need to change -- they already pass `{ includeArchived: true }` which remains valid
  </action>
  <verify>
Run `npx convex dev --once` to verify all files compile. Check:
- `convex/lib/auth.ts` exports both `requireAuth` and `requireAnyOrgAdmin`
- `convex/admin.ts` compiles with requireAnyOrgAdmin calls (no orgId in args)
- `convex/profiles.ts` compiles with auth check on getCompleteness
- `convex/opportunities.ts` compiles with admin check on listAll (no orgId in args)
- `bun run build` succeeds -- frontend callers unchanged so no frontend compilation issues
- No TypeScript errors from changed function signatures
  </verify>
  <done>
- All four opportunity CRUD mutations require authenticated org admin (via requireAnyOrgAdmin -- no orgId parameter needed)
- getCompleteness is deprecated and auth-gated (returns null for unauthenticated/unauthorized)
- listAll requires admin auth (returns [] for non-admin, no orgId parameter needed)
- Frontend callers in opportunity-form.tsx and admin/opportunities/index.tsx are UNCHANGED (no orgId needed)
- `npx convex dev --once` passes with zero type errors
- `bun run build` succeeds
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript compilation: `npx convex dev --once` succeeds with no errors
2. Build check: `bun run build` completes successfully
3. Auth coverage audit: Every public endpoint in the modified files has an auth check:
   - `convex/enrichment/conversation.ts:sendMessage` -- requireAuth + ownership
   - `convex/enrichment/queries.ts:getMessagesPublic` -- auth + ownership (returns [])
   - `convex/enrichment/extraction.ts:extractFromConversation` -- requireAuth + ownership
   - `convex/admin.ts:createOpportunity` -- requireAnyOrgAdmin
   - `convex/admin.ts:updateOpportunity` -- requireAnyOrgAdmin
   - `convex/admin.ts:deleteOpportunity` -- requireAnyOrgAdmin
   - `convex/admin.ts:archiveOpportunity` -- requireAnyOrgAdmin
   - `convex/profiles.ts:getCompleteness` -- auth + ownership (returns null)
   - `convex/opportunities.ts:listAll` -- admin auth (returns [])
4. Frontend wiring: useEnrichment.ts passes profileId to extractFromConversation
5. No frontend breakage: opportunity admin pages unchanged (no orgId parameter added)
</verification>

<success_criteria>
- requireAuth helper exists at convex/lib/auth.ts and is used by enrichment endpoints
- requireAnyOrgAdmin helper exists at convex/lib/auth.ts and is used by legacy admin endpoints
- All 9 previously-unprotected endpoints now have authentication checks
- Enrichment endpoints verify profile ownership (user can only access their own data)
- Opportunity CRUD requires any-org admin role (global opportunity pool, not org-scoped)
- getCompleteness is deprecated with auth fallback
- Zero TypeScript compilation errors
- useEnrichment.ts passes profileId to extractFromConversation
- Frontend admin pages (opportunity-form.tsx, admin/opportunities/index.tsx) require NO changes to mutation call args
</success_criteria>

<output>
After completion, create `.planning/phases/27-critical-security/27-01-SUMMARY.md`
</output>
