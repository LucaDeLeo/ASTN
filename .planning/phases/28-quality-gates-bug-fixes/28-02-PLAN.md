---
phase: 28-quality-gates-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/matching/compute.ts
  - convex/profiles.ts
  - convex/engagement/queries.ts
  - src/routes/profile/index.tsx
  - src/routes/profile/edit.tsx
  - src/routes/profile/attendance.tsx
  - src/routes/admin/route.tsx
  - src/routes/settings/route.tsx
autonomous: true

must_haves:
  truths:
    - "Growth areas from multi-batch matching runs accumulate across batches (push, not assign) and are deduplicated before storage"
    - "Date conversion in profiles uses Date.UTC() for timezone-independent timestamps"
    - "All 5 redirect components wrap navigate() calls inside useEffect (no render-time side effects)"
    - "Engagement override expiration is checked in query handlers, not just the daily compute batch"
    - "Timezone validation rejects invalid IANA timezone strings using Intl.DateTimeFormat"
  artifacts:
    - path: "convex/matching/compute.ts"
      provides: "Growth area aggregation fix + dedup function"
      contains: "push.*growthAreas"
    - path: "convex/profiles.ts"
      provides: "Date.UTC conversion + IANA timezone validation"
      contains: "Date.UTC"
    - path: "convex/engagement/queries.ts"
      provides: "Override expiration check in query handlers"
      contains: "expiresAt"
    - path: "src/routes/profile/index.tsx"
      provides: "useEffect-wrapped navigation"
      contains: "useEffect"
    - path: "src/routes/profile/edit.tsx"
      provides: "useEffect-wrapped navigation"
      contains: "useEffect"
    - path: "src/routes/profile/attendance.tsx"
      provides: "useEffect-wrapped navigation"
      contains: "useEffect"
    - path: "src/routes/admin/route.tsx"
      provides: "useEffect-wrapped navigation"
      contains: "useEffect"
    - path: "src/routes/settings/route.tsx"
      provides: "useEffect-wrapped navigation"
      contains: "useEffect"
  key_links:
    - from: "convex/matching/compute.ts"
      to: "aggregatedGrowthAreas"
      via: "push() + deduplicateGrowthAreas() instead of assignment"
      pattern: "aggregatedGrowthAreas\\.push"
    - from: "convex/profiles.ts convertDateString"
      to: "Date.UTC"
      via: "Replaces new Date(year, month-1, 1)"
      pattern: "Date\\.UTC"
    - from: "convex/engagement/queries.ts"
      to: "override.expiresAt"
      via: "Shared getEffectiveLevel helper"
      pattern: "getEffectiveLevel"
---

<objective>
Fix all known bugs: growth area overwrite across matching batches, local-timezone Date conversion, navigation-during-render warnings in redirect components, engagement override expiration in queries, and timezone validation using IANA database.

Purpose: Correct data integrity issues (growth areas, dates), eliminate React warnings (navigation during render), ensure engagement levels reflect real-time override expiration, and validate timezone inputs properly.
Output: 8 modified files with targeted bug fixes
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-quality-gates-bug-fixes/28-RESEARCH.md (bug details with line numbers, fix patterns)
@convex/matching/compute.ts
@convex/profiles.ts
@convex/engagement/queries.ts
@src/routes/profile/index.tsx
@src/routes/matches/index.tsx (reference: already has correct useEffect pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Convex backend bugs (growth areas, Date.UTC, engagement override, timezone)</name>
  <files>convex/matching/compute.ts, convex/profiles.ts, convex/engagement/queries.ts</files>
  <action>
  **BUG-01: Growth area aggregation (convex/matching/compute.ts)**

  1. Find the growth area assignment near line 112 that looks like:
     ```typescript
     aggregatedGrowthAreas = batchResult.growthAreas;
     ```
     Replace with accumulation:
     ```typescript
     aggregatedGrowthAreas.push(...batchResult.growthAreas);
     ```

  2. After the batch loop completes (after all batches are processed), add a deduplication step before the growth areas are stored. Create a `deduplicateGrowthAreas` function that:
     - Groups items by normalized theme name (case-insensitive, trimmed)
     - Within each theme, deduplicates items (case-insensitive)
     - Ranks items by frequency (how many batches mentioned them)
     - Caps total items at 10 per theme
     - Returns the deduplicated array
     See 28-RESEARCH.md "Growth Area Aggregation Fix" section for the full implementation.

  3. Call `deduplicateGrowthAreas(aggregatedGrowthAreas)` before passing growth areas to the storage mutation.

  **BUG-02: Date.UTC conversion (convex/profiles.ts)**

  4. Find the `convertDateString` function (near line 348). It currently uses:
     ```typescript
     return new Date(year, month - 1, 1).getTime();
     ```
     Replace with:
     ```typescript
     return Date.UTC(year, month - 1, 1);
     ```
     This ensures timezone-independent timestamps regardless of the server's locale.

  **QUAL-09: IANA timezone validation (convex/profiles.ts)**

  5. Find the timezone validation (near line 256) that currently checks for "/" in the string. Replace with a proper IANA check:
     ```typescript
     function isValidIANATimezone(tz: string): boolean {
       try {
         Intl.DateTimeFormat(undefined, { timeZone: tz });
         return true;
       } catch {
         return false;
       }
     }
     ```
     Use this function wherever timezone validation is performed. If the current check is inline (e.g., `timezone.includes("/")`), replace it with `isValidIANATimezone(timezone)`.

  **BUG-04: Engagement override expiration (convex/engagement/queries.ts)**

  6. Create a shared helper function `getEffectiveLevel` in the queries file:
     ```typescript
     function getEffectiveLevel(engagement: { level: string; override?: { level: string; expiresAt?: number } }): string {
       if (engagement.override) {
         if (engagement.override.expiresAt && engagement.override.expiresAt < Date.now()) {
           return engagement.level; // Override expired
         }
         return engagement.override.level;
       }
       return engagement.level;
     }
     ```

  7. Find the three query handlers that return engagement level:
     - `getMemberEngagement` (near line 112)
     - `getOrgEngagementForAdmin` (near line 166)
     - `getMemberEngagementForAdmin` (near line 203)

     In each handler, where the engagement level is returned or used, replace direct access to `engagement.override?.level || engagement.level` with `getEffectiveLevel(engagement)`.
  </action>
  <verify>
  - `grep -n "push.*growthAreas" convex/matching/compute.ts` -- confirms push instead of assignment
  - `grep -n "deduplicateGrowthAreas" convex/matching/compute.ts` -- confirms dedup function exists and is called
  - `grep -n "Date.UTC" convex/profiles.ts` -- confirms UTC conversion
  - `grep -n "isValidIANATimezone\|Intl.DateTimeFormat" convex/profiles.ts` -- confirms IANA validation
  - `grep -n "getEffectiveLevel" convex/engagement/queries.ts` -- confirms helper exists and is used
  - `bun run typecheck` -- no type errors
  </verify>
  <done>Growth areas accumulate via push + dedup. Date conversion uses Date.UTC. Timezone validation uses Intl.DateTimeFormat. Engagement override expiration is checked in all three query handlers via getEffectiveLevel helper.</done>
</task>

<task type="auto">
  <name>Task 2: Wrap navigation calls in useEffect for redirect components</name>
  <files>src/routes/profile/index.tsx, src/routes/profile/edit.tsx, src/routes/profile/attendance.tsx, src/routes/admin/route.tsx, src/routes/settings/route.tsx</files>
  <action>
  **BUG-03: Navigation during render (5 files)**

  For each of the 5 files listed, find the component that calls `navigate()` directly during render (typically in an `UnauthenticatedRedirect` or similar conditional redirect component). The pattern to find:

  ```typescript
  // BAD: navigate called during render
  function UnauthenticatedRedirect() {
    const navigate = useNavigate();
    navigate({ to: "/login" });
    return <Spinner />;
  }
  ```

  Replace with useEffect pattern:

  ```typescript
  // GOOD: navigate called in useEffect
  function UnauthenticatedRedirect() {
    const navigate = useNavigate();
    useEffect(() => {
      navigate({ to: "/login" });
    }, [navigate]);
    return (
      <div className="flex items-center justify-center min-h-[calc(100vh-65px)]">
        <Spinner />
      </div>
    );
  }
  ```

  Reference implementation: `src/routes/matches/index.tsx` already has the correct pattern (useEffect wrapping navigate). Use that as the model.

  For each file:
  1. `src/routes/profile/index.tsx` (line ~73): Find navigate() call, wrap in useEffect. Add `import { useEffect } from 'react'` if not already imported.
  2. `src/routes/profile/edit.tsx` (line ~53): Same pattern.
  3. `src/routes/profile/attendance.tsx` (line ~44): Same pattern.
  4. `src/routes/admin/route.tsx` (line ~64): Same pattern.
  5. `src/routes/settings/route.tsx` (line ~62): Same pattern.

  Ensure each file imports `useEffect` from React. Check if `useEffect` is already imported; if not, add it to the existing React import.

  Note: The spinner/loading UI during redirect should show a centered spinner (matching the existing pattern in matches routes). Preserve any existing loading UI in these components.
  </action>
  <verify>
  - For each of the 5 files, verify:
    - `grep -n "useEffect" <file>` -- confirms useEffect is used
    - `grep -n "navigate" <file>` -- navigate appears inside useEffect, not at top level
  - `bun run typecheck` -- no type errors across all modified files
  - `bun run lint` -- no lint warnings
  </verify>
  <done>All 5 redirect components wrap navigate() in useEffect. No navigation-during-render warnings. useEffect is properly imported in all files.</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` -- all modified files pass type checking
2. `bun run lint` -- no lint errors
3. `grep -rn "aggregatedGrowthAreas =" convex/matching/compute.ts` -- no direct assignment (only initialization)
4. `grep -n "Date.UTC" convex/profiles.ts` -- Date.UTC used in convertDateString
5. `grep -c "useEffect" src/routes/profile/index.tsx src/routes/profile/edit.tsx src/routes/profile/attendance.tsx src/routes/admin/route.tsx src/routes/settings/route.tsx` -- each file has at least 1 useEffect
6. `grep -n "getEffectiveLevel" convex/engagement/queries.ts` -- helper exists and is called in queries
7. `grep -n "isValidIANATimezone\|Intl.DateTimeFormat" convex/profiles.ts` -- IANA validation present
</verification>

<success_criteria>
- Growth area aggregation uses push + dedup (not assignment) across batches
- Date conversion uses Date.UTC in convertDateString
- All 5 redirect components use useEffect for navigation
- Engagement override expiration is checked in all 3 query handlers
- Timezone validation uses Intl.DateTimeFormat IANA check
- All files pass typecheck and lint
</success_criteria>

<output>
After completion, create `.planning/phases/28-quality-gates-bug-fixes/28-02-SUMMARY.md`
</output>
