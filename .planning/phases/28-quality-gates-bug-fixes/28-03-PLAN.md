---
phase: 28-quality-gates-bug-fixes
plan: 03
type: execute
wave: 2
depends_on: ['28-02']
files_modified:
  - src/routes/test-upload.tsx
  - src/components/profile/wizard/ProfileWizard.tsx
  - src/components/admin/opportunity-form.tsx
  - convex/lib/logging.ts
  - convex/aggregation/sync.ts
  - convex/aggregation/aisafety.ts
  - convex/aggregation/eightyK.ts
  - convex/aggregation/syncMutations.ts
  - convex/emails/batchActions.ts
  - convex/engagement/compute.ts
  - convex/enrichment/extraction.ts
  - convex/events/sync.ts
  - convex/events/lumaClient.ts
  - convex/extraction/pdf.ts
  - convex/extraction/text.ts
  - convex/matching/compute.ts
  - convex/notifications/realtime.ts
autonomous: true

must_haves:
  truths:
    - 'test-upload route no longer exists in the codebase'
    - 'No _STEP_LABELS dead code exists in ProfileWizard'
    - 'User-facing errors in admin forms use toast notifications (no alert() calls)'
    - 'All Convex server functions use structured JSON logging via a shared utility (no raw console.log for operational messages)'
  artifacts:
    - path: 'convex/lib/logging.ts'
      provides: 'Shared structured logging utility'
      exports: ['log']
    - path: 'src/components/admin/opportunity-form.tsx'
      provides: 'Toast-based error notification'
      contains: 'toast'
    - path: 'src/components/profile/wizard/ProfileWizard.tsx'
      provides: 'Clean wizard without dead code'
  key_links:
    - from: 'src/components/admin/opportunity-form.tsx'
      to: 'sonner'
      via: "import { toast } from 'sonner'"
      pattern: "toast\\.(error|success)"
    - from: 'convex/aggregation/sync.ts'
      to: 'convex/lib/logging.ts'
      via: "import { log } from '../lib/logging'"
      pattern: 'import.*log.*from.*logging'
    - from: 'convex/emails/batchActions.ts'
      to: 'convex/lib/logging.ts'
      via: "import { log } from '../lib/logging'"
      pattern: 'import.*log.*from.*logging'
---

<objective>
Remove dead code, replace alert() with toast notifications, and standardize all Convex server-side logging to use structured JSON format via a shared utility.

Purpose: Eliminate code quality gaps -- dead code is noise, alert() is poor UX, and raw console.log is not searchable or parseable in production.
Output: 1 deleted file, 1 new utility file, 15 modified files
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-quality-gates-bug-fixes/28-RESEARCH.md (structured logging pattern, toast pattern, dead code locations)
@.planning/phases/28-quality-gates-bug-fixes/28-02-SUMMARY.md
@src/components/admin/opportunity-form.tsx
@src/components/profile/wizard/ProfileWizard.tsx
@src/routes/__root.tsx (Sonner Toaster is already mounted here)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead code and replace alert() with toast</name>
  <files>src/routes/test-upload.tsx, src/components/profile/wizard/ProfileWizard.tsx, src/components/admin/opportunity-form.tsx</files>
  <action>
  **QUAL-05: Delete test route**

1. Delete the file `src/routes/test-upload.tsx`. This is a test route that was marked for removal. Verify it has no imports elsewhere before deleting:
   - Search for `test-upload` across the codebase to confirm nothing references it
   - If no references found, delete the file

**QUAL-06: Remove dead \_STEP_LABELS code**

2. Open `src/components/profile/wizard/ProfileWizard.tsx` and find the `_STEP_LABELS` constant (near lines 44-53). It is prefixed with underscore, indicating it's intentionally unused. Remove:
   - The `_STEP_LABELS` constant definition
   - Any void statement referencing it (e.g., `void _STEP_LABELS;`)
   - Verify no other code references it after removal

**QUAL-07: Replace alert() with toast**

3. Open `src/components/admin/opportunity-form.tsx` and find the `alert()` call (near line 126). It likely looks like:

   ```typescript
   alert('Some error message')
   ```

   Replace with a sonner toast:

   ```typescript
   import { toast } from 'sonner'
   // ...
   toast.error('Failed to save opportunity', { duration: Infinity })
   ```

   Per CONTEXT.md: error toasts persist until manually dismissed (duration: Infinity). Success toasts auto-dismiss (~5s, which is sonner's default).

   Add `import { toast } from 'sonner'` at the top of the file if not already imported. The `<Toaster>` component is already mounted in `src/routes/__root.tsx`.

   If there are multiple alert() calls in this file, replace ALL of them with appropriate toast variants (toast.error for errors, toast.success for success).
   </action>
   <verify>

- `ls src/routes/test-upload.tsx 2>/dev/null` -- file should not exist
- `grep -rn "test-upload" src/` -- no references remain
- `grep -n "_STEP_LABELS" src/components/profile/wizard/ProfileWizard.tsx` -- returns nothing
- `grep -n "alert(" src/components/admin/opportunity-form.tsx` -- returns nothing
- `grep -n "toast" src/components/admin/opportunity-form.tsx` -- confirms toast is used
- `bun run typecheck` -- no type errors
  </verify>
  <done>test-upload.tsx deleted. \_STEP_LABELS removed from ProfileWizard. alert() replaced with toast.error() in opportunity-form.</done>
  </task>

<task type="auto">
  <name>Task 2: Create structured logging utility and migrate all Convex files</name>
  <files>convex/lib/logging.ts, convex/aggregation/sync.ts, convex/aggregation/aisafety.ts, convex/aggregation/eightyK.ts, convex/aggregation/syncMutations.ts, convex/emails/batchActions.ts, convex/engagement/compute.ts, convex/enrichment/extraction.ts, convex/events/sync.ts, convex/events/lumaClient.ts, convex/extraction/pdf.ts, convex/extraction/text.ts, convex/matching/compute.ts, convex/notifications/realtime.ts</files>
  <action>
  **QUAL-08: Structured logging standardization**

1. Create `convex/lib/logging.ts` with a shared structured logging utility:

   ```typescript
   /**
    * Structured logging for Convex server functions.
    * Outputs JSON to stdout/stderr which Convex dashboard captures.
    */
   export function log(
     level: 'info' | 'warn' | 'error',
     message: string,
     context?: Record<string, unknown>,
   ) {
     const entry = {
       level,
       message,
       timestamp: new Date().toISOString(),
       ...context,
     }
     if (level === 'error') {
       console.error(JSON.stringify(entry))
     } else if (level === 'warn') {
       console.warn(JSON.stringify(entry))
     } else {
       console.log(JSON.stringify(entry))
     }
   }
   ```

   If `convex/lib/` directory does not exist, create it. Check for existing files in `convex/lib/` first.

2. Migrate each of the 13 Convex files listed below. For each file:
   - Add `import { log } from "../lib/logging";` (adjust relative path based on file depth)
   - Replace every `console.log(...)` used for operational messages with `log("info", "message", { contextKeys })`.
   - Replace every `console.error(...)` with `log("error", "message", { contextKeys })`.
   - Preserve the original message content but restructure into the (level, message, context) format.
   - DO NOT replace console.log/error that are inside `"use node"` action files where they serve as temporary debug output that would be removed later.

   **Conversion pattern:**

   ```typescript
   // BEFORE:
   console.log(`Syncing opportunities from ${source}`)
   console.error('Failed to sync:', error)

   // AFTER:
   log('info', 'Syncing opportunities', { source })
   log('error', 'Failed to sync', { error: String(error) })
   ```

   **Files and approximate instance counts:**
   - `convex/aggregation/sync.ts` (~6 instances) -- path: `../lib/logging`
   - `convex/aggregation/aisafety.ts` (~4 instances) -- path: `../lib/logging`
   - `convex/aggregation/eightyK.ts` (~3 instances) -- path: `../lib/logging`
   - `convex/aggregation/syncMutations.ts` (~2 instances) -- path: `../lib/logging`
   - `convex/emails/batchActions.ts` (~16 instances) -- path: `../lib/logging`
   - `convex/engagement/compute.ts` (~8 instances) -- path: `../lib/logging`
   - `convex/enrichment/extraction.ts` (~1 instance) -- path: `../lib/logging`
   - `convex/events/sync.ts` (~8 instances) -- path: `../lib/logging`
   - `convex/events/lumaClient.ts` (~1 instance) -- path: `../lib/logging`
   - `convex/extraction/pdf.ts` (~1 instance) -- path: `../lib/logging`
   - `convex/extraction/text.ts` (~1 instance) -- path: `../lib/logging`
   - `convex/matching/compute.ts` (~3 instances) -- path: `../lib/logging`
   - `convex/notifications/realtime.ts` (~1 instance) -- path: `../lib/logging`

   Important: For files with `"use node"` at the top, the logging utility can still be imported since it only uses console.log/error/warn internally. The `convex/lib/logging.ts` file should NOT have `"use node"` -- it's a pure utility that works in both Node and Convex environments.

3. After migration, scan for any remaining `console.log` or `console.error` in the convex/ directory that should have been migrated. Some legitimate uses may remain (e.g., in test files or the logging utility itself). The goal is zero raw console.log/error for operational messages.
   </action>
   <verify>

- `ls convex/lib/logging.ts` -- utility file exists
- `grep -rn "import.*log.*from.*logging" convex/` -- all 13 files import the logger
- `grep -rn "console\\.log\\|console\\.error" convex/ --include="*.ts" | grep -v "logging.ts" | grep -v "node_modules"` -- minimal remaining instances (only legitimate uses like the logger itself)
- `bun run typecheck` -- no type errors across all modified files
  </verify>
  <done>Shared logging utility created at convex/lib/logging.ts. All 13 Convex files migrated from raw console.log/error to structured log() calls with level, message, and context.</done>
  </task>

</tasks>

<verification>
1. `ls src/routes/test-upload.tsx 2>/dev/null` -- file deleted
2. `grep -rn "_STEP_LABELS" src/` -- no dead code references
3. `grep -rn "alert(" src/components/admin/` -- no alert() calls
4. `grep -rn "toast" src/components/admin/opportunity-form.tsx` -- toast is used
5. `ls convex/lib/logging.ts` -- logger utility exists
6. `grep -c "import.*log.*from.*logging" convex/aggregation/sync.ts convex/emails/batchActions.ts convex/engagement/compute.ts` -- each returns 1
7. `bun run typecheck` -- passes
8. `bun run lint` -- passes
9. `bun run build` -- passes
</verification>

<success_criteria>

- test-upload.tsx route is deleted with no remaining references
- \_STEP_LABELS dead code is removed from ProfileWizard
- alert() replaced with toast.error() in opportunity-form (error toasts persist until dismissed)
- Shared structured logging utility exists at convex/lib/logging.ts
- All 13 Convex files use structured log() instead of raw console.log/error
- All files pass typecheck, lint, and build
  </success_criteria>

<output>
After completion, create `.planning/phases/28-quality-gates-bug-fixes/28-03-SUMMARY.md`
</output>
