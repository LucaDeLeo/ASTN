# Plan 30-01: Schema + Auth + Org Applications Backend

## Goal

Add the database schema, auth helpers, and Convex functions for org applications and platform admin review. This is the foundation that all frontend work depends on.

## Dependencies

- None (first plan in phase)

## Tasks

### Task 1: Add new tables and extend notifications schema

**File:** `convex/schema.ts`

Add `platformAdmins` table:
```ts
platformAdmins: defineTable({
  userId: v.string(),
  addedAt: v.number(),
  addedBy: v.optional(v.string()), // userId of who added them, null for seed
}).index('by_user', ['userId']),
```

Add `orgApplications` table:
```ts
orgApplications: defineTable({
  // Applicant info
  applicantUserId: v.string(),
  applicantName: v.string(),
  applicantEmail: v.string(),

  // Org info from application
  orgName: v.string(),
  description: v.string(),
  city: v.string(),
  country: v.string(),
  website: v.optional(v.string()),
  reasonForJoining: v.string(),

  // Status machine: pending -> approved | rejected | withdrawn
  status: v.union(
    v.literal('pending'),
    v.literal('approved'),
    v.literal('rejected'),
    v.literal('withdrawn'),
  ),
  rejectionReason: v.optional(v.string()),

  // Review tracking
  reviewedBy: v.optional(v.string()), // platform admin userId
  reviewedAt: v.optional(v.number()),

  // Metadata
  createdAt: v.number(),
})
  .index('by_applicant', ['applicantUserId'])
  .index('by_status', ['status'])
  .index('by_orgName', ['orgName']),
```

Extend `notifications` table `type` union to add:
- `v.literal('org_application_approved')`
- `v.literal('org_application_rejected')`

Add `applicationId` optional field to notifications:
```ts
applicationId: v.optional(v.id('orgApplications')),
```

### Task 2: Add `requirePlatformAdmin` auth helper

**File:** `convex/lib/auth.ts`

Add a new exported function `requirePlatformAdmin`:
```ts
export async function requirePlatformAdmin(
  ctx: QueryCtx | MutationCtx,
): Promise<string> {
  const userId = await auth.getUserId(ctx)
  if (!userId) {
    throw new Error('Not authenticated')
  }

  const admin = await ctx.db
    .query('platformAdmins')
    .withIndex('by_user', (q) => q.eq('userId', userId))
    .first()

  if (!admin) {
    throw new Error('Platform admin access required')
  }

  return userId
}
```

Also add a non-throwing helper for frontend gating:
```ts
export async function isPlatformAdmin(
  ctx: QueryCtx | MutationCtx,
): Promise<boolean> {
  const userId = await auth.getUserId(ctx)
  if (!userId) return false

  const admin = await ctx.db
    .query('platformAdmins')
    .withIndex('by_user', (q) => q.eq('userId', userId))
    .first()

  return !!admin
}
```

### Task 3: Create org applications Convex module

**File:** `convex/orgApplications.ts`

Functions to implement:

**`submit` (mutation)** - Authenticated user submits application
- Args: `orgName`, `description`, `city`, `country`, `website` (optional), `reasonForJoining`, `applicantName`, `applicantEmail`
- Auth: `requireAuth`
- Duplicate check: query `organizations` by name (case-insensitive `.toLowerCase().trim()`) AND query `orgApplications` by orgName where status is `pending` or `approved`. If match found, throw descriptive error.
- Insert into `orgApplications` with status `pending`
- Return the application ID

**`getMyApplications` (query)** - Get all applications for the current user
- Auth: `requireAuth`
- Query `orgApplications` with index `by_applicant` for current userId
- Return sorted by `createdAt` descending

**`listAll` (query)** - Platform admin lists all applications
- Args: optional `status` filter
- Auth: `requirePlatformAdmin`
- If status provided, query with `by_status` index, else collect all
- Return sorted by `createdAt` descending
- Include applicant display info

**`getApplication` (query)** - Get single application by ID
- Args: `applicationId`
- Auth: `requireAuth` (then check: user is applicant OR user is platform admin)
- Return full application data

**`approve` (mutation)** - Platform admin approves application
- Args: `applicationId`
- Auth: `requirePlatformAdmin`
- Validate: application exists and status is `pending`
- Update application: status `approved`, reviewedBy, reviewedAt
- Create `organizations` record from application data (name, description, city, country, generate slug from name)
- Create `orgMemberships` record: applicantUserId as admin
- Schedule notification: type `org_application_approved`, title "Your org application was approved", body with org name, actionUrl to `/org/${slug}/admin`
- Return the new org ID

**`reject` (mutation)** - Platform admin rejects application
- Args: `applicationId`, `rejectionReason` (required string)
- Auth: `requirePlatformAdmin`
- Validate: application exists and status is `pending`
- Update application: status `rejected`, rejectionReason, reviewedBy, reviewedAt
- Schedule notification: type `org_application_rejected`, title "Your org application was not approved", body includes reason, actionUrl to `/apply/status`

**`withdraw` (mutation)** - Applicant withdraws own application
- Args: `applicationId`
- Auth: `requireAuth`
- Validate: application exists, applicant is current user, status is `pending`
- Update application: status `withdrawn`

### Task 4: Create platform admin check query and seed mutation

**File:** `convex/orgApplications.ts` (add to same file)

**`checkPlatformAdmin` (query)** - Frontend uses to gate admin UI
- Auth: returns false if not authenticated
- Returns `isPlatformAdmin` result

**File:** `convex/lib/seedPlatformAdmin.ts` (new file)

**`seedPlatformAdmin` (internalMutation)** - Bootstrap first platform admin
- Args: `email` (string)
- Look up user by email in auth tables
- If found, insert into `platformAdmins` if not already present
- Log result

### Task 5: Update notification creation to support new types

**File:** `convex/notifications/mutations.ts`

Update `createNotification` args to include the new notification types in the union:
- Add `org_application_approved` and `org_application_rejected` to the type union
- Add optional `applicationId: v.optional(v.id('orgApplications'))` arg

### Task 6: Slug generation helper

**File:** `convex/lib/slug.ts` (new file)

Create a `generateSlug` function:
- Takes org name string
- Lowercases, replaces spaces/special chars with hyphens, removes consecutive hyphens, trims hyphens
- Takes `ctx` to check for slug uniqueness against `organizations` table
- If slug exists, append `-2`, `-3`, etc.

This is used by the `approve` mutation when creating the org record.

## Acceptance Criteria

- [ ] `platformAdmins` and `orgApplications` tables exist in schema with proper indexes
- [ ] `requirePlatformAdmin` throws for non-admin users, returns userId for admins
- [ ] `submit` mutation creates application with `pending` status and prevents duplicates
- [ ] `approve` mutation atomically creates org + membership + notification
- [ ] `reject` mutation updates status with required reason + sends notification
- [ ] `withdraw` mutation only works for own pending applications
- [ ] `listAll` query returns applications filtered by status for platform admins
- [ ] `getMyApplications` returns only the current user's applications
- [ ] Notification types extended without breaking existing notification rendering
- [ ] Slug generation produces URL-safe unique slugs
