---
phase: 33-guest
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/guestProfiles.ts
  - convex/guestBookings.ts
  - convex/spaceBookings.ts
  - convex/notifications/mutations.ts
  - convex/lib/auth.ts
autonomous: true

must_haves:
  truths:
    - 'guestProfiles table exists with userId, name, email, conversion tracking'
    - 'visitApplicationResponses table stores custom form field answers'
    - 'spaceBookings has approvedBy, approvedAt, rejectionReason fields'
    - 'Guest visit application can be created as pending booking'
    - 'Org admin can approve or reject guest applications'
    - 'Guest receives notification on approval or rejection'
    - 'Approved guests appear in attendee query with isGuest flag'
  artifacts:
    - path: 'convex/schema.ts'
      provides: 'guestProfiles, visitApplicationResponses tables + extended spaceBookings + notification types'
      contains: 'guestProfiles'
    - path: 'convex/guestProfiles.ts'
      provides: 'Guest profile CRUD and conversion'
      exports:
        ['getOrCreateGuestProfile', 'getGuestProfile', 'markGuestAsMember']
    - path: 'convex/guestBookings.ts'
      provides: 'Guest visit application mutations'
      exports:
        [
          'submitVisitApplication',
          'approveGuestVisit',
          'rejectGuestVisit',
          'batchApproveGuestVisits',
        ]
    - path: 'convex/spaceBookings.ts'
      provides: 'Extended getBookingAttendees with guest support'
      exports: ['getBookingAttendees']
  key_links:
    - from: 'convex/guestBookings.ts'
      to: 'convex/notifications/mutations.ts'
      via: 'ctx.scheduler.runAfter'
      pattern: "scheduler\\.runAfter.*createNotification"
    - from: 'convex/spaceBookings.ts'
      to: 'convex/guestProfiles.ts'
      via: 'guestProfiles query'
      pattern: 'guestProfiles.*by_user'
---

<objective>
Add schema and backend for guest visitor system including guest profiles, visit applications, approval workflow, and notifications.

Purpose: Enable non-members to apply for coworking space visits with a lightweight account, and allow org admins to approve or reject these applications.
Output: Database tables and Convex functions for the complete guest visit lifecycle.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-guest/CONTEXT.md
@.planning/phases/33-guest/33-RESEARCH.md
@.planning/phases/32-phase-32/32-01-SUMMARY.md
@convex/schema.ts
@convex/spaceBookings.ts
@convex/orgApplications.ts
@convex/notifications/mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with guestProfiles, visitApplicationResponses, and booking approval fields</name>
  <files>convex/schema.ts</files>
  <action>
Add these schema changes:

1. **New guestProfiles table:**

```typescript
guestProfiles: defineTable({
  userId: v.string(),
  name: v.string(),
  email: v.string(),

  // Optional contact info
  phone: v.optional(v.string()),
  organization: v.optional(v.string()),
  title: v.optional(v.string()),

  // Visit tracking
  visitCount: v.number(),
  firstVisitDate: v.optional(v.string()),  // ISO date
  lastVisitDate: v.optional(v.string()),   // ISO date

  // Conversion tracking (GUEST-08)
  becameMember: v.boolean(),
  becameMemberAt: v.optional(v.number()),
  convertedToProfileId: v.optional(v.id('profiles')),

  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index('by_user', ['userId'])
  .index('by_email', ['email']),
```

2. **New visitApplicationResponses table:**

```typescript
visitApplicationResponses: defineTable({
  spaceBookingId: v.id('spaceBookings'),
  fieldId: v.string(),
  value: v.string(),
  createdAt: v.number(),
})
  .index('by_booking', ['spaceBookingId']),
```

3. **Extend spaceBookings table with approval fields:**
   Add these fields to the existing spaceBookings definition:

```typescript
// Guest approval fields (Phase 33)
approvedBy: v.optional(v.id('orgMemberships')),
approvedAt: v.optional(v.number()),
rejectionReason: v.optional(v.string()),
```

4. **Add guest notification types to notifications table:**
   Update the `type` union in notifications table to include:

```typescript
v.literal('guest_visit_approved'),
v.literal('guest_visit_rejected'),
v.literal('guest_visit_pending'),
```

  </action>
  <verify>Run `bunx convex dev` briefly to verify schema compiles without errors. TypeScript should show no errors on schema.ts</verify>
  <done>Schema has guestProfiles table, visitApplicationResponses table, spaceBookings approval fields, and guest notification types</done>
</task>

<task type="auto">
  <name>Task 2: Create guestProfiles.ts with profile CRUD and conversion tracking</name>
  <files>convex/guestProfiles.ts</files>
  <action>
Create `convex/guestProfiles.ts` with these functions following orgApplications.ts patterns:

**Mutations:**

1. `getOrCreateGuestProfile` - Internal mutation (for use during visit application)
   - Args: `{ userId, name, email, phone?, organization?, title? }`
   - Check if guestProfile exists for userId
   - If exists, return existing profile (do NOT update name/email - that's a separate update flow)
   - If not exists, create new profile with `visitCount: 0`, `becameMember: false`
   - Return the profile ID

2. `updateGuestProfile` - Mutation for guests to update their own profile
   - Args: `{ name?, phone?, organization?, title? }` (email NOT updatable)
   - Requires auth, finds guestProfile by userId
   - Updates provided fields

3. `markGuestAsMember` - Internal mutation for conversion (GUEST-08)
   - Args: `{ userId, profileId }` (the new profiles table ID)
   - Find guestProfile by userId
   - Patch with `becameMember: true`, `becameMemberAt: Date.now()`, `convertedToProfileId: profileId`
   - Do NOT delete the guestProfile (preserve for audit trail per CONTEXT.md)

**Queries:**

1. `getGuestProfile` - Query for current user's guest profile
   - No args
   - Returns guestProfile for authenticated userId, or null

2. `getGuestProfileByUserId` - Internal query
   - Args: `{ userId }`
   - Returns guestProfile or null

Use `requireAuth` from `convex/lib/auth.ts` for authentication.
</action>
<verify>File exists and exports the 5 functions. Run `bun run lint` to check TypeScript compiles</verify>
<done>guestProfiles.ts exists with CRUD mutations and conversion tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create guestBookings.ts with visit application and approval workflow</name>
  <files>convex/guestBookings.ts, convex/notifications/mutations.ts, convex/lib/auth.ts, convex/spaceBookings.ts</files>
  <action>
**1. Add auth helper to convex/lib/auth.ts:**

Add `requireSpaceAdmin` helper function:

```typescript
export async function requireSpaceAdmin(
  ctx: QueryCtx | MutationCtx,
  spaceId: Id<'coworkingSpaces'>,
): Promise<{
  userId: string
  space: Doc<'coworkingSpaces'>
  membership: Doc<'orgMemberships'>
}> {
  const userId = await requireAuth(ctx)

  const space = await ctx.db.get(spaceId)
  if (!space) throw new Error('Space not found')

  const membership = await ctx.db
    .query('orgMemberships')
    .withIndex('by_user', (q) => q.eq('userId', userId))
    .filter((q) => q.eq(q.field('orgId'), space.orgId))
    .first()

  if (!membership || membership.role !== 'admin') {
    throw new Error('Not authorized - must be org admin')
  }

  return { userId, space, membership }
}
```

**2. Update notifications/mutations.ts:**

Extend `createNotification` args to accept the new types and spaceBookingId:

- Add `v.literal('guest_visit_approved')`, `v.literal('guest_visit_rejected')`, `v.literal('guest_visit_pending')` to type union
- Add `spaceBookingId: v.optional(v.id('spaceBookings'))` if not already present

**3. Create convex/guestBookings.ts:**

**Mutations:**

1. `submitVisitApplication` - Guest submits visit application (GUEST-03)
   - Args: `{ spaceId, date, startMinutes, endMinutes, consentToProfileSharing, customFieldResponses: Array<{fieldId, value}>, guestInfo: { name, email, phone?, organization?, title? } }`
   - Validate:
     - User is authenticated
     - Space exists and has `guestAccessEnabled: true`
     - consentToProfileSharing is true
     - Date format is valid (YYYY-MM-DD)
     - All required custom fields have values
   - Get or create guestProfile using internal mutation
   - Create spaceBooking with `bookingType: 'guest'`, `status: 'pending'`
   - Create visitApplicationResponses for each custom field
   - Schedule `guest_visit_pending` notification to guest
   - Return booking ID

2. `approveGuestVisit` - Org admin approves (GUEST-04)
   - Args: `{ bookingId, message?: string }`
   - Require space admin (use requireSpaceAdmin)
   - Verify booking exists, is guest type, and is pending
   - Patch booking: `status: 'confirmed'`, `approvedBy: membership._id`, `approvedAt: Date.now()`
   - Update guest's visitCount, lastVisitDate, firstVisitDate if needed
   - Schedule `guest_visit_approved` notification with optional message
   - Return success

3. `rejectGuestVisit` - Org admin rejects (GUEST-04)
   - Args: `{ bookingId, rejectionReason: string }`
   - Require space admin
   - Verify booking exists, is guest type, and is pending
   - Patch booking: `status: 'rejected'`, `approvedBy: membership._id`, `approvedAt: Date.now()`, `rejectionReason`
   - Schedule `guest_visit_rejected` notification with reason
   - Return success

4. `batchApproveGuestVisits` - Batch approval (GUEST-10)
   - Args: `{ spaceId, bookingIds: Array<Id<'spaceBookings'>> }`
   - Require space admin
   - For each bookingId:
     - Verify it belongs to this space, is guest, and is pending
     - Patch to confirmed status
     - Update guestProfile visitCount/dates
     - Schedule individual notification
   - Return results array with `{ bookingId, success, error? }`

**Queries:**

1. `getPendingGuestApplications` - For admin review queue
   - Args: `{ spaceId }`
   - Require space admin
   - Return pending guest bookings with guestProfile data and custom field responses

2. `getGuestVisitHistory` - Guest visit history for org (GUEST-09)
   - Args: `{ spaceId, guestUserId?: string }` (admin can query specific guest)
   - Require space admin
   - Return all confirmed/rejected guest bookings, grouped by guest

3. `getMyVisitApplications` - For guests to see their own applications
   - No args except auth
   - Return all visit applications for current user with status

**4. Extend convex/spaceBookings.ts getBookingAttendees:**

Modify `getBookingAttendees` to include approved guests (GUEST-06):

- For bookings with `bookingType: 'guest'`, fetch from `guestProfiles` instead of `profiles`
- Return `isGuest: true` flag for guest attendees
- For guest profile data: `{ name: guestProfile.name, headline: guestProfile.title ?? guestProfile.organization, skills: [] }`
  </action>
  <verify>Run `bun run lint` and ensure no TypeScript errors. Test that all exports are available</verify>
  <done>guestBookings.ts has complete application and approval workflow. getBookingAttendees includes guests with isGuest flag</done>
  </task>

</tasks>

<verification>
After all tasks:
1. `bunx convex dev` runs without schema errors
2. `bun run lint` passes with no TypeScript errors
3. Schema shows guestProfiles and visitApplicationResponses tables
4. All new functions are exported and callable
</verification>

<success_criteria>

- guestProfiles table created with all CONTEXT.md fields
- visitApplicationResponses table created for custom form storage
- spaceBookings extended with approval fields
- notifications extended with guest types
- Guest visit application flow: submit -> pending -> approved/rejected
- Batch approval mutation works
- Attendee query includes approved guests with isGuest flag
- All notifications scheduled via ctx.scheduler.runAfter pattern
  </success_criteria>

<output>
After completion, create `.planning/phases/33-guest/33-01-SUMMARY.md`
</output>
