---
phase: 33-guest
plan: 02
type: execute
wave: 2
depends_on: [33-01]
files_modified:
  - src/routes/org/$slug/visit.tsx
  - src/components/guest/VisitApplicationForm.tsx
  - src/components/guest/GuestSignupForm.tsx
autonomous: true

must_haves:
  truths:
    - 'User can access /org/$slug/visit as a public page'
    - 'Page shows org name and space info before auth'
    - 'Unauthenticated users see signup/signin prompt'
    - 'Authenticated users see the visit application form'
    - 'Form renders custom fields defined by org admin'
    - 'Guest can select a date and time for their visit'
    - 'Form requires consent checkbox before submission'
    - 'Successful submission shows confirmation with pending status'
  artifacts:
    - path: 'src/routes/org/$slug/visit.tsx'
      provides: 'Public visit request page with auth gate'
      min_lines: 150
    - path: 'src/components/guest/VisitApplicationForm.tsx'
      provides: 'Dynamic form rendering custom visit fields'
      exports: ['VisitApplicationForm']
    - path: 'src/components/guest/GuestSignupForm.tsx'
      provides: 'Inline guest signup form'
      exports: ['GuestSignupForm']
  key_links:
    - from: 'src/routes/org/$slug/visit.tsx'
      to: 'api.coworkingSpaces'
      via: 'useQuery for space data'
      pattern: 'useQuery.*getSpaceBySlug'
    - from: 'src/components/guest/VisitApplicationForm.tsx'
      to: 'api.guestBookings.submitVisitApplication'
      via: 'useMutation'
      pattern: 'useMutation.*submitVisitApplication'
---

<objective>
Create the public guest visit request page at `/org/$slug/visit` where non-members can apply to visit a coworking space.

Purpose: Enable guests to discover a space and submit visit applications with minimal friction, using the org-defined custom form fields.
Output: Public route with auth gate, guest signup, and dynamic visit application form.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/33-guest/CONTEXT.md
@.planning/phases/33-guest/33-RESEARCH.md
@.planning/phases/33-guest/33-01-SUMMARY.md
@src/routes/org/$slug/join.tsx
@src/components/org/VisitFieldsEditor.tsx
@src/components/auth/login-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add public space query and create visit.tsx route</name>
  <files>convex/coworkingSpaces.ts, src/routes/org/$slug/visit.tsx</files>
  <action>
**1. Add query to convex/coworkingSpaces.ts:**

Add `getSpaceBySlug` query (public, no auth required):

```typescript
export const getSpaceBySlug = query({
  args: { slug: v.string() },
  handler: async (ctx, { slug }) => {
    // Find org by slug
    const org = await ctx.db
      .query('organizations')
      .withIndex('by_slug', (q) => q.eq('slug', slug))
      .first()

    if (!org) return null

    // Find space for this org
    const space = await ctx.db
      .query('coworkingSpaces')
      .withIndex('by_org', (q) => q.eq('orgId', org._id))
      .first()

    if (!space || !space.guestAccessEnabled) return null

    return {
      spaceId: space._id,
      spaceName: space.name,
      orgId: org._id,
      orgName: org.name,
      orgSlug: org.slug,
      capacity: space.capacity,
      timezone: space.timezone,
      operatingHours: space.operatingHours,
      customVisitFields: space.customVisitFields ?? [],
    }
  },
})
```

**2. Create src/routes/org/$slug/visit.tsx:**

Follow the `/org/$slug/join.tsx` pattern exactly:

```typescript
import { createFileRoute } from '@tanstack/react-router'
import {
  AuthLoading,
  Authenticated,
  Unauthenticated,
  useQuery,
} from 'convex/react'
import { Building2, CalendarClock, UserPlus } from 'lucide-react'
import { api } from '../../../../convex/_generated/api'
import { AuthHeader } from '~/components/layout/auth-header'
import { GradientBg } from '~/components/layout/GradientBg'
import { Card } from '~/components/ui/card'
import { Spinner } from '~/components/ui/spinner'
import { GuestSignupForm } from '~/components/guest/GuestSignupForm'
import { VisitApplicationForm } from '~/components/guest/VisitApplicationForm'

export const Route = createFileRoute('/org/$slug/visit')({
  component: VisitPage,
})

function VisitPage() {
  const { slug } = Route.useParams()
  const spaceData = useQuery(api.coworkingSpaces.getSpaceBySlug, { slug })

  // Loading state
  if (spaceData === undefined) {
    return (
      <GradientBg>
        <AuthHeader />
        <main className="container mx-auto px-4 py-8">
          <div className="flex items-center justify-center min-h-[60vh]">
            <Spinner />
          </div>
        </main>
      </GradientBg>
    )
  }

  // No space or guest access disabled
  if (!spaceData) {
    return (
      <GradientBg>
        <AuthHeader />
        <main className="container mx-auto px-4 py-8">
          <NoAccessMessage />
        </main>
      </GradientBg>
    )
  }

  return (
    <GradientBg>
      <AuthHeader />
      <main className="container mx-auto px-4 py-8">
        <AuthLoading>
          <div className="flex items-center justify-center min-h-[60vh]">
            <Spinner />
          </div>
        </AuthLoading>

        <Unauthenticated>
          <SignupPrompt orgName={spaceData.orgName} spaceName={spaceData.spaceName} />
        </Unauthenticated>

        <Authenticated>
          <VisitApplicationForm space={spaceData} />
        </Authenticated>
      </main>
    </GradientBg>
  )
}

function NoAccessMessage() {
  return (
    <div className="max-w-md mx-auto text-center py-12">
      <div className="size-16 rounded-full bg-amber-50 flex items-center justify-center mx-auto mb-4">
        <Building2 className="size-8 text-amber-500" />
      </div>
      <h1 className="text-2xl font-display text-foreground mb-4">
        Guest Visits Not Available
      </h1>
      <p className="text-slate-600">
        This organization is not currently accepting guest visit applications, or the space does not exist.
      </p>
    </div>
  )
}

function SignupPrompt({ orgName, spaceName }: { orgName: string; spaceName: string }) {
  return (
    <Card className="max-w-md mx-auto p-8 text-center">
      <div className="size-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4">
        <CalendarClock className="size-8 text-primary" />
      </div>
      <h1 className="text-2xl font-display text-foreground mb-2">
        Visit {spaceName}
      </h1>
      <p className="text-slate-600 mb-6">
        Request a day pass to visit {orgName}. Create an account or sign in to submit your application.
      </p>
      <GuestSignupForm />
    </Card>
  )
}
```

The route structure follows join.tsx exactly with:

- Public query (no auth) for space info
- AuthLoading/Unauthenticated/Authenticated gates
- GradientBg + AuthHeader layout
  </action>
  <verify>`bun run lint` passes. Route file exists at correct path</verify>
  <done>Public visit page route exists with auth gate and space validation</done>
  </task>

<task type="auto">
  <name>Task 2: Create GuestSignupForm component with tabbed login/signup</name>
  <files>src/components/guest/GuestSignupForm.tsx</files>
  <action>
Create `src/components/guest/GuestSignupForm.tsx`:

Build an inline auth form with tabs for "Sign in" and "Create account" (following login-card.tsx patterns):

```typescript
import { useAuthActions } from '@convex-dev/auth/react'
import { Loader2 } from 'lucide-react'
import { useState } from 'react'
import { toast } from 'sonner'
import { Button } from '~/components/ui/button'
import { Input } from '~/components/ui/input'
import { Label } from '~/components/ui/label'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '~/components/ui/tabs'

export function GuestSignupForm() {
  const { signIn } = useAuthActions()
  const [isLoading, setIsLoading] = useState(false)
  const [activeTab, setActiveTab] = useState<'signin' | 'signup'>('signup')

  // Sign in form state
  const [signInEmail, setSignInEmail] = useState('')
  const [signInPassword, setSignInPassword] = useState('')

  // Sign up form state
  const [signUpEmail, setSignUpEmail] = useState('')
  const [signUpPassword, setSignUpPassword] = useState('')
  const [signUpName, setSignUpName] = useState('')

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)
    try {
      await signIn('password', {
        email: signInEmail,
        password: signInPassword,
        flow: 'signIn',
      })
      // Auth state change will trigger re-render to Authenticated
    } catch (error) {
      toast.error('Invalid email or password')
    } finally {
      setIsLoading(false)
    }
  }

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault()
    if (signUpPassword.length < 8) {
      toast.error('Password must be at least 8 characters')
      return
    }
    setIsLoading(true)
    try {
      await signIn('password', {
        email: signUpEmail,
        password: signUpPassword,
        name: signUpName,
        flow: 'signUp',
      })
      // Auth state change will trigger re-render to Authenticated
    } catch (error) {
      // Don't reveal if email exists - generic error
      toast.error('Unable to create account. Please try again.')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'signin' | 'signup')}>
      <TabsList className="grid w-full grid-cols-2 mb-6">
        <TabsTrigger value="signup">Create Account</TabsTrigger>
        <TabsTrigger value="signin">Sign In</TabsTrigger>
      </TabsList>

      <TabsContent value="signup">
        <form onSubmit={handleSignUp} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="signup-name">Name</Label>
            <Input
              id="signup-name"
              type="text"
              value={signUpName}
              onChange={(e) => setSignUpName(e.target.value)}
              placeholder="Your name"
              required
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="signup-email">Email</Label>
            <Input
              id="signup-email"
              type="email"
              value={signUpEmail}
              onChange={(e) => setSignUpEmail(e.target.value)}
              placeholder="you@example.com"
              required
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="signup-password">Password</Label>
            <Input
              id="signup-password"
              type="password"
              value={signUpPassword}
              onChange={(e) => setSignUpPassword(e.target.value)}
              placeholder="At least 8 characters"
              required
            />
          </div>
          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? (
              <>
                <Loader2 className="size-4 mr-2 animate-spin" />
                Creating Account...
              </>
            ) : (
              'Create Account'
            )}
          </Button>
        </form>
      </TabsContent>

      <TabsContent value="signin">
        <form onSubmit={handleSignIn} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="signin-email">Email</Label>
            <Input
              id="signin-email"
              type="email"
              value={signInEmail}
              onChange={(e) => setSignInEmail(e.target.value)}
              placeholder="you@example.com"
              required
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="signin-password">Password</Label>
            <Input
              id="signin-password"
              type="password"
              value={signInPassword}
              onChange={(e) => setSignInPassword(e.target.value)}
              placeholder="Your password"
              required
            />
          </div>
          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? (
              <>
                <Loader2 className="size-4 mr-2 animate-spin" />
                Signing In...
              </>
            ) : (
              'Sign In'
            )}
          </Button>
        </form>
      </TabsContent>
    </Tabs>
  )
}
```

Key behaviors:

- Defaults to "Create Account" tab (most guests are new)
- Uses @convex-dev/auth Password provider (same as existing auth)
- Generic error messages to avoid revealing account existence
- Password minimum 8 chars validation
  </action>
  <verify>File exists and exports GuestSignupForm. `bun run lint` passes</verify>
  <done>GuestSignupForm component exists with tabbed signin/signup forms</done>
  </task>

<task type="auto">
  <name>Task 3: Create VisitApplicationForm with dynamic fields, date picker, and submission</name>
  <files>src/components/guest/VisitApplicationForm.tsx</files>
  <action>
Create `src/components/guest/VisitApplicationForm.tsx`:

Build the visit application form that renders custom fields dynamically:

```typescript
import { useMutation, useQuery } from 'convex/react'
import { format, addDays, isBefore, startOfDay } from 'date-fns'
import { Calendar, CheckCircle2, Clock, Loader2 } from 'lucide-react'
import { useState } from 'react'
import { toast } from 'sonner'
import { api } from '../../../convex/_generated/api'
import type { Id } from '../../../convex/_generated/dataModel'
import { Button } from '~/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '~/components/ui/card'
import { Checkbox } from '~/components/ui/checkbox'
import { Input } from '~/components/ui/input'
import { Label } from '~/components/ui/label'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '~/components/ui/select'
import { Textarea } from '~/components/ui/textarea'
import { DayPicker } from 'react-day-picker'
import 'react-day-picker/style.css'

interface SpaceData {
  spaceId: Id<'coworkingSpaces'>
  spaceName: string
  orgId: Id<'organizations'>
  orgName: string
  orgSlug?: string
  capacity: number
  timezone: string
  operatingHours: Array<{
    dayOfWeek: number
    openMinutes: number
    closeMinutes: number
    isClosed: boolean
  }>
  customVisitFields: Array<{
    fieldId: string
    label: string
    type: 'text' | 'textarea' | 'select' | 'checkbox'
    required: boolean
    options?: Array<string>
    placeholder?: string
  }>
}

interface Props {
  space: SpaceData
}

export function VisitApplicationForm({ space }: Props) {
  const submitApplication = useMutation(api.guestBookings.submitVisitApplication)
  const guestProfile = useQuery(api.guestProfiles.getGuestProfile)

  const [selectedDate, setSelectedDate] = useState<Date | undefined>()
  const [selectedStartMinutes, setSelectedStartMinutes] = useState<number | null>(null)
  const [selectedEndMinutes, setSelectedEndMinutes] = useState<number | null>(null)
  const [customFieldValues, setCustomFieldValues] = useState<Record<string, string>>({})
  const [consentChecked, setConsentChecked] = useState(false)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [submitted, setSubmitted] = useState(false)

  // Guest info (pre-filled from guestProfile if exists)
  const [guestName, setGuestName] = useState(guestProfile?.name ?? '')
  const [guestEmail, setGuestEmail] = useState(guestProfile?.email ?? '')
  const [guestPhone, setGuestPhone] = useState(guestProfile?.phone ?? '')
  const [guestOrganization, setGuestOrganization] = useState(guestProfile?.organization ?? '')
  const [guestTitle, setGuestTitle] = useState(guestProfile?.title ?? '')

  // Update guest info when profile loads
  if (guestProfile && !guestName) {
    setGuestName(guestProfile.name)
    setGuestEmail(guestProfile.email)
    setGuestPhone(guestProfile.phone ?? '')
    setGuestOrganization(guestProfile.organization ?? '')
    setGuestTitle(guestProfile.title ?? '')
  }

  // Disable days in the past and closed days
  const disabledDays = (date: Date) => {
    // Past dates
    if (isBefore(date, startOfDay(new Date()))) return true
    // Closed days
    const dayOfWeek = date.getDay()
    const dayConfig = space.operatingHours.find((d) => d.dayOfWeek === dayOfWeek)
    return dayConfig?.isClosed ?? false
  }

  // Get operating hours for selected day
  const selectedDayHours = selectedDate
    ? space.operatingHours.find((d) => d.dayOfWeek === selectedDate.getDay())
    : null

  // Generate time options based on operating hours
  const timeOptions = selectedDayHours && !selectedDayHours.isClosed
    ? generateTimeOptions(selectedDayHours.openMinutes, selectedDayHours.closeMinutes)
    : []

  const handleCustomFieldChange = (fieldId: string, value: string) => {
    setCustomFieldValues((prev) => ({ ...prev, [fieldId]: value }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!selectedDate || selectedStartMinutes === null || selectedEndMinutes === null) {
      toast.error('Please select a date and time')
      return
    }

    if (!consentChecked) {
      toast.error('Please consent to profile sharing')
      return
    }

    if (!guestName || !guestEmail) {
      toast.error('Please provide your name and email')
      return
    }

    // Validate required custom fields
    for (const field of space.customVisitFields) {
      if (field.required && !customFieldValues[field.fieldId]) {
        toast.error(`Please fill in: ${field.label}`)
        return
      }
    }

    setIsSubmitting(true)
    try {
      await submitApplication({
        spaceId: space.spaceId,
        date: format(selectedDate, 'yyyy-MM-dd'),
        startMinutes: selectedStartMinutes,
        endMinutes: selectedEndMinutes,
        consentToProfileSharing: true,
        customFieldResponses: Object.entries(customFieldValues).map(([fieldId, value]) => ({
          fieldId,
          value,
        })),
        guestInfo: {
          name: guestName,
          email: guestEmail,
          phone: guestPhone || undefined,
          organization: guestOrganization || undefined,
          title: guestTitle || undefined,
        },
      })

      setSubmitted(true)
      toast.success('Visit application submitted!')
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Failed to submit application')
    } finally {
      setIsSubmitting(false)
    }
  }

  if (submitted) {
    return (
      <Card className="max-w-lg mx-auto">
        <CardContent className="pt-6 text-center">
          <div className="size-16 rounded-full bg-green-50 flex items-center justify-center mx-auto mb-4">
            <CheckCircle2 className="size-8 text-green-600" />
          </div>
          <h2 className="text-xl font-display mb-2">Application Submitted</h2>
          <p className="text-slate-600 mb-4">
            Your visit request for {format(selectedDate!, 'MMMM d, yyyy')} has been submitted.
            You'll receive a notification when {space.orgName} reviews your application.
          </p>
          <p className="text-sm text-slate-500">
            Status: <span className="text-amber-600 font-medium">Pending Review</span>
          </p>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card className="max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Calendar className="size-5" />
          Request a Visit to {space.spaceName}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Guest Info Section */}
          <div className="space-y-4">
            <h3 className="font-medium text-sm text-slate-700">Your Information</h3>
            <div className="grid gap-4 sm:grid-cols-2">
              <div className="space-y-2">
                <Label htmlFor="guest-name">Name *</Label>
                <Input
                  id="guest-name"
                  value={guestName}
                  onChange={(e) => setGuestName(e.target.value)}
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="guest-email">Email *</Label>
                <Input
                  id="guest-email"
                  type="email"
                  value={guestEmail}
                  onChange={(e) => setGuestEmail(e.target.value)}
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="guest-phone">Phone</Label>
                <Input
                  id="guest-phone"
                  type="tel"
                  value={guestPhone}
                  onChange={(e) => setGuestPhone(e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="guest-org">Organization</Label>
                <Input
                  id="guest-org"
                  value={guestOrganization}
                  onChange={(e) => setGuestOrganization(e.target.value)}
                />
              </div>
            </div>
          </div>

          {/* Date Selection */}
          <div className="space-y-2">
            <h3 className="font-medium text-sm text-slate-700">Select a Date</h3>
            <DayPicker
              mode="single"
              selected={selectedDate}
              onSelect={setSelectedDate}
              disabled={disabledDays}
              fromDate={new Date()}
              toDate={addDays(new Date(), 60)}
              className="border rounded-lg p-2"
            />
          </div>

          {/* Time Selection */}
          {selectedDate && selectedDayHours && !selectedDayHours.isClosed && (
            <div className="grid gap-4 sm:grid-cols-2">
              <div className="space-y-2">
                <Label>Arrival Time</Label>
                <Select
                  value={selectedStartMinutes?.toString()}
                  onValueChange={(v) => setSelectedStartMinutes(parseInt(v))}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select arrival time" />
                  </SelectTrigger>
                  <SelectContent>
                    {timeOptions.slice(0, -1).map((opt) => (
                      <SelectItem key={opt.value} value={opt.value.toString()}>
                        {opt.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Departure Time</Label>
                <Select
                  value={selectedEndMinutes?.toString()}
                  onValueChange={(v) => setSelectedEndMinutes(parseInt(v))}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select departure time" />
                  </SelectTrigger>
                  <SelectContent>
                    {timeOptions
                      .filter((opt) => selectedStartMinutes === null || opt.value > selectedStartMinutes)
                      .map((opt) => (
                        <SelectItem key={opt.value} value={opt.value.toString()}>
                          {opt.label}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          )}

          {/* Custom Fields */}
          {space.customVisitFields.length > 0 && (
            <div className="space-y-4">
              <h3 className="font-medium text-sm text-slate-700">Additional Information</h3>
              {space.customVisitFields.map((field) => (
                <div key={field.fieldId} className="space-y-2">
                  <Label htmlFor={field.fieldId}>
                    {field.label}
                    {field.required && ' *'}
                  </Label>
                  {renderField(field, customFieldValues[field.fieldId] ?? '', (v) =>
                    handleCustomFieldChange(field.fieldId, v),
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Consent Checkbox */}
          <div className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg">
            <Checkbox
              id="consent"
              checked={consentChecked}
              onCheckedChange={(checked) => setConsentChecked(checked === true)}
            />
            <label htmlFor="consent" className="text-sm text-slate-600 leading-tight">
              I consent to sharing my profile information (name, organization) with other attendees on the day of my visit.
              This helps facilitate introductions and collaboration.
            </label>
          </div>

          {/* Submit Button */}
          <Button
            type="submit"
            className="w-full"
            disabled={isSubmitting || !selectedDate || selectedStartMinutes === null || !consentChecked}
          >
            {isSubmitting ? (
              <>
                <Loader2 className="size-4 mr-2 animate-spin" />
                Submitting...
              </>
            ) : (
              'Submit Visit Request'
            )}
          </Button>
        </form>
      </CardContent>
    </Card>
  )
}

// Helper to render custom fields based on type
function renderField(
  field: SpaceData['customVisitFields'][0],
  value: string,
  onChange: (v: string) => void,
) {
  switch (field.type) {
    case 'text':
      return (
        <Input
          id={field.fieldId}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={field.placeholder}
        />
      )
    case 'textarea':
      return (
        <Textarea
          id={field.fieldId}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={field.placeholder}
          rows={3}
        />
      )
    case 'select':
      return (
        <Select value={value} onValueChange={onChange}>
          <SelectTrigger>
            <SelectValue placeholder={field.placeholder ?? 'Select an option'} />
          </SelectTrigger>
          <SelectContent>
            {field.options?.map((opt) => (
              <SelectItem key={opt} value={opt}>
                {opt}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      )
    case 'checkbox':
      return (
        <div className="flex items-center gap-2">
          <Checkbox
            id={field.fieldId}
            checked={value === 'true'}
            onCheckedChange={(checked) => onChange(checked ? 'true' : 'false')}
          />
          <label htmlFor={field.fieldId} className="text-sm">
            {field.placeholder ?? 'Yes'}
          </label>
        </div>
      )
  }
}

// Generate 30-min interval time options
function generateTimeOptions(openMinutes: number, closeMinutes: number) {
  const options: Array<{ value: number; label: string }> = []
  for (let mins = openMinutes; mins <= closeMinutes; mins += 30) {
    const hours = Math.floor(mins / 60)
    const minutes = mins % 60
    const ampm = hours >= 12 ? 'PM' : 'AM'
    const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours
    const label = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
    options.push({ value: mins, label })
  }
  return options
}
```

Key features:

- Pre-fills from existing guestProfile if user has visited before
- Disabled days based on space operating hours and past dates
- Time selection filtered to operating hours
- Dynamic custom field rendering (all 4 types)
- Consent checkbox required
- Success state shows pending status
  </action>
  <verify>`bun run lint` passes. Component exports VisitApplicationForm</verify>
  <done>VisitApplicationForm component exists with date picker, time selection, dynamic custom fields, and submission logic</done>
  </task>

</tasks>

<verification>
After all tasks:
1. Navigate to `/org/[existing-slug]/visit` - should show the guest access page
2. If not logged in, see signup/signin form
3. After auth, see the visit application form
4. Form shows custom fields defined for the space
5. Can select date, time, fill fields, consent, and submit
6. Submission creates pending booking in database
</verification>

<success_criteria>

- Public route `/org/$slug/visit` loads space data without auth
- Unauthenticated users see tabbed signup/signin form
- Authenticated users see visit application form
- Form renders all custom field types correctly
- Date picker disables past dates and closed days
- Time selection respects operating hours
- Consent checkbox is required
- Successful submission shows confirmation with pending status
  </success_criteria>

<output>
After completion, create `.planning/phases/33-guest/33-02-SUMMARY.md`
</output>
