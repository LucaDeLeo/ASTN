---
phase: 34-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/spaceBookings/admin.ts
autonomous: true

must_haves:
  truths:
    - "Admin queries return today's bookings with member and guest profiles"
    - 'Admin can fetch bookings for any date range'
    - 'Admin can get utilization stats (weekly/monthly rates, peak days)'
    - 'Admin can get guest conversion metrics'
    - 'Admin can create bookings on behalf of members'
    - 'Admin can cancel any booking'
  artifacts:
    - path: 'convex/spaceBookings/admin.ts'
      provides: 'Admin booking queries and mutations'
      exports:
        [
          'getTodaysBookings',
          'getAdminBookingsForDateRange',
          'getSpaceUtilizationStats',
          'getGuestConversionStats',
          'adminCreateBooking',
          'adminCancelBooking',
        ]
  key_links:
    - from: 'convex/spaceBookings/admin.ts'
      to: 'convex/lib/auth.ts'
      via: 'requireSpaceAdmin helper'
      pattern: 'requireSpaceAdmin'
    - from: 'convex/spaceBookings/admin.ts'
      to: 'convex/schema.ts'
      via: 'spaceBookings table queries'
      pattern: 'spaceBookings'
---

<objective>
Create backend admin queries and mutations for booking management dashboard.

Purpose: Enable org admins to view, filter, and manage all bookings (member + guest) with statistics for utilization tracking.
Output: New `convex/spaceBookings/admin.ts` file with 6 queries/mutations for admin booking operations.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-admin/CONTEXT.md

# Existing patterns to follow

@convex/guestBookings.ts (admin mutation patterns with requireSpaceAdmin)
@convex/spaceBookings.ts (existing member booking queries)
@convex/lib/auth.ts (requireSpaceAdmin helper)
@convex/schema.ts (spaceBookings, guestProfiles tables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin booking queries</name>
  <files>convex/spaceBookings/admin.ts</files>
  <action>
Create new file `convex/spaceBookings/admin.ts` with admin booking queries. Follow the pattern from `convex/guestBookings.ts` for auth checks.

**Queries to implement:**

1. `getTodaysBookings` - Returns today's confirmed bookings (member + guest) with profile data
   - Args: `{ spaceId: v.id('coworkingSpaces') }`
   - Uses `requireSpaceAdmin` for auth
   - Gets today's date in space's timezone (use space.timezone)
   - Returns bookings with enriched profile data (name, headline, skills for members; name, org, title for guests)
   - Sort by startMinutes ascending

2. `getAdminBookingsForDateRange` - Paginated bookings for calendar/list/history views
   - Args: `{ spaceId, startDate: v.string(), endDate: v.string(), status: v.optional(v.union(...)), limit: v.optional(v.number()), cursor: v.optional(v.string()) }`
   - Status filter: 'all' | 'confirmed' | 'cancelled' | 'pending' | 'rejected'
   - Include profile data for each booking
   - Include custom field responses for guest bookings (join visitApplicationResponses)
   - Return `{ bookings, nextCursor, hasMore }`

3. `getSpaceUtilizationStats` - Aggregated utilization metrics
   - Args: `{ spaceId, startDate: v.string(), endDate: v.string() }`
   - Calculate:
     - `totalBookings`: Count of confirmed bookings in range
     - `averageDaily`: totalBookings / days in range
     - `utilizationRate`: (totalBookings / (capacity _ days)) _ 100
     - `peakDays`: Array of { dayOfWeek: number, count: number } sorted by count desc
     - `memberVsGuest`: { memberCount, guestCount }
   - Return stats object

4. `getGuestConversionStats` - Guest to member conversion metrics
   - Args: `{ spaceId }`
   - Get all guestProfiles who have visited this space (via spaceBookings)
   - Count those with `becameMember: true`
   - Return `{ totalGuests, convertedGuests, conversionRate }`

**Use these patterns:**

- Import `requireSpaceAdmin` from `./lib/auth` (relative import from convex root)
- Import `v` from 'convex/values'
- Import `query` from './\_generated/server'
- Use proper TypeScript types for return values
  </action>
  <verify>TypeScript build passes: `cd /Users/luca/conductor/workspaces/ASTN/spokane && npx tsc --noEmit`</verify>
  <done>Four admin queries exist in convex/spaceBookings/admin.ts, all using requireSpaceAdmin for authorization</done>
  </task>

<task type="auto">
  <name>Task 2: Create admin booking mutations</name>
  <files>convex/spaceBookings/admin.ts</files>
  <action>
Add admin mutations to `convex/spaceBookings/admin.ts`:

1. `adminCreateBooking` - Create booking on behalf of a member (ADMIN-06)
   - Args: `{ spaceId, userId: v.string(), date, startMinutes, endMinutes, workingOn?: string, interestedInMeeting?: string }`
   - Uses `requireSpaceAdmin` for auth
   - Verify target userId is a member of the org (query orgMemberships)
   - Auto-set `consentToProfileSharing: true` (admin is creating on behalf)
   - Auto-set `status: 'confirmed'` and `bookingType: 'member'`
   - Check for existing booking on same date for that user
   - Return `{ bookingId, capacityWarning }` (same pattern as createMemberBooking)

2. `adminCancelBooking` - Cancel any booking (ADMIN-06)
   - Args: `{ bookingId: v.id('spaceBookings') }`
   - Uses `requireSpaceAdmin` for auth (get spaceId from booking)
   - Can cancel any booking (member or guest, any status except already cancelled)
   - Update status to 'cancelled', set cancelledAt
   - Return `{ success: true }`

**Import patterns:**

- Add `mutation` to imports from './\_generated/server'
- Follow the same validation patterns from `convex/spaceBookings.ts` (tag length limits, date format validation)
  </action>
  <verify>TypeScript build passes: `cd /Users/luca/conductor/workspaces/ASTN/spokane && npx tsc --noEmit`</verify>
  <done>adminCreateBooking and adminCancelBooking mutations exist and use requireSpaceAdmin for authorization</done>
  </task>

<task type="auto">
  <name>Task 3: Export and verify integration</name>
  <files>convex/spaceBookings/admin.ts</files>
  <action>
Ensure the new admin file is properly integrated:

1. Verify all exports are named exports (no default export)
2. Check that convex/\_generated/api.ts will pick up the new file (Convex auto-generates)
3. Run `npx convex dev --once` to verify the functions compile and deploy locally

The file structure should be:

```
convex/
  spaceBookings.ts       (existing member queries/mutations)
  spaceBookings/
    admin.ts             (new admin queries/mutations)
```

This follows the established pattern (see convex/orgs/admin.ts).

**Final verification:**

- All 6 functions exported: getTodaysBookings, getAdminBookingsForDateRange, getSpaceUtilizationStats, getGuestConversionStats, adminCreateBooking, adminCancelBooking
- No TypeScript errors
- Convex generates API types correctly
  </action>
  <verify>

1. TypeScript passes: `npx tsc --noEmit`
2. Convex compiles: `npx convex dev --once` shows no errors for the new file
   </verify>
   <done>All 6 admin booking functions are exported and accessible via api.spaceBookings.admin.\*</done>
   </task>

</tasks>

<verification>
1. TypeScript compilation passes without errors
2. Convex generates API for new functions at api.spaceBookings.admin.*
3. All queries use requireSpaceAdmin for authorization
4. Utilization stats calculate rates correctly
5. Admin mutations follow existing patterns (validation, error messages)
</verification>

<success_criteria>

- convex/spaceBookings/admin.ts exists with 6 exported functions
- getTodaysBookings returns bookings with profile data
- getAdminBookingsForDateRange supports date filtering and pagination
- getSpaceUtilizationStats returns utilization metrics
- getGuestConversionStats returns conversion metrics
- adminCreateBooking creates bookings on behalf of members
- adminCancelBooking can cancel any booking
- All functions use requireSpaceAdmin for authorization
  </success_criteria>

<output>
After completion, create `.planning/phases/34-admin/34-01-SUMMARY.md`
</output>
