---
phase: 34-admin
plan: 03
type: execute
wave: 2
depends_on: ['34-01']
files_modified:
  - src/components/org/AddBookingDialog.tsx
  - src/components/org/BookingExportButton.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can manually add a booking on behalf of a member'
    - 'Admin can cancel any booking'
    - 'Admin can export booking data as CSV'
  artifacts:
    - path: 'src/components/org/AddBookingDialog.tsx'
      provides: 'Dialog for creating bookings on behalf of members'
      min_lines: 100
    - path: 'src/components/org/BookingExportButton.tsx'
      provides: 'CSV export button following ExportButton pattern'
      min_lines: 60
  key_links:
    - from: 'src/components/org/AddBookingDialog.tsx'
      to: 'api.spaceBookings.admin.adminCreateBooking'
      via: 'useMutation hook'
      pattern: 'adminCreateBooking'
    - from: 'src/components/org/BookingExportButton.tsx'
      to: 'api.spaceBookings.admin.getAdminBookingsForDateRange'
      via: 'useQuery for data'
      pattern: 'getAdminBookingsForDateRange'
---

<objective>
Create manual booking management and CSV export functionality for admin dashboard.

Purpose: Enable admins to add bookings on behalf of members and export booking data (ADMIN-06, ADMIN-09).
Output: AddBookingDialog and BookingExportButton components ready for integration into bookings page.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-admin/CONTEXT.md

# Existing patterns to follow

@src/components/org/ExportButton.tsx (CSV export pattern)
@src/components/dialogs/CreateProgramDialog.tsx (dialog pattern)
@src/routes/org/$slug/book.tsx (date/time picker patterns)
@convex/spaceBookings/admin.ts (mutations from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddBookingDialog component</name>
  <files>src/components/org/AddBookingDialog.tsx</files>
  <action>
Create `src/components/org/AddBookingDialog.tsx` - dialog for creating bookings on behalf of members.

**Component interface:**

```typescript
interface AddBookingDialogProps {
  spaceId: Id<'coworkingSpaces'>
  orgId: Id<'organizations'>
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess?: () => void
}
```

**Implementation:**

1. Use Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter from shadcn/ui
2. Form fields:
   - Member selector (dropdown of org members)
   - Date picker (single date using react-day-picker)
   - Start time selector (Select with 30-min increments, 6 AM - 10 PM)
   - End time selector (Select with 30-min increments, after start time)
   - Working on (optional textarea, max 140 chars)
   - Interested in meeting (optional textarea, max 140 chars)

3. Fetch org members for selector:

```typescript
const members = useQuery(api.orgs.admin.getAllMembersWithProfiles, { orgId })
```

4. On submit:
   - Call `adminCreateBooking` mutation
   - Show capacity warning if returned
   - Show success toast
   - Close dialog and call onSuccess

5. Validation:
   - Member required
   - Date required (can't be in past)
   - Start time required
   - End time required (must be after start)
   - Tag length limits (140 chars)

6. Error handling:
   - Show error toast if mutation fails
   - Common error: "User already has booking for this date"

**Time conversion utility:**

```typescript
function timeToMinutes(hours: number, minutes: number): number {
  return hours * 60 + minutes
}

function generateTimeOptions(): Array<{ label: string; value: number }> {
  const options = []
  for (let hour = 6; hour <= 22; hour++) {
    for (let min = 0; min < 60; min += 30) {
      const minutes = hour * 60 + min
      const displayHour = hour % 12 || 12
      const period = hour >= 12 ? 'PM' : 'AM'
      const label =
        min === 0 ? `${displayHour} ${period}` : `${displayHour}:30 ${period}`
      options.push({ label, value: minutes })
    }
  }
  return options
}
```

  </action>
  <verify>TypeScript build passes: `cd /Users/luca/conductor/workspaces/ASTN/spokane && npx tsc --noEmit`</verify>
  <done>AddBookingDialog component exists with member selector, date/time pickers, and calls adminCreateBooking mutation</done>
</task>

<task type="auto">
  <name>Task 2: Create BookingExportButton component</name>
  <files>src/components/org/BookingExportButton.tsx</files>
  <action>
Create `src/components/org/BookingExportButton.tsx` - CSV export button following ExportButton.tsx pattern exactly.

**Component interface:**

```typescript
interface BookingExportButtonProps {
  spaceId: Id<'coworkingSpaces'>
  spaceName: string
  orgSlug: string
  startDate: string // ISO date for export range
  endDate: string
}
```

**Implementation:**

1. Follow ExportButton.tsx pattern exactly:
   - DropdownMenu with CSV and JSON options
   - Client-side generation
   - Same escapeCsvField and downloadBlob helpers

2. Fetch booking data:

```typescript
const bookings = useQuery(
  api.spaceBookings.admin.getAdminBookingsForDateRange,
  {
    spaceId,
    startDate,
    endDate,
    status: 'all', // Export all statuses
  },
)
```

3. CSV columns:
   - Date
   - Name (member name or guest name)
   - Email (if available from profile)
   - Type (Member / Guest)
   - Status (Confirmed / Cancelled / Pending / Rejected)
   - Time Range (formatted)
   - Working On
   - Interested In Meeting
   - Created At (ISO date)
   - Approved By (for guests, admin name if available)
   - Rejection Reason (if rejected)

4. JSON export includes full booking objects

5. Filename format: `{orgSlug}-bookings-{startDate}-to-{endDate}.{format}`

**Reuse these helpers from ExportButton.tsx pattern:**

```typescript
function escapeCsvField(value: string): string {
  if (!value) return '""'
  const escaped = value.replace(/"/g, '""')
  if (
    escaped.includes(',') ||
    escaped.includes('\n') ||
    escaped.includes('"')
  ) {
    return `"${escaped}"`
  }
  return escaped || '""'
}

function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = filename
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(url)
}
```

  </action>
  <verify>TypeScript build passes: `cd /Users/luca/conductor/workspaces/ASTN/spokane && npx tsc --noEmit`</verify>
  <done>BookingExportButton component exists with CSV and JSON export options</done>
</task>

<task type="auto">
  <name>Task 3: Create cancel booking functionality</name>
  <files>src/components/org/BookingCard.tsx</files>
  <action>
Create `src/components/org/BookingCard.tsx` - reusable card component for displaying bookings with admin actions.

**Component interface:**

```typescript
interface BookingCardProps {
  booking: {
    _id: Id<'spaceBookings'>
    date: string
    startMinutes: number
    endMinutes: number
    bookingType: 'member' | 'guest'
    status: 'confirmed' | 'cancelled' | 'pending' | 'rejected'
    workingOn?: string
    interestedInMeeting?: string
    rejectionReason?: string
    profile: {
      name: string
      headline?: string
    } | null
  }
  showCancelButton?: boolean
  onCancelled?: () => void
}
```

**Implementation:**

1. Card layout:
   - Avatar with first letter of name
   - Name and headline
   - Time range formatted
   - Guest/Member badge
   - Status badge (confirmed=green, cancelled=slate, pending=amber, rejected=red)
   - Working on and interested in meeting tags
   - Rejection reason (if rejected)

2. Cancel button (if showCancelButton=true and status is confirmed or pending):
   - Button with X icon
   - Confirmation dialog: "Cancel booking for [name] on [date]?"
   - Call adminCancelBooking mutation
   - Show success/error toast
   - Call onCancelled callback

3. Use AlertDialog for cancel confirmation:

```typescript
<AlertDialog>
  <AlertDialogTrigger asChild>
    <Button variant="ghost" size="sm"><X className="size-4" /></Button>
  </AlertDialogTrigger>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Cancel Booking</AlertDialogTitle>
      <AlertDialogDescription>
        Cancel {profile?.name}'s booking for {formatDate(date)}?
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Keep Booking</AlertDialogCancel>
      <AlertDialogAction onClick={handleCancel}>Cancel Booking</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

**Note:** This component will be used by BookingList, BookingHistory, and TodayBookings. Those components should be updated in Plan 04 to use this card.
</action>
<verify>TypeScript build passes: `cd /Users/luca/conductor/workspaces/ASTN/spokane && npx tsc --noEmit`</verify>
<done>BookingCard component exists with display and cancel functionality</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. AddBookingDialog can select a member, pick date/time, and create booking
3. BookingExportButton downloads CSV with all booking data
4. BookingCard shows booking details with cancel button
5. Cancel confirmation prevents accidental cancellation
</verification>

<success_criteria>

- Admin can open AddBookingDialog, select member, pick date/time, and create booking (ADMIN-06)
- Admin can cancel any booking via BookingCard with confirmation (ADMIN-06)
- Admin can export bookings as CSV via BookingExportButton (ADMIN-09)
- Components are ready for integration into bookings page
  </success_criteria>

<output>
After completion, create `.planning/phases/34-admin/34-03-SUMMARY.md`
</output>
