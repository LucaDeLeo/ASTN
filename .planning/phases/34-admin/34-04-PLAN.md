---
phase: 34-admin
plan: 04
type: execute
wave: 3
depends_on: ['34-02', '34-03']
files_modified:
  - src/routes/org/$slug/admin/index.tsx
  - src/routes/org/$slug/admin/bookings.tsx
  - src/components/org/SpaceUtilizationCard.tsx
  - src/components/org/GuestConversionCard.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin dashboard shows space utilization statistics'
    - 'Admin dashboard shows guest conversion metrics'
    - 'Admin dashboard has quick link to bookings page'
    - 'Bookings page integrates manual booking and export features'
  artifacts:
    - path: 'src/components/org/SpaceUtilizationCard.tsx'
      provides: 'Utilization stats card for dashboard'
      min_lines: 60
    - path: 'src/components/org/GuestConversionCard.tsx'
      provides: 'Guest conversion stats card'
      min_lines: 40
  key_links:
    - from: 'src/routes/org/$slug/admin/index.tsx'
      to: 'api.spaceBookings.admin.getSpaceUtilizationStats'
      via: 'useQuery'
      pattern: 'getSpaceUtilizationStats'
    - from: 'src/routes/org/$slug/admin/bookings.tsx'
      to: 'src/components/org/AddBookingDialog.tsx'
      via: 'dialog integration'
      pattern: 'AddBookingDialog'
---

<objective>
Integrate utilization statistics into admin dashboard and finalize bookings page with all features.

Purpose: Complete the admin dashboard with space stats (ADMIN-07, ADMIN-08) and wire all components together.
Output: Updated admin dashboard with stats cards, fully integrated bookings page with add/export/cancel.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-admin/CONTEXT.md

# Files from prior plans

@src/routes/org/$slug/admin/index.tsx (existing dashboard)
@src/routes/org/$slug/admin/bookings.tsx (from Plan 02)
@src/components/org/AddBookingDialog.tsx (from Plan 03)
@src/components/org/BookingExportButton.tsx (from Plan 03)
@src/components/org/BookingCard.tsx (from Plan 03)
@src/components/org/OrgStats.tsx (stats visualization patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpaceUtilizationCard and GuestConversionCard</name>
  <files>src/components/org/SpaceUtilizationCard.tsx, src/components/org/GuestConversionCard.tsx</files>
  <action>
Create stat card components for the admin dashboard.

**SpaceUtilizationCard.tsx:**

```typescript
interface SpaceUtilizationCardProps {
  spaceId: Id<'coworkingSpaces'>
  spaceName: string
}
```

Implementation:

1. Fetch stats: `useQuery(api.spaceBookings.admin.getSpaceUtilizationStats, { spaceId, startDate: 30daysAgo, endDate: today })`
2. Card content:
   - Title: "{spaceName} Utilization" with BarChart icon
   - Main stat: "{utilizationRate}% utilization (last 30 days)"
   - Sub-stats in a grid:
     - Total bookings: {totalBookings}
     - Daily average: {averageDaily.toFixed(1)}
     - Member/Guest split: {memberCount} / {guestCount}
   - Peak days visualization:
     - Show top 3 peak days (e.g., "Tue: 12, Wed: 10, Thu: 8")
     - Use mini bar chart or just text with counts

3. Follow OrgStats.tsx DistributionBar pattern for peak days

**GuestConversionCard.tsx:**

```typescript
interface GuestConversionCardProps {
  spaceId: Id<'coworkingSpaces'>
}
```

Implementation:

1. Fetch stats: `useQuery(api.spaceBookings.admin.getGuestConversionStats, { spaceId })`
2. Card content:
   - Title: "Guest Conversions" with UserPlus icon
   - Main stat: "{convertedGuests} of {totalGuests} guests became members"
   - Conversion rate: "{conversionRate}% conversion rate"
   - Visual indicator: Progress bar showing conversion rate

3. Empty state if no guests yet: "No guest visits recorded yet"

**Shared styling:**

- Use Card, CardHeader, CardTitle, CardContent from shadcn/ui
- Match existing quick stats card styling from admin/index.tsx
- Use appropriate icons from lucide-react
  </action>
  <verify>TypeScript build passes: `cd /Users/luca/conductor/workspaces/ASTN/spokane && npx tsc --noEmit`</verify>
  <done>SpaceUtilizationCard and GuestConversionCard components show space statistics</done>
  </task>

<task type="auto">
  <name>Task 2: Update admin dashboard with stats cards</name>
  <files>src/routes/org/$slug/admin/index.tsx</files>
  <action>
Update the admin dashboard to include space utilization and guest conversion stats.

**Changes to admin/index.tsx:**

1. Add query for space:

```typescript
const space = useQuery(
  api.coworkingSpaces.getSpaceByOrg,
  org && membership?.role === 'admin' ? { orgId: org._id } : 'skip',
)
```

2. Update quick actions grid to include Bookings link:
   - Add new button between "Co-working" and "Settings":

```typescript
<Button variant="outline" className="h-auto py-4" asChild>
  <Link to="/org/$slug/admin/bookings" params={{ slug }}>
    <CalendarCheck className="size-5 mr-2" />
    Bookings
  </Link>
</Button>
```

3. Add space stats section (only if space exists):

```typescript
{space && (
  <div className="mt-8">
    <div className="flex items-center justify-between mb-6">
      <div>
        <h2 className="text-lg font-semibold text-foreground">
          Co-working Statistics
        </h2>
        <p className="text-sm text-slate-500">
          Space utilization and guest conversion tracking
        </p>
      </div>
    </div>
    <div className="grid gap-4 md:grid-cols-2">
      <SpaceUtilizationCard spaceId={space._id} spaceName={space.name} />
      <GuestConversionCard spaceId={space._id} />
    </div>
  </div>
)}
```

4. Add imports:

```typescript
import { SpaceUtilizationCard } from '~/components/org/SpaceUtilizationCard'
import { GuestConversionCard } from '~/components/org/GuestConversionCard'
import { CalendarCheck } from 'lucide-react'
```

**Conditional rendering:**

- Only show co-working stats section if org has a configured space
- Stats cards handle their own loading states
  </action>
  <verify>

1. TypeScript passes: `npx tsc --noEmit`
2. Navigate to `/org/[slug]/admin` shows Bookings button in quick actions
3. If space exists, shows Co-working Statistics section with both cards
   </verify>
   <done>Admin dashboard shows space utilization and guest conversion stats, has Bookings quick action</done>
   </task>

<task type="auto">
  <name>Task 3: Integrate all features into bookings page</name>
  <files>src/routes/org/$slug/admin/bookings.tsx</files>
  <action>
Update the bookings page to include manual booking, export, and cancel functionality.

**Add to bookings.tsx:**

1. Add state for AddBookingDialog:

```typescript
const [addBookingOpen, setAddBookingOpen] = useState(false)
```

2. Add header actions (after the page header, before tabs):

```typescript
<div className="flex items-center gap-2 mb-6">
  <Button onClick={() => setAddBookingOpen(true)}>
    <Plus className="size-4 mr-2" />
    Add Booking
  </Button>
  <BookingExportButton
    spaceId={space._id}
    spaceName={space.name}
    orgSlug={slug}
    startDate={thirtyDaysAgo}
    endDate={today}
  />
</div>

<AddBookingDialog
  spaceId={space._id}
  orgId={org._id}
  open={addBookingOpen}
  onOpenChange={setAddBookingOpen}
  onSuccess={() => {
    // Queries will auto-refresh
    toast.success('Booking created')
  }}
/>
```

3. Update BookingList and BookingHistory to use BookingCard:
   - Replace inline booking items with BookingCard component
   - Pass `showCancelButton={true}` for admin view
   - Pass `onCancelled` callback to trigger refetch if needed

4. Add imports:

```typescript
import { Plus } from 'lucide-react'
import { AddBookingDialog } from '~/components/org/AddBookingDialog'
import { BookingExportButton } from '~/components/org/BookingExportButton'
import { BookingCard } from '~/components/org/BookingCard'
import { toast } from 'sonner'
```

5. Compute date ranges:

```typescript
const today = new Date().toISOString().split('T')[0]
const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
  .toISOString()
  .split('T')[0]
const thirtyDaysFromNow = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
  .toISOString()
  .split('T')[0]
```

**Update child components if needed:**

- TodayBookings: use BookingCard with showCancelButton
- BookingList: use BookingCard with showCancelButton
- BookingHistory: use BookingCard with showCancelButton
  </action>
  <verify>

1. TypeScript passes: `npx tsc --noEmit`
2. Bookings page shows "Add Booking" button that opens dialog
3. Bookings page shows Export dropdown
4. Booking cards have cancel buttons that work
   </verify>
   <done>Bookings page has Add Booking, Export, and Cancel functionality fully integrated</done>
   </task>

</tasks>

<verification>
1. TypeScript compilation passes
2. Admin dashboard shows space stats (if space configured)
3. Admin dashboard has Bookings quick action
4. Bookings page has Add Booking button that opens dialog
5. Bookings page has Export button with CSV/JSON options
6. All booking cards have cancel buttons
7. Cancel confirmation works correctly
</verification>

<success_criteria>

- Admin sees utilization statistics on dashboard (ADMIN-07)
- Admin sees guest conversion metrics on dashboard (ADMIN-08)
- Admin can add booking via dialog (ADMIN-06)
- Admin can cancel any booking via card button (ADMIN-06)
- Admin can export bookings as CSV (ADMIN-09)
- All features are integrated and working together
  </success_criteria>

<output>
After completion, create `.planning/phases/34-admin/34-04-SUMMARY.md`
</output>
