---
phase: 35-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/careerActions/validation.ts
  - convex/careerActions/queries.ts
  - convex/careerActions/mutations.ts
autonomous: true

must_haves:
  truths:
    - 'careerActions table exists in schema with 8-type union, 5-status union, profileBasis, and timestamp fields'
    - 'Public getMyActions query returns actions grouped by status (active, inProgress, saved, completed) for authenticated users'
    - 'Each status transition mutation validates ownership and legal transitions (e.g., only active -> saved, not dismissed -> saved)'
    - 'saveGeneratedActions internal mutation deletes only active-status actions, preserving saved/in_progress/done'
    - 'unsaveAction mutation transitions saved -> active'
  artifacts:
    - path: 'convex/schema.ts'
      provides: 'careerActions table definition'
      contains: 'careerActions'
    - path: 'convex/careerActions/validation.ts'
      provides: 'Zod validation for LLM output'
      exports: ['actionResultSchema', 'actionItemSchema']
    - path: 'convex/careerActions/queries.ts'
      provides: 'Internal and public queries'
      exports:
        [
          'getMyActions',
          'getFullProfile',
          'getExistingActions',
          'getPreservedActions',
        ]
    - path: 'convex/careerActions/mutations.ts'
      provides: 'Status transitions and internal save'
      exports:
        [
          'saveAction',
          'dismissAction',
          'startAction',
          'completeAction',
          'unsaveAction',
          'saveGeneratedActions',
        ]
  key_links:
    - from: 'convex/careerActions/queries.ts'
      to: 'convex/schema.ts'
      via: 'by_profile and by_profile_status indexes'
      pattern: "withIndex\\('by_profile'"
    - from: 'convex/careerActions/mutations.ts'
      to: 'convex/lib/auth.ts'
      via: 'getUserId for ownership verification'
      pattern: "getUserId\\(ctx\\)"
---

<objective>
Create the careerActions data layer: schema table, Zod validation for LLM output, internal + public queries, and status transition mutations.

Purpose: Foundation for the entire career actions feature -- all subsequent plans depend on this schema and data access layer.
Output: Working Convex schema, validation, queries, and mutations that pass `npx convex dev --once` type checking.
</objective>

<execution_context>
@/Users/luca/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luca/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-generation/35-RESEARCH.md
@convex/schema.ts
@convex/matches.ts
@convex/matching/queries.ts
@convex/matching/mutations.ts
@convex/matching/validation.ts
@convex/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add careerActions table to schema + create Zod validation</name>
  <files>convex/schema.ts, convex/careerActions/validation.ts</files>
  <action>
  1. In `convex/schema.ts`, add a `careerActions` table following the matches table pattern. Fields per locked decision #1:
     - `profileId: v.id('profiles')`
     - `type`: union of 8 literals: `replicate`, `collaborate`, `start_org`, `identify_gaps`, `volunteer`, `build_tools`, `teach_write`, `develop_skills`
     - `title: v.string()`
     - `description: v.string()`
     - `rationale: v.string()` — user-facing reasoning referencing profile elements
     - `profileBasis: v.optional(v.array(v.string()))` — machine-readable profile signal identifiers (GEN-07)
     - `status`: union of 5 literals: `active`, `saved`, `dismissed`, `in_progress`, `done`
     - `generatedAt: v.number()`
     - `startedAt: v.optional(v.number())`
     - `completedAt: v.optional(v.number())`
     - `modelVersion: v.string()`
     - `completionConversationStarted: v.optional(v.boolean())` — Phase 36 flag, include now
  - Add indexes: `.index('by_profile', ['profileId'])` and `.index('by_profile_status', ['profileId', 'status'])`

2. Create `convex/careerActions/validation.ts` following `convex/matching/validation.ts` pattern: - Define `actionTypes` as `z.enum([...8 types...])` - Define `actionItemSchema` with `.passthrough()`: type, title, description, rationale, profileBasis (optional array of strings, default []) - Define `actionResultSchema` with `.passthrough()`: `actions` array, min 1, max 7 (accept slightly out of range) - Export both schemas
   </action>
   <verify>Run `npx convex dev --once` from project root — schema should push successfully with no type errors.</verify>
   <done>careerActions table exists in Convex schema with correct fields and indexes. Zod validation schema ready for LLM output parsing.</done>
   </task>

<task type="auto">
  <name>Task 2: Create queries and mutations for career actions</name>
  <files>convex/careerActions/queries.ts, convex/careerActions/mutations.ts</files>
  <action>
  1. Create `convex/careerActions/queries.ts`:

     **Internal queries** (using `internalQuery` from `../_generated/server`):
     - `getFullProfile`: args `{ profileId: v.id('profiles') }`, returns full profile (reuse pattern from `convex/matching/queries.ts` `getFullProfile`)
     - `getExistingActions`: args `{ profileId: v.id('profiles') }`, queries careerActions by `by_profile` index, returns all
     - `getPreservedActions`: args `{ profileId: v.id('profiles') }`, queries by `by_profile` index, filters to `saved`, `in_progress`, `done` status only

     **Public query** (using `query` from `../_generated/server`):
     - `getMyActions`: no args, calls `getUserId(ctx)`, looks up profile by `by_user` index, queries all careerActions for that profile. Returns object with:
       - `active`: actions with status `active`
       - `inProgress`: actions with status `in_progress`
       - `saved`: actions with status `saved`
       - `completed`: actions with status `done` (sorted by `completedAt` desc)
       - `hasProfile: true`
       - Returns `null` if not authenticated
       - Returns `{ active: [], inProgress: [], saved: [], completed: [], hasProfile: false }` if no profile
     - Import `getUserId` from `../lib/auth`

2.  Create `convex/careerActions/mutations.ts`:

         **Internal mutation** (using `internalMutation`):
         - `saveGeneratedActions`: args `{ profileId: v.id('profiles'), actions: v.array(v.object({...action fields...})), modelVersion: v.string() }`.
           - Query existing actions by `by_profile` index
           - Delete ONLY actions with `status === 'active'` (per locked decision #4)
           - Do NOT delete `saved`, `in_progress`, `done`, or `dismissed` actions
           - Insert each new action with `status: 'active'`, `generatedAt: Date.now()`, provided `modelVersion`
           - Log via `log()` from `../lib/logging`

         **Public mutations** (using `mutation`, per locked decision #10):
         Each validates auth via `getUserId(ctx)`, fetches action, verifies profile ownership, checks legal transition:

         - `saveAction`: args `{ actionId: v.id('careerActions') }`. Valid from: `active`. Sets `status: 'saved'`.
         - `dismissAction`: args `{ actionId: v.id('careerActions') }`. Valid from: `active`, `saved`. Sets `status: 'dismissed'`.
         - `startAction`: args `{ actionId: v.id('careerActions') }`. Valid from: `active`, `saved`. Sets `status: 'in_progress'`, `startedAt: Date.now()`.
         - `completeAction`: args `{ actionId: v.id('careerActions') }`. Valid from: `in_progress`. Sets `status: 'done'`, `completedAt: Date.now()` (per locked decision #11, no enrichment chat).
         - `unsaveAction`: args `{ actionId: v.id('careerActions') }`. Valid from: `saved`. Sets `status: 'active'`.

         For ownership verification pattern, follow `convex/matches.ts` `dismissMatch`/`saveMatch`: look up profile via `by_user` index, compare `action.profileId` to `profile._id`.

         Use a helper function `verifyActionOwnership(ctx, actionId)` to reduce duplication across mutations. It should return `{ action, profile }` or throw.

      </action>
      <verify>Run `npx convex dev --once` — all functions should register without type errors. Verify the Convex dashboard shows new functions under `careerActions.queries` and `careerActions.mutations`.</verify>
      <done>Internal queries fetch profile and action data. Public getMyActions returns grouped actions. Five status transition mutations enforce legal transitions with ownership checks. saveGeneratedActions preserves non-active actions during regeneration.</done>
    </task>

</tasks>

<verification>
1. `npx convex dev --once` passes with no type errors
2. Convex dashboard shows `careerActions` table in schema
3. Convex dashboard shows functions: `careerActions.queries.getMyActions`, `careerActions.mutations.saveAction`, `careerActions.mutations.dismissAction`, `careerActions.mutations.startAction`, `careerActions.mutations.completeAction`, `careerActions.mutations.unsaveAction`
4. `bun run lint` passes
</verification>

<success_criteria>

- careerActions table deployed to Convex with 8-type union, 5-status union, all fields from decision #1
- Zod validation schema ready for Plan 02's LLM pipeline
- Public getMyActions query returns structured action groups
- All 5 public mutations enforce ownership and legal status transitions
- saveGeneratedActions preserves saved/in_progress/done actions (critical for ACTN-05)
  </success_criteria>

<output>
After completion, create `.planning/phases/35-generation/35-01-SUMMARY.md`
</output>
