---
phase: 36-completion
plan: 02
type: execute
wave: 2
depends_on: [36-01]
files_modified:
  - src/components/actions/CompletionChoiceDialog.tsx
  - src/components/actions/CompletionEnrichmentDialog.tsx
  - src/components/actions/hooks/useCompletionEnrichment.ts
  - src/components/actions/CareerActionsSection.tsx
autonomous: true

must_haves:
  truths:
    - 'Clicking "Mark Done" on an in-progress action opens CompletionChoiceDialog with two buttons: "Tell us about it" and "Just mark done"'
    - '"Just mark done" calls completeAction mutation and closes dialog — action moves to done status'
    - '"Tell us about it" calls completeAction + markCompletionStarted, then opens CompletionEnrichmentDialog'
    - 'CompletionEnrichmentDialog auto-sends opening message on mount, seeding conversation with action context'
    - 'Completion chat uses sendCompletionMessage action (not sendMessage), messages filtered by actionId'
    - 'Extract button appears after shouldExtract signal, extraction goes through ExtractionReview component'
    - 'After applying profile updates, dialog shows "Refresh Matches" button that calls triggerMatchComputation'
    - 'Completed actions with completionConversationStarted show "Enriched" indicator in CompletedActionsSection'
  artifacts:
    - path: 'src/components/actions/CompletionChoiceDialog.tsx'
      provides: 'Two-path dialog for marking action done'
      exports: ['CompletionChoiceDialog']
    - path: 'src/components/actions/CompletionEnrichmentDialog.tsx'
      provides: 'Enrichment chat + extraction + review + refresh dialog'
      exports: ['CompletionEnrichmentDialog']
    - path: 'src/components/actions/hooks/useCompletionEnrichment.ts'
      provides: 'Hook managing completion chat state, extraction, and profile application'
      exports: ['useCompletionEnrichment']
    - path: 'src/components/actions/CareerActionsSection.tsx'
      provides: 'Updated section wiring completion dialogs instead of direct mutation'
      exports: ['CareerActionsSection']
  key_links:
    - from: 'src/components/actions/hooks/useCompletionEnrichment.ts'
      to: 'convex/enrichment/conversation.ts'
      via: 'sendCompletionMessage action'
      pattern: 'sendCompletionMessage'
    - from: 'src/components/actions/hooks/useCompletionEnrichment.ts'
      to: 'convex/enrichment/queries.ts'
      via: 'getCompletionMessagesPublic query'
      pattern: 'getCompletionMessagesPublic'
    - from: 'src/components/actions/CompletionEnrichmentDialog.tsx'
      to: 'src/components/profile/enrichment/EnrichmentChat.tsx'
      via: 'Reuses EnrichmentChat component for chat UI'
      pattern: 'EnrichmentChat'
    - from: 'src/components/actions/CompletionEnrichmentDialog.tsx'
      to: 'src/components/profile/enrichment/ExtractionReview.tsx'
      via: 'Reuses ExtractionReview component for review UI'
      pattern: 'ExtractionReview'
    - from: 'src/components/actions/CareerActionsSection.tsx'
      to: 'src/components/actions/CompletionChoiceDialog.tsx'
      via: 'Opens dialog when onComplete fires'
      pattern: 'CompletionChoiceDialog'
---

<objective>
Build the completion loop frontend: a two-path dialog when marking actions done, a completion enrichment dialog reusing EnrichmentChat and ExtractionReview, and a post-apply "Refresh Matches" prompt that regenerates both matches and career actions.
</objective>

<requirements>
- COMP-01: Marking action done offers two paths — "Tell us about it" or "Just mark done"
- COMP-02: "Tell us about it" opens enrichment chat seeded with completed action context
- COMP-03: Extraction from completion chat goes through existing review UI for user approval
- COMP-04: After profile update, user is prompted to refresh matches (regenerates both matches + actions)
</requirements>

<steps>

## 1. Create useCompletionEnrichment hook

**File:** `src/components/actions/hooks/useCompletionEnrichment.ts` (NEW)

Custom hook similar to `useEnrichment` but adapted for completion conversations:

**Args:** `{ profileId: Id<'profiles'> | null, actionId: Id<'careerActions'> | null }`

**Key differences from useEnrichment:**

- Uses `api.enrichment.queries.getCompletionMessagesPublic` (filtered by actionId) instead of `getMessagesPublic`
- Uses `api.enrichment.conversation.sendCompletionMessage` instead of `sendMessage`
- Passes `actionId` and optional `actionContext` to each message call
- The `sendMessage` wrapper accepts optional `actionContext` param for the first message

**Returns:** Same interface as useEnrichment plus `actionId`:

```typescript
{
  messages, input, setInput, isLoading, error,
  shouldShowExtract, isExtracting, extractions,
  sendMessage, extractProfile,
  updateExtractionStatus, updateExtractionValue, resetExtractions,
}
```

**Implementation notes:**

- Query subscription: `useQuery(api.enrichment.queries.getCompletionMessagesPublic, actionId && profileId ? { actionId, profileId } : 'skip')`
- The `sendMessage` function wraps `sendCompletionMessage` with `{ profileId, actionId, message, actionContext }`
- `actionContext` is only passed on the first message (when `messages.length === 0`) — on subsequent messages it's omitted since the LLM already has it in the system prompt
- `extractProfile` calls the existing `extractFromConversation` action passing the action-filtered messages (same extraction action, just different message set)

## 2. Create CompletionChoiceDialog

**File:** `src/components/actions/CompletionChoiceDialog.tsx` (NEW)

Simple shadcn Dialog with the two-path choice. Follows the existing project patterns (shadcn, Tailwind, violet accent).

**Props:**

```typescript
interface CompletionChoiceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  actionTitle: string
  onTellUs: () => void
  onJustDone: () => void
  isLoading: boolean // disable buttons while mutation runs
}
```

**Layout:**

```
DialogContent (max-w-md):
  DialogHeader:
    DialogTitle: "Nice work!"
    DialogDescription: "You completed: {actionTitle}"

  Body (flex flex-col gap-3):
    Button (violet, full-width):
      Icon: MessageSquare
      "Tell us about it"
      Sub-text: "Share what you did and update your profile"

    Button (ghost, full-width):
      Icon: CheckCircle2
      "Just mark done"
      Sub-text: "Skip the debrief"
```

**Behavior:**

- "Tell us about it" → calls `onTellUs()`, which: `completeAction()`, `markCompletionStarted()`, then opens enrichment dialog
- "Just mark done" → calls `onJustDone()`, which: `completeAction()` and closes
- Buttons disabled while `isLoading`

## 3. Create CompletionEnrichmentDialog

**File:** `src/components/actions/CompletionEnrichmentDialog.tsx` (NEW)

Larger Dialog containing the full completion enrichment flow: chat → extract → review → apply → refresh.

**Props:**

```typescript
interface CompletionEnrichmentDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  actionId: Id<'careerActions'>
  actionTitle: string
  actionDescription: string
  actionType: string
  profileId: Id<'profiles'>
}
```

**Internal state:**

- `mode: 'chat' | 'review' | 'success'`
- Uses `useCompletionEnrichment({ profileId, actionId })`
- Uses `useMutation(api.profiles.updateField)` for applying extractions
- Uses `useAction(api.matches.triggerMatchComputation)` for refresh

**Mode: 'chat'**

- Renders `EnrichmentChat` component (reused from enrichment system)
- Auto-sends opening message on mount via useEffect:
  ```
  "I just completed this action: {actionTitle}. Here's what it was about: {actionDescription}"
  ```
  This triggers the LLM to respond with a celebratory opening and follow-up questions.
- Shows extract button when `shouldShowExtract` is true (same pattern as EnrichmentStep)
- Extract button calls `extractProfile()` then sets mode to 'review'

**Mode: 'review'**

- Renders `ExtractionReview` component (reused from enrichment system)
- `onBack` → returns to 'chat' mode
- `onApply` → builds profile updates from accepted/edited extractions (same logic as EnrichmentStep handleApply), calls `updateField`, sets mode to 'success'

**Mode: 'success'**

- Shows success card: "Profile updated! Your changes will improve future matches and actions."
- Two buttons:
  - "Refresh Matches" (violet primary) → calls `triggerMatchComputation`, then closes dialog
  - "Done" (ghost) → closes dialog without refreshing

**Auto-greeting implementation:**

```typescript
const hasAutoGreeted = useRef(false)

useEffect(() => {
  if (open && actionId && messages.length === 0 && !isLoading && !hasAutoGreeted.current) {
    hasAutoGreeted.current = true
    sendMessage(
      `I just completed this action: ${actionTitle}. Here's what it was about: ${actionDescription}`,
      { title: actionTitle, description: actionDescription, type: actionType }
    )
  }
}, [open, actionId, messages.length, isLoading, ...])
```

**Dialog sizing:**

- `DialogContent className="max-w-2xl max-h-[80vh] flex flex-col"`
- Chat area takes `flex-1 overflow-hidden` (EnrichmentChat has its own 500px height)
- Review area uses `overflow-y-auto` for scrolling through extraction cards

## 4. Update CareerActionsSection

**File:** `src/components/actions/CareerActionsSection.tsx` (MODIFY)

**Changes:**

### 4a. Add completion dialog state

Add state variables to manage the two dialogs:

```typescript
const [completingAction, setCompletingAction] = useState<ActionType | null>(
  null,
)
const [enrichmentAction, setEnrichmentAction] = useState<ActionType | null>(
  null,
)
const [isCompleting, setIsCompleting] = useState(false)
```

Where `ActionType` is the type of individual actions from `actionsData`.

Also add the profile query to get profileId for the enrichment dialog:

```typescript
const profileId = actionsData?.profileId // Need to expose profileId from getMyActions query
```

**Important:** The `getMyActions` query in `convex/careerActions/queries.ts` needs to also return `profileId` so the frontend has it for the enrichment flow. Currently it returns `{ active, inProgress, saved, completed, hasProfile }`. Add `profileId` to the return object.

### 4b. Replace direct completeAction call with dialog opener

Change line 73-74 from:

```typescript
onComplete={
  action.status === 'in_progress'
    ? () => completeAction({ actionId: action._id })
    : undefined
}
```

To:

```typescript
onComplete={
  action.status === 'in_progress'
    ? () => setCompletingAction(action)
    : undefined
}
```

### 4c. Add handlers for dialog choices

```typescript
const handleJustDone = async () => {
  if (!completingAction) return
  setIsCompleting(true)
  try {
    await completeAction({ actionId: completingAction._id })
    setCompletingAction(null)
  } finally {
    setIsCompleting(false)
  }
}

const handleTellUs = async () => {
  if (!completingAction) return
  setIsCompleting(true)
  try {
    await completeAction({ actionId: completingAction._id })
    await markCompletionStarted({ actionId: completingAction._id })
    setEnrichmentAction(completingAction)
    setCompletingAction(null)
  } finally {
    setIsCompleting(false)
  }
}
```

### 4d. Add mutations

```typescript
const markCompletionStarted = useMutation(
  api.careerActions.mutations.markCompletionStarted,
)
```

### 4e. Render dialogs

Add at the end of the JSX return, inside the `<section>`:

```tsx
{
  /* Completion choice dialog */
}
;<CompletionChoiceDialog
  open={completingAction !== null}
  onOpenChange={(open) => !open && setCompletingAction(null)}
  actionTitle={completingAction?.title ?? ''}
  onTellUs={handleTellUs}
  onJustDone={handleJustDone}
  isLoading={isCompleting}
/>

{
  /* Completion enrichment dialog */
}
{
  enrichmentAction && profileId && (
    <CompletionEnrichmentDialog
      open={enrichmentAction !== null}
      onOpenChange={(open) => !open && setEnrichmentAction(null)}
      actionId={enrichmentAction._id}
      actionTitle={enrichmentAction.title}
      actionDescription={enrichmentAction.description}
      actionType={enrichmentAction.type}
      profileId={profileId}
    />
  )
}
```

### 4f. Update getMyActions query to return profileId

**File:** `convex/careerActions/queries.ts` — Modify the `getMyActions` return to include `profileId`:

In the existing `getMyActions` query handler, the profile is already fetched. Add `profileId: profile._id` to the return object alongside `active`, `inProgress`, `saved`, `completed`, and `hasProfile`.

</steps>

<verification>
After implementation, verify:
1. `bun run lint` passes with no errors
2. Clicking "Mark Done" on an in-progress action opens the choice dialog (not completing immediately)
3. "Just mark done" completes the action and closes dialog (action appears in completed section)
4. "Tell us about it" completes the action, opens enrichment dialog, and auto-sends the greeting message
5. LLM responds with a celebration and follow-up questions (using COMPLETION_COACH_PROMPT)
6. Chat extract button appears after 2-4 exchanges when LLM signals readiness
7. Extraction opens ExtractionReview with accept/reject/edit per field
8. "Apply to Profile" updates profile and shows success state with "Refresh Matches" button
9. "Refresh Matches" calls triggerMatchComputation (check network/logs) and closes dialog
10. No regressions: general enrichment chat on profile page still works unchanged
</verification>
